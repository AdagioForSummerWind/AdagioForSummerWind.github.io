---
title: "Lesson_09"
date: 2022-05-16T11:22:22+08:00
lastmod:
tags: []
categories: []
slug:
draft: true
---
- [一、什么是架构](#一什么是架构)
  - [问题提出！](#问题提出)
  - [单体架构](#单体架构)
  - [单体架构](#单体架构-1)
  - [垂直切分](#垂直切分)
  - [SOA（面向服务架构）](#soa面向服务架构)
  - [微服务](#微服务)
  - [小结](#小结)
- [二、企业级后端架构剖析](#二企业级后端架构剖析)
  - [云计算](#云计算)
  - [云原生](#云原生)
    - [弹性资源](#弹性资源)
      - [**弹性资源类型：**](#弹性资源类型)
      - [**弹性资源存储类型**](#弹性资源存储类型)
    - [Devops：](#devops)
    - [微服务架构](#微服务架构)
    - [服务网格：](#服务网格)
- [三、企业级后端架构的挑战](#三企业级后端架构的挑战)
  - [离、在线资源并池](#离在线资源并池)
  - [自动扩缩容](#自动扩缩容)
    - [微服务亲合性部署](#微服务亲合性部署)
    - [流量治理](#流量治理)
    - [CPU水位负载均衡](#cpu水位负载均衡)
  - [自适应静态权重](#自适应静态权重)
  - [自适应动态权重Alpha](#自适应动态权重alpha)
  - [自适应动态权重Beta](#自适应动态权重beta)
  - [自适应动态权重Release](#自适应动态权重release)
- [总结](#总结)

### 一、什么是架构

架构抽象定义：

- 是有关软件整体结构与组件的抽象描述

- 用于指导软件系统各个方面的设计

听不懂啊！！！

简单来说就是架构在实现软件方法选择上有指导作用！

![image-20220522150111230](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a6e5666d3c44008bb75a5259cb0b513~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

架构如果没打好，大厦容易倒！

#### 问题提出！

蛋糕坊要开业了！需要解决以下的问题：

1. 咋做蛋糕？（先亲自做把！）
2. 如何卖蛋糕？（客流量不大，边做边卖先！）

#### 单体架构

All in one，所有的东西都在一个进程里，部署在一个机器上。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/51b26d20381940b5b2ef2bffba077e07~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

优点：

- 简单

缺点：

- 运维需要停服，用户体验较差（兰师傅拉屎去了，没人做了）

- 承载能力有限，会产生c10k问题。（人太多了，兰师傅忙不过来了）

C10K问题可以具体看一下下面这个文章

[C10k问题简述_爱思考的实践者的博客-CSDN博客_c10k问题](https://link.juejin.cn/?target=https%3A%2F%2Fblog.csdn.net%2Fchinawangfei%2Farticle%2Fdetails%2F102780959 "https://blog.csdn.net/chinawangfei/article/details/102780959")

简单来说就是，C10K问题，本质上是操作系统的问题。对于Web1.0/2.0时代的操作系统而言， 传统的同步阻塞I/O模型都是一样的，处理的方式都是requests per second，并发10K和100的区别关键在于CPU。

创建的进程、线程多了，数据拷贝频繁（缓存I/O、内核将数据拷贝到用户进程空间、阻塞）， 进程/线程上下文切换消耗大， 导致操作系统崩溃，这就是C10K问题的本质！

可见，解决C10K问题的关键就是：尽可能减少CPU等核心资源消耗，从而榨干单台服务器的性能，突破C10K问题所描述的瓶颈。

#### 单体架构

![image-20220522151446813](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4219f3b1de1d46349033cc930a3b50bb~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

在单机架构的基础上，将进程部署到多个机器上。

优点：

- 具备水平扩容能力

- 运维不需要停服

缺点：

- 后端进程职责太多，越来越臃肿（啥都得负责啊！只是简单的多部署了几台机器而已，这师傅啥蛋糕都得做，还得自己负责烤，和面等等任务）

- 爆炸半径较大，进程中一个很小的模块出现问题，都可能导致整个进程崩溃！（孙师傅做蛋糕的时候烤箱坏了，他这人就芭比q了，后续没法做了）

#### 垂直切分

在单机架构基础上，将进程按照某种依据切分开。比如，A 软件和 B 软件的后端原先采用单机架构部署，那就是一个进程部署在多个机器上；如果用垂直应用架构，可以将 A 和 B 的后端拆分为 A、B 两个进程，然后再按照单体模式的思路，部署在多个机器上。

![image-20220522151756888](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1556a16ef5b045a1b7f7fba9be89eab4~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

优点：

- 一定程度上减少了后端进程职责（各司其职了）

- 一定程度上缩小爆炸半径（原来师傅做肉松蛋糕的师傅如果肉松没了，他就没了。现在只有肉松师傅没了）

缺点：

- 没有根本解决单体架构的问题（解决了，但是又没解决！！）

#### SOA（面向服务架构）

SOA 架构中，服务为一等公民，将进程按照不同的功能单元进行抽象，拆分为『服务』。有了服务之后，SOA 还为服务之间的通信定义了标准，保证各个服务之间通讯体验的一致性。

![image-20220522152258225](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23005610962645ee896b8eec9ac92ad5~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

优点：

- 各服务的职责更清晰（各司其职）

- 运维粒度减小到服务，爆炸半径可控（出问题基本只影响自己那部分）

缺点：

- ESB (企业服务总线) 往往需要一整套解决方案（像是各个师傅之间如何进行通信，需要有一套现成的标准）

[ESB----企业服务总线](https://link.juejin.cn/?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.definesys.com%2F "https://link.zhihu.com/?target=https%3A//www.definesys.com/")，像一根管道，用来连接各个节点。为了集成不同系统，不同协议的服务，ESB做了消息的转换、解释与路由等工作，让不同的服务互联互通。

![preview](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb04cb7017264e9d81868ccc232ef6f9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

大家可以根据这篇文章[什么是ESB？ - 知乎 (zhihu.com)](https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F399060480 "https://zhuanlan.zhihu.com/p/399060480")，来简单了解esb，我理解就是蛋糕店的老大，负责与各个蛋糕师傅沟通，传话等等一系列任务。

#### 微服务

在 SOA 架构中，ESB 起到了至关重要的作用。但从架构拓扑来看，它更像是一个集中式的模块。有一个 SOA 分布式演进的分支，最终的形态便是微服务。

![image-20220522153023509](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b99676208d1243bd8077bf5aae10ea83~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

优点：

- 兼具 SOA 解决的问题

- 服务间的通信更敏捷、灵活

缺点：

- 运维成本

但是这种方式又会产生新的问题：

- 数据一致性：装货台一共交付了多少蛋糕？
- 高可用： 烤箱坏了怎么办？
- 治理：这么多师傅怎么合作啊！
- 解耦vs过微：师傅太多了，值当么？

#### 小结

- 架构演进的初衷：满足软件迭代诉求，提高迭代效率

- 架构演进的思路：垂直切分——分布式，水平切分——分层/模块化

### 二、企业级后端架构剖析

蛋糕店经过发展，需要扩大规模，产生了以下问题：

店面咋盘：

- 买
- 租

师傅怎么招聘：

- 任用自家亲属
- 招培训班的人

还有一系列问题

#### 云计算

云计算基础：云计算是指软件通过自动化管理，提供计算资源的服务网络，是现代互联网大规模熟悉分析和存储的基石。

- 虚拟化技术
    
    - 硬件层面（VM 虚拟机）- KVM/Xen/VMware
    - 操作系统层面（Container 容器）- LCX/Docker/Kata Container
    - 网络层面 - Linux Bridge/Open v Switch

- 编排方案
    
    - VM - OpenStack/VMWare Workstation
    - Container - Kubernetes/Docker Swarm

![image-20220522154612780](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dab26e435d284833a343d341757db16a~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

云计算架构：

- 云服务
    
    - IaaS - 云基础设施，对底层硬件资源池的抽象（基础设施是自己来买还是找人租？对应房屋租赁平台）
    - PaaS - 基于资源池抽象，对上层提供的弹性资源平台（装修的话是自己来还是找装修公司？）
    - SaaS - 基于弹性资源平台构建的云服务（师傅是自己培养还是直接找培训班的？）
    - FaaS - 更轻量级的函数服务。好比 LeetCode 等 OJ，刷题时只需要实现函数，不需要关注输入输出流。（直接用机器做蛋糕还是自己手工做？）

- 云部署模式（拓展）
    
    - 私有云 - 企业自用
    - 公有云 - AWS/Azure/Google Cloud/Huawei
    - 混合云

#### 云原生

云原生，实际是云原生（计算）的简称，它是元计算发展到现在的一种形态。

云原生技术为组织（公司）在公有云、自由云、混合云等新型的动态环境中，构建和运行可弹性拓展的应用提供了可能。 它的代表技术：

- 弹性资源

- 微服务架构

- DevOps

- 服务网格

![image-20220522155108936](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/68eab23e265d481fa717a4df66daa879~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

##### 弹性资源

基于虚拟化技术，提供的可以快速扩缩容的能力。可以分为弹性计算资源和弹性存储资源两个方面。 弹性计算资源：

- 计算资源调度
    
    - 在线计算 - 互联网后端服务
    - 离线计算 - 大数据分析。Map-Reduce/Spark/Flinnk

- 消息队列
    
    - 在线队列 - 削峰、解耦
    - 离线队列 - 结合数据分析的一整套方案，如 ELK

###### **弹性资源类型：**

服务资源调度：

- 微服务：和面、雕花
- 大服务：烤箱

计算服务调度：

- 在线：热销榜单
- 离线：热销榜单更新

消息队列：

- 在线：削峰、填谷
- 离线：大数据分析

###### **弹性资源存储类型**

- 经典存储
    
    - 对象存储 - 视频、图片等。结合 CDN 等技术，可以为应用提供丰富的多媒体能力
    - 大数据存储 - 应用日志、用户数据等。结合数据挖掘、机器学习等技术，提高应用的体验

- 关系型数据库

- 元数据
    
    - 服务发现

- NoSQL
    
    - KV 存储 - Redis
    - 文档存储 - Mongo

##### Devops：

云原生软件交付利器，贯穿整个开发周期。

结合自动化流程，提高软件开发以及交付的效率。

![image-20220522160515632](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aec7b79d4cfd4492b5fbd2efe86688ac~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

##### 微服务架构

微服务架构下，服务之间的通讯标准是基于协议而不是 ESB 的。

- HTTP - H1/H2

- RPC - Apache Thrift/gRPC

如何在 HTTP 和 RPC 之间选择？

- 性能 - RPC 协议往往具备较好的压缩率，性能较高。如 Thrift, Protocol Buffers

- 服务治理 - RPC 中间件往往集成了丰富的服务治理能力。如 熔断、降级、超时等

- 可解释性 - HTTP 通信的协议往往首选 JSON，可解释性、可调试性更好

![image-20220522160630273](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0170e34e4854dde935cfc209ec7cf06~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

##### 服务网格：

![image-20220522160811147](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53bb5bd81fc1493da5d815a1d7282814~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

什么是服务网格？

- 微服务之间通讯的中间层

- 一个高性能的 4 层网络代理

- 将流量层面的逻辑与业务进程解耦

对于服务网格，可以根据这篇文章进行简单理解

[服务网格是什么“格”？ - 知乎 (zhihu.com)](https://link.juejin.cn/?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F413044096 "https://zhuanlan.zhihu.com/p/413044096")

没有什么是加一层代理解决不了的问题，服务网格相比较于 RPC/HTTP 框架：

- 实现了异构系统治理体验的统一化

- 服务网格的数据平面代理与业务进程采取进程间通信的模式，使得流量相关的逻辑（包含治理）与业务进程解耦，生命周期也更容易管理

最终蛋糕店的架构如下：

![image-20220522161339018](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2232bac501de43dd968ba2fb7321e2d6~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

### 三、企业级后端架构的挑战

基础设施层面： Q：我们总说，云是弹性的，也就是说，在用户的角度，云提供的资源是无限的。然而，云背后的物理资源是有限的。在企业级后端架构里，云如何解决近乎无限的弹性资源和有限的物理资源之间的矛盾？

Q：闲事的资源就这么空着呢？如何提高资源利用率，提高物理资源的价值转换率？

用户层面： Q：上了云原生微服务后，服务之间的通信开销较大，应该如何做成本优化？

Q：微服务看起来没有那么美好，抖动导致的运维成本较高，如何解决？

Q：异构的物理环境应该对用户是透明的，如何屏蔽这些细节？

#### 离、在线资源并池

同一台机器上跑着离线和在线的服务，机器如何为这些服务分配资源呢？

考虑到在线业务的**潮汐性**，物理资源的用量不是一成不变的。离在线资源并池，可以：

- 提高物理资源利用率

- 提供更多的弹性资源

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f067b27d6b34c069a5d1de0dd20d87d~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

#### 自动扩缩容

核心收益：

- 降低业务成本

解决思路：

自动扩缩容

- 利用潮汐性自动扩缩容

![image-20220522162513261](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27300e572b544a5e8c27ab07eefaec38~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

可以根据cpu使用率、进程线程的情况、内存使用情况等指标进行动态扩缩容。

##### 微服务亲合性部署

微服务之间的通信成本较高，是否可以：

- 形态上是微服务架构

- 通信上是单体架构

亲合性部署，通过将微服务调用形态与资源调度系统结合，将一些调用关系紧密、通信量大的服务部署在同一个机器上，并且使用 IPC 代替 RPC 的方式，降低网络通信带来的开销

![image-20220522162810614](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ae24f2995fc41a3b206819e258000de~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image)

- 将满足亲和性条件的容器调度到一台宿主机
- 问服务中间件与服务网格通过共享内存通信
- 服务网格控制面实施灵活、动态的流量调度

##### 流量治理

核心收益：

- 提高微服务调用容错性
- 容灾
- 提高开发效率，devops发挥到极致

解决思路：基于微服务中间件及服务网格的流量治理

- 熔断，重试
- 单元化
- 复杂环境流量调度

##### CPU水位负载均衡

同样的服务部署到不同的主机上，打同样的流量，但由于cpu处理能力的差异，导致cpu资源利用率不均衡。

核心收益

- 打平异构环境算力差异
- 自动扩缩容提供正向输入

解决思路：CPU水位负载均衡

- Iaas：提供资源探针
- 服务网格：动态负载均衡

> **4\. 后端结构实战**

**问题描述：**

类比一个蛋糕店来说，不同的师傅他干活的效率实际上还是差距蛮大的。就有些师傅他手脚比较麻利，干活很快，有些可能比较追求极致，所以相对来说干的活比较精细，但是速度没有那么快。对于一种场景，有些师傅他就希望说我干的活比较多，我想多挣点钱。然后那些干的少的同那个师傅可能也觉得我就想少干一点，因为我的身体吃不消，所以说这就是两个非常核心的问题。那在这个背景之下，然后我们如果还按照之前的方式说，你每个师傅都要干相同的工作，那这个他们可能会不满，有些的能力比较强的，她就想多挣钱，她觉得你给我的工作太少了，我太闲了。然后那些能力相对来说干活比较慢的，他就会觉得我太累了，而且工作还做不完，会影响整个的一个效率。**所以我们可以带着第三部分的CPU水位负载均衡来看这个问题。**

**问题提炼：**

**输入:**

- 服务网格数据面
    - 支持带权重的负载均衡策略
- 注册中心存储了所有容器的权重信息
- 宿主机能提供
    - 容器的资源使用情况
    - 物理资源信息(如CPU型号)

**关键点：**

- 紧急回滚能力
- 大规模
- 极端场景
#### 自适应静态权重

**方案：**

- 采集宿主机物理资源信息
- 调整容器注册的权重

**优势：**

- 复杂度低
- 完全分布式，可用性高
- 微服务中间件无适配成本 **缺点：**
- 无紧急回滚能力
- 缺乏运行时自适应能力

#### 自适应动态权重Alpha

**方案：**

- 容器动态权重的自适应调整
- 服务网格的服务发现&流量调度能力

**演进方向：**

- 容器动态权重的自适应调整
- 服务网格的服务发现&流量调度能力

**缺点：**

- 过度流量倾斜可能会有异常情况

#### 自适应动态权重Beta

**方案：**

- 服务网格上报RPC指标

**演进方向：**

- 极端场景的处理成为可能

**缺点：**

- 时序数据库压力较大
- 动态权重决策中心职责越来越多，迭代->变更->风险

#### 自适应动态权重Release

**演进方向：**

- 微服务化
- 引入消息队列削峰、解耦
- 离在线链路切分
- 梳理强弱依赖

### 总结

1. 没有最好的架构，只有最合适的架构
2. 如何做架构设计？
    - 需求先行。弄清楚需要解决的问题是什么！
    - 业界调研。业界都有哪些成熟的解决方案可供参考。
    - 技术选型。内部/社区都有哪些基础组件
    - 异常情况。考虑清楚xxx不行了怎么办

