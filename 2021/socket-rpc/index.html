<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>DistributedSystem_HongweiDu_06 | Jefo</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noodp" />
<meta name="Description" content="Qizheng的个人博客"><link rel="prev" href="https://qizhengzou.github.io/2021/mutual-exclusion-election-algorithms/" /><link rel="next" href="https://qizhengzou.github.io/2021/internetworking/" /><link rel="canonical" href="https://qizhengzou.github.io/2021/socket-rpc/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DistributedSystem_HongweiDu_06"/>
<meta name="twitter:description" content="Socket Communication套接字通信（直接通信) Clients and Servers： A distributed system can be generally modeled by clients and servers (processes). Clients and servers are usually on different machines and they interact with each other via message passing. To offer a service, a server"/>
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "DistributedSystem_HongweiDu_06",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/qizhengzou.github.io\/2021\/socket-rpc\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/qizhengzou.github.io\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "distributed_system","wordcount":  1904 ,
        "url": "https:\/\/qizhengzou.github.io\/2021\/socket-rpc\/","datePublished": "2021-12-03T14:35:58\u002b08:00","dateModified": "2021-12-22T00:00:00\u002b00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "qizheng",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/qizhengzou.github.io\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"description": ""
    }
    </script><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/lib/fontawesome-free/all.min.css"></head>
    <body><script>
            window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><nav class="navbar">
    
        <div class="top-scroll-bar"></div>
    
    <div class="navbar-container">
        <div class="navbar-header animated bounceIn">
            <a href="https://qizhengzou.github.io">Jefo</a>
        </div>
        <div class="navbar-menu"><a class="menu-item" href="https://qizhengzou.github.io/posts" title="">Posts</a><a class="menu-item" href="https://qizhengzou.github.io/tags" title="">Tags</a><a class="menu-item" href="https://qizhengzou.github.io/categories" title="">Categories</a><a class="menu-item" href="https://qizhengzou.github.io/about" title="">About</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><nav class="navbar-mobile">
    
        <div class="top-scroll-bar"></div>
    
    <div class="navbar-container">
        <div class="navbar-header">
            <div class="navbar-header-title animated bounceIn">
                <a href="https://qizhengzou.github.io">Jefo</a>
            </div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="navbar-menu" id="mobile-menu"><a class="menu-item" href="https://qizhengzou.github.io/posts" title="">Posts</a><a class="menu-item" href="https://qizhengzou.github.io/tags" title="">Tags</a><a class="menu-item" href="https://qizhengzou.github.io/categories" title="">Categories</a><a class="menu-item" href="https://qizhengzou.github.io/about" title="">About</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><main class="main">
                <div class="container"><article class="page"><h1 class="post-title animated flipInX">DistributedSystem_HongweiDu_06</h1><div class="post-meta"><i class="far fa-calendar-alt fa-fw"></i>published on&nbsp;<time datetime=2021-12-03>2021-12-03</time>&nbsp;
            <i class="fas fa-pencil-alt fa-fw"></i>about 1904 words&nbsp;<span class="post-category"><i class="far fa-folder fa-fw"></i>included in&nbsp;<a href="https://qizhengzou.github.io/categories/school-courses/">School courses</a>&nbsp;</span></div><div class="post-toc" id="post-toc">
                <h2 class="post-toc-title">Contents</h2>
                <div class="post-toc-content"><nav id="TableOfContents">
  <ul>
    <li><a href="#socket-communication套接字通信直接通信">Socket Communication套接字通信（直接通信)</a></li>
    <li><a href="#rpc远程过程调用">RPC远程过程调用</a>
      <ul>
        <li><a href="#steps-in-s-rpc">Steps in s RPC</a></li>
        <li><a href="#writing-the-programs">Writing the programs</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div>
            <div class="post-toc-mobile" id="post-toc-mobile">
                <details>
                    <summary>
                        <div class="post-toc-title">
                            <span>Contents</span>
                            <span><i class="details icon fas fa-angle-down"></i></span>
                        </div>
                    </summary>
                    <div class="post-toc-content"><nav id="TableOfContentsMobile">
  <ul>
    <li><a href="#socket-communication套接字通信直接通信">Socket Communication套接字通信（直接通信)</a></li>
    <li><a href="#rpc远程过程调用">RPC远程过程调用</a>
      <ul>
        <li><a href="#steps-in-s-rpc">Steps in s RPC</a></li>
        <li><a href="#writing-the-programs">Writing the programs</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
                </details>
            </div><div class="post-content"><a class="post-dummy-target" id="socket-communication套接字通信直接通信"></a><h2>Socket Communication套接字通信（直接通信)</h2>
<p>Clients and Servers：</p>
<ul>
<li>A distributed system can be generally modeled by clients and servers (processes).</li>
<li>Clients and servers are usually on different machines and they interact with each other via message passing.</li>
<li>To offer a service, a server must get a transport address for a particular service
<ul>
<li>well-defined location</li>
</ul>
</li>
</ul>
<p>Transport Address:</p>
<ul>
<li>A server (process) is associated with a transport address so that clients can communicate with it.
<ul>
<li>IP addresses identify machines
<ul>
<li>Not able to identify sending or receiving process</li>
</ul>
</li>
<li>Transport layer uses port number to identify process
<ul>
<li>machine address (IP address)  -&gt;   building address</li>
<li>transport address (port number) -&gt;   apartment number</li>
</ul>
</li>
</ul>
</li>
<li>A client obtains the transport address via either:
<ul>
<li>hard coded</li>
<li>database (/etc/services, directory server)</li>
</ul>
</li>
</ul>
<p>Transport Layer Protocols:</p>
<ul>
<li>Transport Layer supports communications between processes.</li>
<li>Two categories of protocols:
<ul>
<li>connection-oriented protocols</li>
<li>connectionless protocols</li>
</ul>
</li>
</ul>
<p>Connection-oriented Protocols:</p>
<ol>
<li>establish connection</li>
<li>[negotiate protocol]</li>
<li>exchange data</li>
<li>terminate connection</li>
</ol>
<ul>
<li>virtual circuit (stream) service
<ul>
<li>provides illusion of having a dedicated circuit</li>
<li>messages guaranteed to arrive in-order</li>
<li>applications use connection ID, instead of address in each message</li>
<li>e.g., TCP – Transport Control Protocol</li>
</ul>
</li>
</ul>
<p>Connectionless Protocols:</p>
<ol>
<li>no call setup</li>
<li>send/receive data
(each packet addressed)</li>
<li>no termination</li>
</ol>
<ul>
<li>Datagram service
<ul>
<li>client is not sure if messages are received by destination</li>
<li>no state has to be maintained at client or server</li>
<li>cheaper but less reliable than virtual circuit service</li>
<li>e.g., UDP – User Datagram Protocol</li>
</ul>
</li>
</ul>
<p>Sockets: Transport Layer Communication:</p>
<ul>
<li>A popular abstraction for transport layer communication
<ul>
<li>Developed at Berkeley in 1982</li>
</ul>
</li>
<li>Goals:
<ul>
<li>Communication between processes should not depend on whether they are on the same machine
<ul>
<li>Uniform all data exchanges (accesses) as file accesses</li>
</ul>
</li>
<li>Application can select particular style of communication
<ul>
<li>Virtual circuit, datagram, message-based, in-order delivery</li>
</ul>
</li>
<li>Support different protocols and naming conventions (not just for TCP/IP or UDP/IP)</li>
</ul>
</li>
</ul>
<p>Programming operations:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222084547.png" alt="" class="lazyload"></figure></p>
<p>Socket Operations:</p>
<ul>
<li>List of socket operations:</li>
</ul>
<ol>
<li>socket</li>
<li>bind</li>
<li>listen, accept, connect</li>
<li>read/write, send/recv, sendto/recvfrom, sendmsg/recvmsg</li>
<li>close/shutdown</li>
</ol>
<p>Creat a socket:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    socket system call:
			int s = socket(domain, type, protocol);
	parameters:
	domain: identifies address family 
			AF_INET: IPC on the Internet,
			AF_UNIX: IPC within a computer 
			AF_NS: IPC on Xeroxs Network Systems
	type: 	type of service required by application
			SOCK_STREAM: virtual circuit
			SOCK_DGRAM:	datagram
			SOCK_RAW:	raw IP access
	protocol: 	specify a protocol. To support user self defined protocols.
			Default value is 0, i.e., system defined protocol.	
return: an integer as the socket number (file descriptor)
</code></pre></td></tr></table>
</div>
</div><p>Bind socket to an address:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">    bind system call:
			int error = bind(s, addr, addrlen);
	parameters:
	s: 	socket descriptor returned by socket()
	addr: 	address structure (struct sockaddr *)
	addrlen:	length of address structure

	return: error code
</code></pre></td></tr></table>
</div>
</div><p>Binding a file name to a UNIX socket(intra-machine communication):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">un</span><span class="p">.</span><span class="n">h</span>
<span class="k">struct</span>  <span class="n">sockaddr_un</span> <span class="p">{</span>
        <span class="n">sa_family_t</span>	  <span class="n">sun_family</span><span class="p">;</span>             <span class="cm">/* AF_UNIX */</span>
        <span class="kt">char</span>                <span class="n">sun_path</span><span class="p">[</span><span class="mi">108</span><span class="p">];</span>       <span class="cm">/* path name */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="err">“</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">foo</span><span class="err">”</span><span class="p">);</span>
<span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
<span class="n">bind</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Demo of UNIX Stream Sockets:</p>
<ul>
<li>www/C/socket/unix/receiver.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[];</span> <span class="p">{</span>
   <span class="k">struct</span>  <span class="n">sockaddr_un</span> <span class="n">myname</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_s</span><span class="p">;</span>
   <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">rdata</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
   <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
   <span class="n">myname</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
   <span class="n">strcpy</span><span class="p">(</span><span class="n">myname</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">&#34;/tmp/123&#34;</span><span class="p">);</span>
   <span class="n">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myname</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">myname</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> 
	<span class="k">sizeof</span><span class="p">(</span><span class="n">myname</span><span class="p">.</span><span class="n">sun_family</span><span class="p">))</span> 
   <span class="n">listen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
   <span class="n">new_s</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">read</span><span class="p">(</span><span class="n">new_s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
       <span class="n">strcpy</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="err">“</span><span class="n">Echoed</span> <span class="nl">msg</span><span class="p">:</span> <span class="s">&#34;);  </span>
       <span class="n">strcat</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">write</span><span class="p">(</span><span class="n">new_s</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">rdata</span><span class="p">))</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>www/C/socket/unix/sender.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[];</span> <span class="p">{</span>
    <span class="k">struct</span>  <span class="n">sockaddr_un</span> <span class="n">hisname</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">hisname</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">hisname</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">&#34;/tmp/123&#34;</span><span class="p">);</span>
    
    <span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hisname</span><span class="p">,</span> <span class="n">trlen</span><span class="p">(</span><span class="n">hisname</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span><span class="o">+</span> 
	                          <span class="k">sizeof</span> <span class="p">(</span><span class="n">hisname</span><span class="p">.</span><span class="n">sun_family</span><span class="p">));</span>
     <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span> 
     <span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	    <span class="n">read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
	    <span class="n">printf</span> <span class="p">(</span><span class="s">&#34;Received reply: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	    <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
       <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Binding an Internet address to a socket(Internet communication)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">netinet</span><span class="o">/</span><span class="n">in</span><span class="p">.</span><span class="n">h</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span>    <span class="p">{</span>
       <span class="kt">short</span>	  <span class="n">sin_family</span><span class="p">;</span>
       <span class="n">u_short</span>	  <span class="n">sin_port</span><span class="p">;</span>
       <span class="k">struct</span> <span class="n">in_addr</span>  <span class="n">sin_addr</span><span class="p">;</span>
       <span class="kt">char</span>	      	  <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">sockaddr_in</span>      <span class="n">addr</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ip_addr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">144</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">114</span><span class="p">};</span>
<span class="n">addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
<span class="n">addr</span><span class="p">.</span><span class="n">sin_port</span>   <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
<span class="n">bcopy</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="o">&amp;</span> <span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="n">bind</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div><p>Server: set socket for listening:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">listen</span> <span class="n">system</span> <span class="nl">call</span><span class="p">:</span>
			<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
	<span class="nl">parameters</span><span class="p">:</span>
	<span class="nl">s</span><span class="p">:</span> 	<span class="n">socket</span> <span class="n">descriptor</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">socket</span><span class="p">()</span>
	<span class="nl">backlog</span><span class="p">:</span> 	<span class="n">queue</span> <span class="n">length</span> <span class="k">for</span> <span class="n">pending</span> <span class="n">connections</span>
	
	<span class="k">return</span><span class="o">:</span> <span class="n">error</span> <span class="n">code</span>
</code></pre></td></tr></table>
</div>
</div><p>Server: accept connections:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">accept</span> <span class="n">system</span> <span class="nl">call</span><span class="p">:</span>
			<span class="kt">int</span> <span class="n">snew</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">clntaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
	<span class="nl">parameters</span><span class="p">:</span>
	<span class="nl">s</span><span class="p">:</span> 	<span class="n">socket</span> <span class="n">descriptor</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">socket</span><span class="p">()</span>
	<span class="nl">clntaddr</span><span class="p">:</span>  <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="n">contain</span> <span class="n">returned</span> <span class="n">client</span> <span class="n">addr</span>
	<span class="nl">addrlen</span><span class="p">:</span> 	<span class="kt">int</span> <span class="o">*</span> <span class="n">contain</span> <span class="n">length</span> <span class="n">of</span> <span class="n">client</span> <span class="n">addr</span>

	<span class="k">return</span><span class="o">:</span> <span class="n">a</span> <span class="n">new</span> <span class="n">socket</span> <span class="n">to</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">this</span> <span class="n">communication</span> <span class="n">session</span>
</code></pre></td></tr></table>
</div>
</div><p>Client: connect:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">    <span class="n">connect</span> <span class="n">system</span> <span class="nl">call</span><span class="p">:</span>
			<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">svraddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
	<span class="nl">parameters</span><span class="p">:</span>
	<span class="nl">s</span><span class="p">:</span> 	<span class="n">socket</span> <span class="n">descriptor</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">socket</span><span class="p">()</span>
	<span class="nl">svraddr</span><span class="p">:</span> 	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="n">contains</span> <span class="n">server</span> <span class="n">address</span>
	<span class="nl">addrlen</span><span class="p">:</span> 	<span class="n">length</span> <span class="n">of</span> <span class="n">server</span> <span class="n">address</span>

	<span class="k">return</span><span class="o">:</span> <span class="n">error</span> <span class="n">code</span>
</code></pre></td></tr></table>
</div>
</div><p>Exchange data and close sockets:</p>
<ul>
<li>Exchanging data via sockets is the same as file access:
<ul>
<li>read(s, buf, length);</li>
<li>write(s, buf, length);</li>
</ul>
</li>
<li>Close a socket by:
<ul>
<li>close(s); or</li>
<li>shutdown(int s, int how);</li>
<li>s: 	socket</li>
<li>how: 	0: further receives disallowed
<ul>
<li>1: further sends disallowed</li>
<li>2: further sends and receives disallowed</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Client-Server Synchronization:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090117.png" alt="" class="lazyload"></figure></p>
<p>Demo of Internet Sockets:</p>
<ul>
<li>www/C/socket/inet/receiver.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">new_s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server</span><span class="p">;</span>
	
	<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">server</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
	<span class="n">server</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>	
	<span class="n">bind</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">server</span><span class="p">));</span>
	<span class="n">listen</span><span class="p">(</span> <span class="n">s</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">tmp_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">remote_addr</span><span class="p">);</span>
           <span class="n">new_s</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_len</span><span class="p">);</span>
           <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">new_s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write</span><span class="p">(</span><span class="n">new_s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                  <span class="n">putchar</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>www/C/socket/inet/sender.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">remote_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">remote_ent</span><span class="p">;</span> <span class="c1">// def in netdb.h
</span><span class="c1"></span>	<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>
	<span class="n">remote_ent</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">bcopy</span><span class="p">(</span><span class="n">remote_ent</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            	<span class="o">&amp;</span><span class="n">remote_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> 
		<span class="n">remote_ent</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
	<span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">remote_addr</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span><span class="o">=</span><span class="n">getchar</span><span class="p">())</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="p">.</span><span class="err">’</span><span class="p">)</span> <span class="p">{</span>
	         <span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">read</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">putchar</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
      <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Data Structure for Socket Operations:</p>
<ul>
<li>Client only sends data to {machine, port}</li>
<li>How to keep track of simultaneous sessions to the same server process (e.g., HTTP server)?</li>
<li>OS maintains a structure called the Protocol Control Block (PCB) 协议控制模块</li>
</ul>
<p>Protocol Control Block:</p>
<ul>
<li>Each entry of PCB contains:
<ul>
<li>Local address</li>
<li>Local port</li>
<li>Foreign address</li>
<li>Foreign port</li>
<li>Is the socket used for listening?</li>
<li>Reference to the socket (file descriptor)</li>
</ul>
</li>
</ul>
<p>socket(): Allocate a new empty entry in PCB table:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090357.png" alt="" class="lazyload"></figure></p>
<p>bind(): Assign local address, port:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090430.png" alt="" class="lazyload"></figure></p>
<p>listen(): Set socket for receiving connections:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090451.png" alt="" class="lazyload"></figure></p>
<p>connect(): Send a connect request to server:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090519.png" alt="" class="lazyload"></figure></p>
<p>accept(): Send an acknowledgement to client:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090546.png" alt="" class="lazyload"></figure></p>
<p>Message Exchanges via Sockets:</p>
<ul>
<li>Each message from client is tagged as either data or control mesg (e.g. connect).</li>
<li>If data – search through table where foreign addr and foreign port match incoming message and listen is not set.</li>
<li>If control – search through table where the local port matches the dest port in the message and listen is set.</li>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222090627.png" alt="" class="lazyload"></figure></li>
</ul>
<p>Datagram Sockets:</p>
<ul>
<li>Create sockets, bind addresses, close sockets are the same as stream sockets, but no listen, accept and connect operations.</li>
<li>Data exchange via:
<ul>
<li>sendto/recvfrom
<ul>
<li>int sendto(int s, void *msg, int len, int flags, struct sockaddr *to, int tolen)</li>
<li>int recvfrom(int s, void *buf, int len, int flags, struct sockaddr *from, int *fromlen)
<ul>
<li>flags is usually set to 0. It’s for out-of-band data if it’s non-zero.</li>
</ul>
</li>
</ul>
</li>
<li>sendmsg/recvmsg
<ul>
<li>int sendmsg(int s, struct msghdr *msg, int flags)</li>
<li>int recvmsg(int s, struct msghdr *msg, int flags)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Demo of Datagram sockets:</p>
<ul>
<li>www/C/socket/inet/recvfrom.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">name</span><span class="p">;</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">name</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
  <span class="n">name</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>	
  <span class="n">bind</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">name</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">recvfrom</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
		<span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len_from</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="s">&#34;echoed string: &#34;</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sendto</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">rdata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rdata</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
		<span class="o">&amp;</span><span class="n">from</span><span class="p">,</span> <span class="n">from_len</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>www/C/socket/inet/sendto.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">recv</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span> <span class="p">[</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="n">bcopy</span> <span class="p">(</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
		<span class="o">&amp;</span><span class="n">recv</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_length</span><span class="p">);</span>
	<span class="n">recv</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">12000</span><span class="p">);</span>  
	<span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">sendto</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
		<span class="o">&amp;</span><span class="n">recv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">recv</span><span class="p">));</span>
	   <span class="n">recvfrom</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
	  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Received Reply: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
  	  <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="rpc远程过程调用"></a><h2>RPC远程过程调用</h2>
<p>An Example of Local Procedure Call：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* save a string to file msg.dat */</span>
<span class="n">savemsg</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;msg.dat&#34;</span><span class="p">,</span> <span class="s">&#34;w+&#34;</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
        <span class="n">fclose</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="s">&#34;This is an example of LPC.&#34;</span><span class="p">;</span>
        <span class="n">savemsg</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Moving the local procedure to a remote machine:</p>
<ul>
<li>server:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">savemsg_1</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">argp</span><span class="p">;</span> <span class="k">struct</span> <span class="n">svc_req</span> <span class="o">*</span><span class="n">rqstp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;msg.dat&#34;</span><span class="p">,</span> <span class="s">&#34;w+&#34;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">*</span><span class="n">argp</span><span class="p">);</span>
    <span class="n">fclose</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>client:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="s">&#34;This is an example of RPC.&#34;</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">remote_host</span> <span class="o">=</span> <span class="s">&#34;sus1.cs.cityu.edu.hk&#34;</span><span class="p">;</span>
    <span class="n">CLIENT</span> <span class="o">*</span><span class="n">clnt</span><span class="p">;</span>
    <span class="n">clnt</span> <span class="o">=</span> <span class="n">clnt_create</span><span class="p">(</span><span class="n">remote_host</span><span class="p">,</span> <span class="n">MSGPROG</span><span class="p">,</span> <span class="n">MSGVER</span><span class="p">,</span> <span class="s">&#34;netpath&#34;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clnt</span> <span class="o">==</span> <span class="p">(</span><span class="n">CLIENT</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">clnt_pcreateerror</span><span class="p">(</span><span class="n">host</span><span class="p">);</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="n">savemsg_1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="n">clnt</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Remote Procedure Call:</p>
<ul>
<li>1984: Birrell &amp; Nelson
<ul>
<li>Mechanism to call procedures on other machines</li>
<li>Process on machine A can call a procedure on machine B
<ul>
<li>A is suspended</li>
<li>Execution continues on B</li>
<li>When B returns, control passed back to A</li>
</ul>
</li>
</ul>
</li>
<li>Goal: Make a remote procedure call looking the same as a local call to programmers.</li>
</ul>
<p>RPC implementation:</p>
<ul>
<li>The RPC compiler auto-generates stub/skeleton routines to make an RPC to the user as if it is a local call. What stub routines do:</li>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222091547.png" alt="" class="lazyload"></figure></li>
<li>marshalling / unmarshalling parameters and return values</li>
<li>handling different data formats between different machines</li>
<li>detecting and handling failures of client/server processes and the networks</li>
</ul>
<p>Compilation in SUN RPC:<figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222091707.png" alt="" class="lazyload"></figure></p>
<p>Demo of RPC:</p>
<ul>
<li>Interface file msg.x:</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="n">program</span> <span class="n">MSGPROG</span> <span class="p">{</span>
        <span class="n">version</span> <span class="n">MSGVER</span><span class="p">{</span>
               	<span class="kt">int</span> <span class="n">SAVEMSG</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          	<span class="n">string</span> <span class="nf">READMSG</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">=</span> <span class="mi">2</span><span class="p">;</span> 
        <span class="p">}</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span> <span class="o">=</span> <span class="mi">345678</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Generate stub routines by:
<ul>
<li>rpcgen –a msg.x</li>
</ul>
</li>
<li>Compile program by:
<ul>
<li>cc –o object xxx.c</li>
</ul>
</li>
</ul>
<a class="post-dummy-target" id="steps-in-s-rpc"></a><h3>Steps in s RPC</h3>
<ol>
<li>Client calls stub (push parameters onto stack)
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222094410.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Clnt_stub marshals parameters to message &amp; makes an OS call (client blocked)
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222095851.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Network message sent to server
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222095921.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Deliver message to server stub &amp; unblock server
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222095950.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Svr-stub unmarshals parameters &amp; calls service routine (local call)
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100023.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Return to the stub from service routine
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100050.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Svr_stub marshals return-value &amp; requests OS to send out message
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100127.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Transfer message over network
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100259.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Deliver message to client (unblock client)
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100328.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
<li>Clnt_stub unmarshals return-value &amp; returns to client program…
<ul>
<li><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="https://raw.githubusercontent.com/QizhengZou/Drawing_bed/main/20211222100356.png" alt="" class="lazyload"></figure></li>
</ul>
</li>
</ol>
<a class="post-dummy-target" id="writing-the-programs"></a><h3>Writing the programs</h3>
<p>Programmers need to write two pieces of programs:</p>
<ul>
<li>Client program
<ul>
<li>Specify server’s location</li>
<li>Parameters and return value of RPC are pointers</li>
</ul>
</li>
<li>Service routines
<ul>
<li>Generally the same as local procedures, except the parameters and parameter types</li>
</ul>
</li>
</ul>
</div><div class="post-copyright" id="post-footer">          
            <p class="copyright-item">
                <span>Author:&nbsp;</span>
                <span>qizheng</span>
            </p>

            <p class="copyright-item">
                <span>Updated on:&nbsp;</span>
                <span>2021-12-22</span>
            </p>

            <p class="copyright-item"></p>

            <p class="copyright-item"></p>

            <p class="copyright-item"></p>
        </div>
        <br>

        <div class="post-info-more">
            <section><span class="tag">
                            <a href="https://qizhengzou.github.io/tags/distributed_system/"><i class="fas fa-tag fa-fw"></i>&nbsp;distributed_system</a>&nbsp;
                        </span></section>
            <section>
                <span><a href="javascript:window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="https://qizhengzou.github.io">Home</a></span>
            </section>
        </div>
        
        <div class="post-nav"><a href="https://qizhengzou.github.io/2021/mutual-exclusion-election-algorithms/" class="prev" rel="prev" title="DistributedSystem_HongweiDu_05"><i class="fas fa-angle-left fa-fw"></i>DistributedSystem_HongweiDu_05</a>
                <a href="https://qizhengzou.github.io/2021/internetworking/" class="next" rel="next" title="DistributedSystem_HongweiDu_07">DistributedSystem_HongweiDu_07<i class="fas fa-angle-right fa-fw"></i></a></div><div class="post-comment"></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright">
        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://qizhengzou.github.io/about/" target="_blank">qizheng</a> | </span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> & <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt</a></div>
    </div>
</footer></div><a href="#" class="dynamic-to-top" id="dynamic-to-top" data-scroll>
            <span>&nbsp;</span>
        </a><script src="/js/lib/jquery/jquery.slim.min.js"></script><script src="/js/lib/lazysizes/lazysizes.min.js"></script><script src="/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js"></script><script>window.scroll = new SmoothScroll('[data-scroll]', {speed: 300, speedAsDuration: true});</script><link rel="stylesheet" href="/css/lib/katex/katex.min.css"><script src="/js/lib/katex/katex.min.js"></script><script defer src="/js/lib/katex/auto-render.min.js"></script><link rel="stylesheet" href="/css/lib/katex/copy-tex.min.css"><script defer src="/js/lib/katex/copy-tex.min.js"></script><script defer src="/js/lib/katex/mhchem.min.js"></script><script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true },{ left: "$", right: "$", display: false },]
            });
        });
    </script><script src="/js/blog.min.js"></script></body>
</html>