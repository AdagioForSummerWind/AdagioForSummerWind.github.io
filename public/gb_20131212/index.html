<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Gb_20131212 - 绿叶律动</title><meta name="Description" content="绿叶律动"><meta property="og:title" content="Gb_20131212" />
<meta property="og:description" content="Inside the Go Playground Andrew Gerrand
12 December 2013
Introduction NOTE: This article does not describe the current version of the Go Playground.
In September 2010 we introduced the Go Playground, a web service that compiles and executes arbitrary Go code and returns the program output.
If you’re a Go programmer then you have probably already used the playground by using the Go Playground directly, taking the Go Tour, or running executable examples from the Go documentation." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jefofrank.xyz/gb_20131212/" /><meta property="og:image" content="https://jefofrank.xyz/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-24T09:06:46+08:00" />
<meta property="article:modified_time" content="2022-10-29T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jefofrank.xyz/logo.png"/>

<meta name="twitter:title" content="Gb_20131212"/>
<meta name="twitter:description" content="Inside the Go Playground Andrew Gerrand
12 December 2013
Introduction NOTE: This article does not describe the current version of the Go Playground.
In September 2010 we introduced the Go Playground, a web service that compiles and executes arbitrary Go code and returns the program output.
If you’re a Go programmer then you have probably already used the playground by using the Go Playground directly, taking the Go Tour, or running executable examples from the Go documentation."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jefofrank.xyz/gb_20131212/" /><link rel="prev" href="https://jefofrank.xyz/gb_20131202/" /><link rel="next" href="https://jefofrank.xyz/gb_20131213/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Gb_20131212",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jefofrank.xyz\/gb_20131212\/"
        },"image": ["https:\/\/jefofrank.xyz\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go official blogs","wordcount":  2532 ,
        "url": "https:\/\/jefofrank.xyz\/gb_20131212\/","datePublished": "2022-10-24T09:06:46+08:00","dateModified": "2022-10-29T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Jefo","logo": "https:\/\/jefofrank.xyz\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Jefo"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-193031966-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-193031966-2');
</script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> All posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">All posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Gb_20131212</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/jf-011101" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jefo</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/2022/"><i class="far fa-folder fa-fw"></i>2022</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-10-24 09:06:46">2022-10-24 09:06:46</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2532 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;<span id="busuanzi_container_page_pv">
                    <i class="far fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;次阅读量</span>
                </span>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#the-back-end">The back end</a>
      <ul>
        <li><a href="#faking-time">Faking time</a></li>
        <li><a href="#faking-the-file-system">Faking the file system</a></li>
        <li><a href="#faking-the-network">Faking the network</a></li>
      </ul>
    </li>
    <li><a href="#the-front-end">The front end</a></li>
    <li><a href="#the-client">The client</a></li>
    <li><a href="#playing-offline">Playing offline</a></li>
    <li><a href="#other-clients">Other clients</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="inside-the-go-playground">Inside the Go Playground</h1>
<p>Andrew Gerrand<br>
12 December 2013</p>
<h2 id="introduction">Introduction</h2>
<p><em>NOTE: This article does not describe the current version of the Go Playground.</em></p>
<p>In September 2010 we <a href="https://blog.golang.org/introducing-go-playground" target="_blank" rel="noopener noreffer">introduced the Go Playground</a>, a web service that compiles and executes arbitrary Go code and returns the program output.</p>
<p>If you’re a Go programmer then you have probably already used the playground by using the <a href="https://go.dev/play/" target="_blank" rel="noopener noreffer">Go Playground</a> directly, taking the <a href="https://go.dev/tour/" target="_blank" rel="noopener noreffer">Go Tour</a>, or running <a href="https://go.dev/pkg/strings/#pkg-examples" target="_blank" rel="noopener noreffer">executable examples</a> from the Go documentation.</p>
<p>You may also have used it by clicking one of the “Run” buttons in a slide deck on <a href="https://go.dev/talks/" target="_blank" rel="noopener noreffer">go.dev/talks</a> or a post on this very blog (such as the <a href="https://blog.golang.org/strings" target="_blank" rel="noopener noreffer">recent article on Strings</a>).</p>
<p>In this article we will take a look at how the playground is implemented and integrated with these services. The implementation involves a variant operating system environment and runtime and our description here assumes you have some familiarity with systems programming using Go.</p>
<h2 id="overview">Overview</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="playground/overview.png"
        data-srcset="playground/overview.png, playground/overview.png 1.5x, playground/overview.png 2x"
        data-sizes="auto"
        alt="playground/overview.png"
        title="playground/overview.png" /></p>
<p>The playground service has three parts:</p>
<ul>
<li>A back end that runs on Google’s servers. It receives RPC requests, compiles the user program using the gc tool chain, executes the user program, and returns the program output (or compilation errors) as the RPC response.</li>
<li>A front end that runs on <a href="https://cloud.google.com/appengine/docs/go/" target="_blank" rel="noopener noreffer">Google App Engine</a>. It receives HTTP requests from the client and makes corresponding RPC requests to the back end. It also does some caching.</li>
<li>A JavaScript client that implements the user interface and makes HTTP requests to the front end.</li>
</ul>
<h2 id="the-back-end">The back end</h2>
<p>The back end program itself is trivial, so we won’t discuss its implementation here. The interesting part is how we safely execute arbitrary user code in a secure environment while still providing core functionality such as time, the network, and the file system.</p>
<p>To isolate user programs from Google’s infrastructure, the back end runs them under <a href="https://developers.google.com/native-client/" target="_blank" rel="noopener noreffer">Native Client</a> (or “NaCl”), a technology developed by Google to permit the safe execution of x86 programs inside web browsers. The back end uses a special version of the gc tool chain that generates NaCl executables.</p>
<p>(This special tool chain was merged into Go 1.3. To learn more, read the <a href="https://go.dev/s/go13nacl" target="_blank" rel="noopener noreffer">design document</a>.)</p>
<p>NaCl limits the amount of CPU and RAM a program may consume, and it prevents programs from accessing the network or file system. This presents a problem, however. Go’s concurrency and networking support are among its key strengths, and access to the file system is vital for many programs. To demonstrate concurrency effectively we need time, and to demonstrate networking and the file system we obviously need a network and a file system.</p>
<p>Although all these things are supported today, the first version of the playground, launched in 2010, had none of them. The current time was fixed at 10 November 2009, <code>time.Sleep</code> had no effect, and most functions of the <code>os</code> and <code>net</code> packages were stubbed out to return an <code>EINVALID</code> error.</p>
<p>A year ago we <a href="https://groups.google.com/d/msg/golang-nuts/JBsCrDEVyVE/30MaQsiQcWoJ" target="_blank" rel="noopener noreffer">implemented fake time</a> in the playground, so that programs that sleep would behave correctly. A more recent update to the playground introduced a fake network stack and a fake file system, making the playground’s tool chain similar to a normal Go tool chain. These facilities are described in the following sections.</p>
<h3 id="faking-time">Faking time</h3>
<p>Playground programs are limited in the amount of CPU time and memory they can use, but they are also restricted in how much real time they can use. This is because each running program consumes resources on the back end and any stateful infrastructure between it and the client. Limiting the run time of each playground program makes our service more predictable and defends us against denial of service attacks.</p>
<p>But these restrictions become stifling when running code that uses time. The <a href="https://go.dev/talks/2012/concurrency.slide" target="_blank" rel="noopener noreffer">Go Concurrency Patterns</a> talk demonstrates concurrency with examples that use timing functions like <a href="https://go.dev/pkg/time/#Sleep" target="_blank" rel="noopener noreffer"><code>time.Sleep</code></a> and <a href="https://go.dev/pkg/time/#After" target="_blank" rel="noopener noreffer"><code>time.After</code></a>. When run under early versions of the playground, these programs' sleeps would have no effect and their behavior would be strange (and sometimes wrong).</p>
<p>By using a clever trick we can make a Go program <em>think</em> that it is sleeping, when really the sleeps take no time at all. To explain the trick we first need to understand how the scheduler manages sleeping goroutines.</p>
<p>When a goroutine calls <code>time.Sleep</code> (or similar) the scheduler adds a timer to a heap of pending timers and puts the goroutine to sleep. Meanwhile, a special timer goroutine manages that heap. When the timer goroutine starts it tells the scheduler to wake it when the next pending timer is ready to fire and then sleeps. When it wakes up it checks which timers have expired, wakes the appropriate goroutines, and goes back to sleep.</p>
<p>The trick is to change the condition that wakes the timer goroutine. Instead of waking it after a specific time period, we modify the scheduler to wait for a deadlock; the state where all goroutines are blocked.</p>
<p>The playground version of the runtime maintains its own internal clock. When the modified scheduler detects a deadlock it checks whether any timers are pending. If so, it advances the internal clock to the trigger time of the earliest timer and then wakes the timer goroutine. Execution continues and the program believes that time has passed, when in fact the sleep was nearly instantaneous.</p>
<p>These changes to the scheduler can be found in <a href="https://go.dev/cl/73110043" target="_blank" rel="noopener noreffer"><code>proc.c</code></a> and <a href="https://go.dev/cl/73110043" target="_blank" rel="noopener noreffer"><code>time.goc</code></a>.</p>
<p>Fake time fixes the issue of resource exhaustion on the back end, but what about the program output? It would be odd to see a program that sleeps run to completion correctly without taking any time.</p>
<p>The following program prints the current time each second and then exits after three seconds. Try running it.</p>
<p>// +build OMIT</p>
<p>package main</p>
<p>import (
&ldquo;fmt&rdquo;
&ldquo;time&rdquo;
)</p>
<p>func main() {
stop := time.After(3 * time.Second)
tick := time.NewTicker(1 * time.Second)
defer tick.Stop()
for {
select {
case &lt;-tick.C:
fmt.Println(time.Now())
case &lt;-stop:
return
}
}
}</p>
<p>Run</p>
<p>RunKillClose</p>
<p>How does this work? It is a collaboration between the back end, front end, and client.</p>
<p>We capture the timing of each write to standard output and standard error and provide it to the client. Then the client can “play back” the writes with the correct timing, so that the output appears just as if the program were running locally.</p>
<p>The playground’s <code>runtime</code> package provides a special <a href="https://github.com/golang/go/blob/go1.3/src/pkg/runtime/sys_nacl_amd64p32.s#L54" target="_blank" rel="noopener noreffer"><code>write</code> function</a> that includes a small “playback header” before each write. The playback header comprises a magic string, the current time, and the length of the write data. A write with a playback header has this structure:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">0 0 P B &lt;8-byte time&gt; &lt;4-byte data length&gt; &lt;data&gt;
</code></pre></td></tr></table>
</div>
</div><p>The raw output of the program above looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">\x00\x00PB\x11\x74\xef\xed\xe6\xb3\x2a\x00\x00\x00\x00\x1e2009-11-10 23:00:01 +0000 UTC
\x00\x00PB\x11\x74\xef\xee\x22\x4d\xf4\x00\x00\x00\x00\x1e2009-11-10 23:00:02 +0000 UTC
\x00\x00PB\x11\x74\xef\xee\x5d\xe8\xbe\x00\x00\x00\x00\x1e2009-11-10 23:00:03 +0000 UTC
</code></pre></td></tr></table>
</div>
</div><p>The front end parses this output as a series of events and returns a list of events to the client as a JSON object:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">{
    &#34;Errors&#34;: &#34;&#34;,
    &#34;Events&#34;: [
        {
            &#34;Delay&#34;: 1000000000,
            &#34;Message&#34;: &#34;2009-11-10 23:00:01 +0000 UTC\n&#34;
        },
        {
            &#34;Delay&#34;: 1000000000,
            &#34;Message&#34;: &#34;2009-11-10 23:00:02 +0000 UTC\n&#34;
        },
        {
            &#34;Delay&#34;: 1000000000,
            &#34;Message&#34;: &#34;2009-11-10 23:00:03 +0000 UTC\n&#34;
        }
    ]
}
</code></pre></td></tr></table>
</div>
</div><p>The JavaScript client (running in the user’s web browser) then plays back the events using the provided delay intervals. To the user it appears that the program is running in real time.</p>
<h3 id="faking-the-file-system">Faking the file system</h3>
<p>Programs built with the Go’s NaCl tool chain cannot access the local machine’s file system. Instead, the <code>syscall</code> package’s file-related functions (<code>Open</code>, <code>Read</code>, <code>Write</code>, and so on) operate on an in-memory file system that is implemented by the <code>syscall</code> package itself. Since package <code>syscall</code> is the interface between the Go code and the operating system kernel, user programs see the file system exactly the same way as they would a real one.</p>
<p>The following example program writes data to a file, and then copies its contents to standard output. Try running it. (You can edit it, too!)</p>
<p>// +build OMIT</p>
<p>package main</p>
<p>import (
&ldquo;fmt&rdquo;
&ldquo;io/ioutil&rdquo;
&ldquo;log&rdquo;
)</p>
<p>func main() {
const filename = &ldquo;/tmp/file.txt&rdquo;</p>
<pre><code>err := ioutil.WriteFile(filename, \[\]byte(&quot;Hello, file system\\n&quot;), 0644)
if err != nil {
    log.Fatal(err)
}

b, err := ioutil.ReadFile(filename)
if err != nil {
    log.Fatal(err)
}

fmt.Printf(&quot;%s&quot;, b)
</code></pre>
<p>}</p>
<p>Run</p>
<p>RunKillClose</p>
<p>When a process starts, the file system is populated with some devices under <code>/dev</code> and an empty <code>/tmp</code> directory. The program can manipulate the file system as usual, but when the process exits any changes to the file system are lost.</p>
<p>There is also a provision to load a zip file into the file system at init time (see <a href="https://github.com/golang/go/blob/go1.3/src/pkg/syscall/unzip_nacl.go" target="_blank" rel="noopener noreffer"><code>unzip_nacl.go</code></a>). So far we have only used the unzip facility to provide the data files required to run the standard library tests, but we intend to provide playground programs with a set of files that can be used in documentation examples, blog posts, and the Go Tour.</p>
<p>The implementation can be found in the <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fs_nacl.go" target="_blank" rel="noopener noreffer"><code>fs_nacl.go</code></a> and <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fd_nacl.go" target="_blank" rel="noopener noreffer"><code>fd_nacl.go</code></a> files (which, by virtue of their <code>_nacl</code> suffix, are built into package <code>syscall</code> only when <code>GOOS</code> is set to <code>nacl</code>).</p>
<p>The file system itself is represented by the <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fs_nacl.go#L26" target="_blank" rel="noopener noreffer"><code>fsys</code> struct</a>, of which a global instance (named <code>fs</code>) is created during init time. The various file-related functions then operate on <code>fs</code> instead of making the actual system call. For instance, here is the <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fs_nacl.go#L473" target="_blank" rel="noopener noreffer"><code>syscall.Open</code></a> function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">func Open(path string, openmode int, perm uint32) (fd int, err error) {
    fs.mu.Lock()
    defer fs.mu.Unlock()
    f, err := fs.open(path, openmode, perm&amp;0777|S_IFREG)
    if err != nil {
        return -1, err
    }
    return newFD(f), nil
}
</code></pre></td></tr></table>
</div>
</div><p>File descriptors are tracked by a global slice named <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fd_nacl.go#L17" target="_blank" rel="noopener noreffer"><code>files</code></a>. Each file descriptor corresponds to a <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fd_nacl.go#L23" target="_blank" rel="noopener noreffer"><code>file</code></a> and each <code>file</code> provides a value that implements the <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fd_nacl.go#L30" target="_blank" rel="noopener noreffer"><code>fileImpl</code></a> interface. There are several implementations of the interface:</p>
<ul>
<li>regular files and devices (such as <code>/dev/random</code>) are represented by <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fs_nacl.go#L58" target="_blank" rel="noopener noreffer"><code>fsysFile</code></a>,</li>
<li>standard input, output, and error are instances of <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/fd_nacl.go#L216" target="_blank" rel="noopener noreffer"><code>naclFile</code></a>, which uses system calls to interact with the actual files (these are a playground program’s only way to interact with the outside world),</li>
<li>network sockets have their own implementation, discussed in the next section.</li>
</ul>
<h3 id="faking-the-network">Faking the network</h3>
<p>Like the file system, the playground’s network stack is an in-process fake implemented by the <code>syscall</code> package. It permits playground projects to use the loopback interface (<code>127.0.0.1</code>). Requests to other hosts will fail.</p>
<p>For an executable example, run the following program. It listens on a TCP port, waits for an incoming connection, copies the data from that connection to standard output, and exits. In another goroutine, it makes a connection to the listening port, writes a string to the connection, and closes it.</p>
<p>// +build OMIT</p>
<p>package main</p>
<p>import (
&ldquo;io&rdquo;
&ldquo;log&rdquo;
&ldquo;net&rdquo;
&ldquo;os&rdquo;
)</p>
<p>func main() {
l, err := net.Listen(&ldquo;tcp&rdquo;, &ldquo;127.0.0.1:4000&rdquo;)
if err != nil {
log.Fatal(err)
}
defer l.Close()</p>
<pre><code>go dial()

c, err := l.Accept()
if err != nil {
    log.Fatal(err)
}
defer c.Close()

io.Copy(os.Stdout, c)
</code></pre>
<p>}</p>
<p>func dial() {
c, err := net.Dial(&ldquo;tcp&rdquo;, &ldquo;127.0.0.1:4000&rdquo;)
if err != nil {
log.Fatal(err)
}
defer c.Close()
c.Write([]byte(&ldquo;Hello, network\n&rdquo;))
}</p>
<p>Run</p>
<p>RunKillClose</p>
<p>The interface to the network is more complex than the one for files, so the implementation of the fake network is larger and more complex than the fake file system. It must simulate read and write timeouts, different address types and protocols, and so on.</p>
<p>The implementation can be found in <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/net_nacl.go" target="_blank" rel="noopener noreffer"><code>net_nacl.go</code></a>. A good place to start reading is <a href="https://github.com/golang/go/blob/2197321db1dd997165c0091ba2bcb3b6be7633d0/src/syscall/net_nacl.go#L461" target="_blank" rel="noopener noreffer"><code>netFile</code></a>, the network socket implementation of the <code>fileImpl</code> interface.</p>
<h2 id="the-front-end">The front end</h2>
<p>The playground front end is another simple program (shorter than 100 lines). It receives HTTP requests from the client, makes RPC requests to the back end, and does some caching.</p>
<p>The front end serves an HTTP handler at <code>https://golang.org/compile</code>. The handler expects a POST request with a <code>body</code> field (the Go program to run) and an optional <code>version</code> field (for most clients this should be <code>&quot;2&quot;</code>).</p>
<p>When the front end receives a compilation request it first checks <a href="https://developers.google.com/appengine/docs/memcache/" target="_blank" rel="noopener noreffer">memcache</a> to see if it has cached the results of a previous compilation of that source. If found, it returns the cached response. The cache prevents popular programs such as those on the <a href="https://go.dev/" target="_blank" rel="noopener noreffer">Go home page</a> from overloading the back ends. If there is no cached response, the front end makes an RPC request to the back end, stores the response in memcache, parses the playback events, and returns a JSON object to the client as the HTTP response (as described above).</p>
<h2 id="the-client">The client</h2>
<p>The various sites that use the playground each share some common JavaScript code for setting up the user interface (the code and output boxes, the run button, and so on) and communicating with the playground front end.</p>
<p>This implementation is in the file <a href="https://github.com/golang/tools/blob/f8e922be8efeabd06a510065ca5836b62fa10b9a/godoc/static/playground.js" target="_blank" rel="noopener noreffer"><code>playground.js</code></a> in the <code>go.tools</code> repository, which can be imported from the <a href="https://godoc.org/golang.org/x/tools/godoc/static" target="_blank" rel="noopener noreffer"><code>golang.org/x/tools/godoc/static</code></a> package. Some of it is clean and some is a bit crufty, as it is the result of consolidating several divergent implementations of the client code.</p>
<p>The <a href="https://github.com/golang/tools/blob/f8e922be8efeabd06a510065ca5836b62fa10b9a/godoc/static/playground.js#L227" target="_blank" rel="noopener noreffer"><code>playground</code></a> function takes some HTML elements and turns them into an interactive playground widget. You should use this function if you want to put the playground on your own site (see ‘Other clients’ below).</p>
<p>The <a href="https://github.com/golang/tools/blob/f8e922be8efeabd06a510065ca5836b62fa10b9a/godoc/static/playground.js#L6" target="_blank" rel="noopener noreffer"><code>Transport</code></a> interface (not formally defined, this being JavaScript) abstracts the user interface from the means of talking to the web front end. <a href="https://github.com/golang/tools/blob/f8e922be8efeabd06a510065ca5836b62fa10b9a/godoc/static/playground.js#L43" target="_blank" rel="noopener noreffer"><code>HTTPTransport</code></a> is an implementation of <code>Transport</code> that speaks the HTTP-based protocol described earlier. <a href="https://github.com/golang/tools/blob/f8e922be8efeabd06a510065ca5836b62fa10b9a/godoc/static/playground.js#L115" target="_blank" rel="noopener noreffer"><code>SocketTransport</code></a> is another implementation that speaks WebSocket (see ‘Playing offline’ below).</p>
<p>To comply with the <a href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_blank" rel="noopener noreffer">same-origin policy</a>, the various web servers (godoc, for instance) proxy requests to <code>/compile</code> through to the playground service at <code>https://golang.org/compile</code>. The common <a href="https://godoc.org/golang.org/x/tools/playground" target="_blank" rel="noopener noreffer"><code>golang.org/x/tools/playground</code></a> package does this proxying.</p>
<h2 id="playing-offline">Playing offline</h2>
<p>Both the <a href="https://go.dev/tour/" target="_blank" rel="noopener noreffer">Go Tour</a> and the <a href="https://godoc.org/golang.org/x/tools/present" target="_blank" rel="noopener noreffer">Present Tool</a> can be run offline. This is great for people with limited internet connectivity or presenters at conferences who cannot (and <em>should</em> not) rely on a working internet connection.</p>
<p>To run offline, the tools run their own version of the playground back end on the local machine. The back end uses a regular Go tool chain with none of the aforementioned modifications and uses a WebSocket to communicate with the client.</p>
<p>The WebSocket back end implementation can be found in the <a href="https://godoc.org/golang.org/x/tools/playground/socket" target="_blank" rel="noopener noreffer"><code>golang.org/x/tools/playground/socket</code></a> package. The <a href="https://go.dev/talks/2012/insidepresent.slide#1" target="_blank" rel="noopener noreffer">Inside Present</a> talk discusses this code in detail.</p>
<h2 id="other-clients">Other clients</h2>
<p>The playground service is used by more than just the official Go project (<a href="https://gobyexample.com/" target="_blank" rel="noopener noreffer">Go by Example</a> is one other instance) and we are happy for you to use it on your own site. All we ask is that you <a href="mailto:golang-dev@googlegroups.com" rel="">contact us first</a>, use a unique user agent in your requests (so we can identify you), and that your service is of benefit to the Go community.</p>
<h2 id="conclusion">Conclusion</h2>
<p>From godoc to the tour to this very blog, the playground has become an essential part of our Go documentation story. With the recent additions of the fake file system and network stack we are excited to expand our learning materials to cover those areas.</p>
<p>But, ultimately, the playground is just the tip of the iceberg. With Native Client support scheduled for Go 1.3, we look forward to seeing what the community can do with it.</p>
<p><em>This article is part 12 of the</em> <a href="https://blog.gopheracademy.com/go-advent-2013" target="_blank" rel="noopener noreffer">Go Advent Calendar</a>, <em>a series of daily blog posts throughout December .</em></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-10-29 00:00:00</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://jefofrank.xyz/gb_20131212/" data-title="Gb_20131212" data-hashtags="go official blogs"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://jefofrank.xyz/gb_20131212/" data-hashtag="go official blogs"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://jefofrank.xyz/gb_20131212/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://jefofrank.xyz/gb_20131212/" data-title="Gb_20131212"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://jefofrank.xyz/gb_20131212/" data-title="Gb_20131212"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://jefofrank.xyz/gb_20131212/" data-title="Gb_20131212"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go-official-blogs/">go official blogs</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/gb_20131202/" class="prev" rel="prev" title="Gb_20131202"><i class="fas fa-angle-left fa-fw"></i>Gb_20131202</a>
            <a href="/gb_20131213/" class="next" rel="next" title="Gb_20131213">Gb_20131213<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/jf-011101" target="_blank">Jefo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href="https://beian.miit.gov.cn/">赣ICP备2022007470号-1</a></span></br>
                <span id="busuanzi_container_site_pv">
                    访问量 <span id="busuanzi_value_site_pv"></span> 次
                </span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_uv">
                    访客数 <span id="busuanzi_value_site_uv"></span> 人次
                </span>
                </br><script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = 2021;
                        var startMonth = 3;
                        var startDate = 27;
                        var startHour = 19;
                        var startMinute = 15;
                        var startSecond = 11;
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }
                    setInterval(siteTime, 1000);
                </script>
                    <span id="sitetime">载入运行时间...</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://jefos-blog.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"data":{"id-1":"绿叶律动","id-2":"绿叶律动"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"J0OW8CCKJZ","algoliaIndex":"JF-2","algoliaSearchKey":"3b4a19e831c95174aca4c03fcdf95f5c","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
