<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Gb_20200302 - 绿叶律动</title><meta name="Description" content="绿叶律动"><meta property="og:title" content="Gb_20200302" />
<meta property="og:description" content="A new Go API for Protocol Buffers Joe Tsai, Damien Neil, and Herbie Ong
2 March 2020
Introduction We are pleased to announce the release of a major revision of the Go API for protocol buffers, Google’s language-neutral data interchange format.
Motivations for a new API The first protocol buffer bindings for Go were announced by Rob Pike in March of 2010. Go 1 would not be released for another two years." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jefofrank.xyz/gb_20200302/" /><meta property="og:image" content="https://jefofrank.xyz/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-29T19:58:19+08:00" />
<meta property="article:modified_time" content="2022-10-29T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jefofrank.xyz/logo.png"/>

<meta name="twitter:title" content="Gb_20200302"/>
<meta name="twitter:description" content="A new Go API for Protocol Buffers Joe Tsai, Damien Neil, and Herbie Ong
2 March 2020
Introduction We are pleased to announce the release of a major revision of the Go API for protocol buffers, Google’s language-neutral data interchange format.
Motivations for a new API The first protocol buffer bindings for Go were announced by Rob Pike in March of 2010. Go 1 would not be released for another two years."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jefofrank.xyz/gb_20200302/" /><link rel="prev" href="https://jefofrank.xyz/gb_20200225/" /><link rel="next" href="https://jefofrank.xyz/gb_20200325/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Gb_20200302",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jefofrank.xyz\/gb_20200302\/"
        },"image": ["https:\/\/jefofrank.xyz\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go official blogs","wordcount":  1542 ,
        "url": "https:\/\/jefofrank.xyz\/gb_20200302\/","datePublished": "2022-10-29T19:58:19+08:00","dateModified": "2022-10-29T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Jefo","logo": "https:\/\/jefofrank.xyz\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Jefo"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-193031966-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-193031966-2');
</script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> All posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">All posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Gb_20200302</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/jf-011101" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jefo</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/2022/"><i class="far fa-folder fa-fw"></i>2022</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-10-29 19:58:19">2022-10-29 19:58:19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1542 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;<span id="busuanzi_container_page_pv">
                    <i class="far fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;次阅读量</span>
                </span>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#motivations-for-a-new-api">Motivations for a new API</a></li>
    <li><a href="#reflection">Reflection</a></li>
    <li><a href="#versions">Versions</a></li>
    <li><a href="#additional-features-of-note">Additional features of note</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="a-new-go-api-for-protocol-buffers">A new Go API for Protocol Buffers</h1>
<p>Joe Tsai, Damien Neil, and Herbie Ong<br>
2 March 2020</p>
<h2 id="introduction">Introduction</h2>
<p>We are pleased to announce the release of a major revision of the Go API for <a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener noreffer">protocol buffers</a>, Google’s language-neutral data interchange format.</p>
<h2 id="motivations-for-a-new-api">Motivations for a new API</h2>
<p>The first protocol buffer bindings for Go were <a href="https://blog.golang.org/third-party-libraries-goprotobuf-and" target="_blank" rel="noopener noreffer">announced by Rob Pike</a> in March of 2010. Go 1 would not be released for another two years.</p>
<p>In the decade since that first release, the package has grown and developed along with Go. Its users' requirements have grown too.</p>
<p>Many people want to write programs that use reflection to examine protocol buffer messages. The <a href="https://pkg.go.dev/reflect" target="_blank" rel="noopener noreffer"><code>reflect</code></a> package provides a view of Go types and values, but omits information from the protocol buffer type system. For example, we might want to write a function that traverses a log entry and clears any field annotated as containing sensitive data. The annotations are not part of the Go type system.</p>
<p>Another common desire is to use data structures other than the ones generated by the protocol buffer compiler, such as a dynamic message type capable of representing messages whose type is not known at compile time.</p>
<p>We also observed that a frequent source of problems was that the <a href="https://pkg.go.dev/github.com/golang/protobuf/proto?tab=doc#Message" target="_blank" rel="noopener noreffer"><code>proto.Message</code></a> interface, which identifies values of generated message types, does very little to describe the behavior of those types. When users create types that implement that interface (often inadvertently by embedding a message in another struct) and pass values of those types to functions expecting a generated message value, programs crash or behave unpredictably.</p>
<p>All three of these problems have a common cause, and a common solution: The <code>Message</code> interface should fully specify the behavior of a message, and functions operating on <code>Message</code> values should freely accept any type that correctly implements the interface.</p>
<p>Since it is not possible to change the existing definition of the <code>Message</code> type while keeping the package API compatible, we decided that it was time to begin work on a new, incompatible major version of the protobuf module.</p>
<p>Today, we’re pleased to release that new module. We hope you like it.</p>
<h2 id="reflection">Reflection</h2>
<p>Reflection is the flagship feature of the new implementation. Similar to how the <code>reflect</code> package provides a view of Go types and values, the <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf/reflect/protoreflect</code></a> package provides a view of values according to the protocol buffer type system.</p>
<p>A complete description of the <code>protoreflect</code> package would run too long for this post, but let’s look at how we might write the log-scrubbing function we mentioned previously.</p>
<p>First, we’ll write a <code>.proto</code> file defining an extension of the <a href="https://github.com/protocolbuffers/protobuf/blob/b96241b1b716781f5bc4dc25e1ebb0003dfaba6a/src/google/protobuf/descriptor.proto#L509" target="_blank" rel="noopener noreffer"><code>google.protobuf.FieldOptions</code></a> type so we can annotate fields as containing sensitive information or not.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">syntax</span> <span class="p">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span>
<span class="kn">import</span> <span class="s">&#34;google/protobuf/descriptor.proto&#34;</span><span class="p">;</span>
<span class="kn">package</span> <span class="nx">golang</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">policy</span><span class="p">;</span>
<span class="nx">extend</span> <span class="nx">google</span><span class="p">.</span><span class="nx">protobuf</span><span class="p">.</span><span class="nx">FieldOptions</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="nx">non_sensitive</span> <span class="p">=</span> <span class="mi">50000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>We can use this option to mark certain fields as non-sensitive.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">message MyMessage {
    string public_name = 1 [(golang.example.policy.non_sensitive) = true];
}
</code></pre></td></tr></table>
</div>
</div><p>Next, we will write a Go function which accepts an arbitrary message value and removes all the sensitive fields.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// Redact clears every sensitive field in pb.
func Redact(pb proto.Message) {
   // ...
}
</code></pre></td></tr></table>
</div>
</div><p>This function accepts a <a href="https://pkg.go.dev/google.golang.org/protobuf/proto?tab=doc#Message" target="_blank" rel="noopener noreffer"><code>proto.Message</code></a>, an interface type implemented by all generated message types. This type is an alias for one defined in the <code>protoreflect</code> package:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">type ProtoMessage interface{
    ProtoReflect() Message
}
</code></pre></td></tr></table>
</div>
</div><p>To avoid filling up the namespace of generated messages, the interface contains only a single method returning a <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc#Message" target="_blank" rel="noopener noreffer"><code>protoreflect.Message</code></a>, which provides access to the message contents.</p>
<p>(Why an alias? Because <code>protoreflect.Message</code> has a corresponding method returning the original <code>proto.Message</code>, and we need to avoid an import cycle between the two packages.)</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc#Message.Range" target="_blank" rel="noopener noreffer"><code>protoreflect.Message.Range</code></a> method calls a function for every populated field in a message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">m := pb.ProtoReflect()
m.Range(func(fd protoreflect.FieldDescriptor, v protoreflect.Value) bool {
    // ...
    return true
})
</code></pre></td></tr></table>
</div>
</div><p>The range function is called with a <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc#FieldDescriptor" target="_blank" rel="noopener noreffer"><code>protoreflect.FieldDescriptor</code></a> describing the protocol buffer type of the field, and a <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc#Value" target="_blank" rel="noopener noreffer"><code>protoreflect.Value</code></a> containing the field value.</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect?tab=doc#Descriptor.Options" target="_blank" rel="noopener noreffer"><code>protoreflect.FieldDescriptor.Options</code></a> method returns the field options as a <code>google.protobuf.FieldOptions</code> message.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">opts := fd.Options().(*descriptorpb.FieldOptions)
</code></pre></td></tr></table>
</div>
</div><p>(Why the type assertion? Since the generated <code>descriptorpb</code> package depends on <code>protoreflect</code>, the <code>protoreflect</code> package can’t return the concrete options type without causing an import cycle.)</p>
<p>We can then check the options to see the value of our extension boolean:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">if proto.GetExtension(opts, policypb.E_NonSensitive).(bool) {
    return true // don&#39;t redact non-sensitive fields
}
</code></pre></td></tr></table>
</div>
</div><p>Note that we are looking at the field <em>descriptor</em> here, not the field <em>value</em>. The information we’re interested in lies in the protocol buffer type system, not the Go one.</p>
<p>This is also an example of an area where we have simplified the <code>proto</code> package API. The original <a href="https://pkg.go.dev/github.com/golang/protobuf/proto?tab=doc#GetExtension" target="_blank" rel="noopener noreffer"><code>proto.GetExtension</code></a> returned both a value and an error. The new <a href="https://pkg.go.dev/google.golang.org/protobuf/proto?tab=doc#GetExtension" target="_blank" rel="noopener noreffer"><code>proto.GetExtension</code></a> returns just a value, returning the default value for the field if it is not present. Extension decoding errors are reported at <code>Unmarshal</code> time.</p>
<p>Once we have identified a field that needs redaction, clearing it is simple:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">m.Clear(fd)
</code></pre></td></tr></table>
</div>
</div><p>Putting all the above together, our complete redaction function is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// Redact clears every sensitive field in pb.
func Redact(pb proto.Message) {
    m := pb.ProtoReflect()
    m.Range(func(fd protoreflect.FieldDescriptor, v protoreflect.Value) bool {
        opts := fd.Options().(*descriptorpb.FieldOptions)
        if proto.GetExtension(opts, policypb.E_NonSensitive).(bool) {
            return true
        }
        m.Clear(fd)
        return true
    })
}
</code></pre></td></tr></table>
</div>
</div><p>A more complete implementation might recursively descend into message-valued fields. We hope that this simple example gives a taste of protocol buffer reflection and its uses.</p>
<h2 id="versions">Versions</h2>
<p>We call the original version of Go protocol buffers APIv1, and the new one APIv2. Because APIv2 is not backwards compatible with APIv1, we need to use different module paths for each.</p>
<p>(These API versions are not the same as the versions of the protocol buffer language: <code>proto1</code>, <code>proto2</code>, and <code>proto3</code>. APIv1 and APIv2 are concrete implementations in Go that both support the <code>proto2</code> and <code>proto3</code> language versions.)</p>
<p>The <a href="https://pkg.go.dev/github.com/golang/protobuf?tab=overview" target="_blank" rel="noopener noreffer"><code>github.com/golang/protobuf</code></a> module is APIv1.</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf?tab=overview" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf</code></a> module is APIv2. We have taken advantage of the need to change the import path to switch to one that is not tied to a specific hosting provider. (We considered <code>google.golang.org/protobuf/v2</code>, to make it clear that this is the second major version of the API, but settled on the shorter path as being the better choice in the long term.)</p>
<p>We know that not all users will move to a new major version of a package at the same rate. Some will switch quickly; others may remain on the old version indefinitely. Even within a single program, some parts may use one API while others use another. It is essential, therefore, that we continue to support programs that use APIv1.</p>
<ul>
<li>
<p><code>github.com/golang/protobuf@v1.3.4</code> is the most recent pre-APIv2 version of APIv1.</p>
</li>
<li>
<p><code>github.com/golang/protobuf@v1.4.0</code> is a version of APIv1 implemented in terms of APIv2. The API is the same, but the underlying implementation is backed by the new one. This version contains functions to convert between the APIv1 and APIv2 <code>proto.Message</code> interfaces to ease the transition between the two.</p>
</li>
<li>
<p><code>google.golang.org/protobuf@v1.20.0</code> is APIv2. This module depends upon <code>github.com/golang/protobuf@v1.4.0</code>, so any program which uses APIv2 will automatically pick a version of APIv1 which integrates with it.</p>
</li>
</ul>
<p>(Why start at version <code>v1.20.0</code>? To provide clarity. We do not anticipate APIv1 to ever reach <code>v1.20.0</code>, so the version number alone should be enough to unambiguously differentiate between APIv1 and APIv2.)</p>
<p>We intend to maintain support for APIv1 indefinitely.</p>
<p>This organization ensures that any given program will use only a single protocol buffer implementation, regardless of which API version it uses. It permits programs to adopt the new API gradually, or not at all, while still gaining the advantages of the new implementation. The principle of minimum version selection means that programs may remain on the old implementation until the maintainers choose to update to the new one (either directly, or by updating a dependency).</p>
<h2 id="additional-features-of-note">Additional features of note</h2>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/encoding/protojson" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf/encoding/protojson</code></a> package converts protocol buffer messages to and from JSON using the <a href="https://developers.google.com/protocol-buffers/docs/proto3#json" target="_blank" rel="noopener noreffer">canonical JSON mapping</a>, and fixes a number of issues with the old <code>jsonpb</code> package that were difficult to change without causing problems for existing users.</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/types/dynamicpb" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf/types/dynamicpb</code></a> package provides an implementation of <code>proto.Message</code> for messages whose protocol buffer type is derived at runtime.</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/testing/protocmp" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf/testing/protocmp</code></a> package provides functions to compare protocol buffer messages with the <a href="https://pkg.go.dev/github.com/google/go-cmp/cmp" target="_blank" rel="noopener noreffer"><code>github.com/google/cmp</code></a> package.</p>
<p>The <a href="https://pkg.go.dev/google.golang.org/protobuf/compiler/protogen?tab=doc" target="_blank" rel="noopener noreffer"><code>google.golang.org/protobuf/compiler/protogen</code></a> package provides support for writing protocol compiler plugins.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The <code>google.golang.org/protobuf</code> module is a major overhaul of Go’s support for protocol buffers, providing first-class support for reflection, custom message implementations, and a cleaned up API surface. We intend to maintain the previous API indefinitely as a wrapper of the new one, allowing users to adopt the new API incrementally at their own pace.</p>
<p>Our goal in this update is to improve upon the benefits of the old API while addressing its shortcomings. As we completed each component of the new implementation, we put it into use within Google’s codebase. This incremental rollout has given us confidence in both the usability of the new API and the performance and correctness of the new implementation. We believe it is production ready.</p>
<p>We are excited about this release and hope that it will serve the Go ecosystem for the next ten years and beyond!</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-10-29 00:00:00</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://jefofrank.xyz/gb_20200302/" data-title="Gb_20200302" data-hashtags="go official blogs"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://jefofrank.xyz/gb_20200302/" data-hashtag="go official blogs"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://jefofrank.xyz/gb_20200302/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://jefofrank.xyz/gb_20200302/" data-title="Gb_20200302"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://jefofrank.xyz/gb_20200302/" data-title="Gb_20200302"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://jefofrank.xyz/gb_20200302/" data-title="Gb_20200302"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go-official-blogs/">go official blogs</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/gb_20200225/" class="prev" rel="prev" title="Gb_20200225"><i class="fas fa-angle-left fa-fw"></i>Gb_20200225</a>
            <a href="/gb_20200325/" class="next" rel="next" title="Gb_20200325">Gb_20200325<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/jf-011101" target="_blank">Jefo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href="https://beian.miit.gov.cn/">赣ICP备2022007470号-1</a></span></br>
                <span id="busuanzi_container_site_pv">
                    访问量 <span id="busuanzi_value_site_pv"></span> 次
                </span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_uv">
                    访客数 <span id="busuanzi_value_site_uv"></span> 人次
                </span>
                </br><script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = 2021;
                        var startMonth = 3;
                        var startDate = 27;
                        var startHour = 19;
                        var startMinute = 15;
                        var startSecond = 11;
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }
                    setInterval(siteTime, 1000);
                </script>
                    <span id="sitetime">载入运行时间...</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://jefos-blog.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"data":{"id-1":"绿叶律动","id-2":"绿叶律动"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"J0OW8CCKJZ","algoliaIndex":"JF-2","algoliaSearchKey":"3b4a19e831c95174aca4c03fcdf95f5c","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
