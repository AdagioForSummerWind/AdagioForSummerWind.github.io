<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Gb_20140729 - 绿叶律动</title><meta name="Description" content="绿叶律动"><meta property="og:title" content="Gb_20140729" />
<meta property="og:description" content="Go Concurrency Patterns: Context Sameer Ajmani
29 July 2014
Introduction In Go servers, each incoming request is handled in its own goroutine. Request handlers often start additional goroutines to access backends such as databases and RPC services. The set of goroutines working on a request typically needs access to request-specific values such as the identity of the end user, authorization tokens, and the request’s deadline. When a request is canceled or times out, all the goroutines working on that request should exit quickly so the system can reclaim any resources they are using." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jefofrank.xyz/gb_20140729/" /><meta property="og:image" content="https://jefofrank.xyz/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-24T09:10:38+08:00" />
<meta property="article:modified_time" content="2022-10-29T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jefofrank.xyz/logo.png"/>

<meta name="twitter:title" content="Gb_20140729"/>
<meta name="twitter:description" content="Go Concurrency Patterns: Context Sameer Ajmani
29 July 2014
Introduction In Go servers, each incoming request is handled in its own goroutine. Request handlers often start additional goroutines to access backends such as databases and RPC services. The set of goroutines working on a request typically needs access to request-specific values such as the identity of the end user, authorization tokens, and the request’s deadline. When a request is canceled or times out, all the goroutines working on that request should exit quickly so the system can reclaim any resources they are using."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jefofrank.xyz/gb_20140729/" /><link rel="prev" href="https://jefofrank.xyz/gb_20140715/" /><link rel="next" href="https://jefofrank.xyz/gb_20140820/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Gb_20140729",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jefofrank.xyz\/gb_20140729\/"
        },"image": ["https:\/\/jefofrank.xyz\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "go official blogs","wordcount":  2029 ,
        "url": "https:\/\/jefofrank.xyz\/gb_20140729\/","datePublished": "2022-10-24T09:10:38+08:00","dateModified": "2022-10-29T00:00:00+00:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Jefo","logo": "https:\/\/jefofrank.xyz\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Jefo"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-193031966-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-193031966-2');
</script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> All posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">All posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Gb_20140729</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/jf-011101" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jefo</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/2022/"><i class="far fa-folder fa-fw"></i>2022</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-10-24 09:10:38">2022-10-24 09:10:38</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2029 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id="busuanzi_container_page_pv">
                    <i class="far fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;次阅读量</span>
                </span>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#context">Context</a>
      <ul>
        <li><a href="#derived-contexts">Derived contexts</a></li>
      </ul>
    </li>
    <li><a href="#example-google-web-search">Example: Google Web Search</a>
      <ul>
        <li><a href="#the-server-program">The server program</a></li>
        <li><a href="#package-userip">Package userip</a></li>
        <li><a href="#package-google">Package google</a></li>
      </ul>
    </li>
    <li><a href="#adapting-code-for-contexts">Adapting code for Contexts</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="go-concurrency-patterns-context">Go Concurrency Patterns: Context</h1>
<p>Sameer Ajmani<br>
29 July 2014</p>
<h2 id="introduction">Introduction</h2>
<p>In Go servers, each incoming request is handled in its own goroutine. Request handlers often start additional goroutines to access backends such as databases and RPC services. The set of goroutines working on a request typically needs access to request-specific values such as the identity of the end user, authorization tokens, and the request’s deadline. When a request is canceled or times out, all the goroutines working on that request should exit quickly so the system can reclaim any resources they are using.</p>
<p>At Google, we developed a <code>context</code> package that makes it easy to pass request-scoped values, cancellation signals, and deadlines across API boundaries to all the goroutines involved in handling a request. The package is publicly available as <a href="https://go.dev/pkg/context" target="_blank" rel="noopener noreffer">context</a>. This article describes how to use the package and provides a complete working example.</p>
<h2 id="context">Context</h2>
<p>The core of the <code>context</code> package is the <code>Context</code> type:</p>
<p>// A Context carries a deadline, cancellation signal, and request-scoped values
// across API boundaries. Its methods are safe for simultaneous use by multiple
// goroutines.
type Context interface {
// Done returns a channel that is closed when this Context is canceled
// or times out.
Done() &lt;-chan struct{}</p>
<pre><code>// Err indicates why this context was canceled, after the Done channel
// is closed.
Err() error

// Deadline returns the time when this Context will be canceled, if any.
Deadline() (deadline time.Time, ok bool)

// Value returns the value associated with key or nil if none.
Value(key interface{}) interface{}
</code></pre>
<p>}</p>
<p>(This description is condensed; the <a href="https://go.dev/pkg/context" target="_blank" rel="noopener noreffer">godoc</a> is authoritative.)</p>
<p>The <code>Done</code> method returns a channel that acts as a cancellation signal to functions running on behalf of the <code>Context</code>: when the channel is closed, the functions should abandon their work and return. The <code>Err</code> method returns an error indicating why the <code>Context</code> was canceled. The <a href="https://go.dev/blog/pipelines" target="_blank" rel="noopener noreffer">Pipelines and Cancellation</a> article discusses the <code>Done</code> channel idiom in more detail.</p>
<p>A <code>Context</code> does <em>not</em> have a <code>Cancel</code> method for the same reason the <code>Done</code> channel is receive-only: the function receiving a cancellation signal is usually not the one that sends the signal. In particular, when a parent operation starts goroutines for sub-operations, those sub-operations should not be able to cancel the parent. Instead, the <code>WithCancel</code> function (described below) provides a way to cancel a new <code>Context</code> value.</p>
<p>A <code>Context</code> is safe for simultaneous use by multiple goroutines. Code can pass a single <code>Context</code> to any number of goroutines and cancel that <code>Context</code> to signal all of them.</p>
<p>The <code>Deadline</code> method allows functions to determine whether they should start work at all; if too little time is left, it may not be worthwhile. Code may also use a deadline to set timeouts for I/O operations.</p>
<p><code>Value</code> allows a <code>Context</code> to carry request-scoped data. That data must be safe for simultaneous use by multiple goroutines.</p>
<h3 id="derived-contexts">Derived contexts</h3>
<p>The <code>context</code> package provides functions to <em>derive</em> new <code>Context</code> values from existing ones. These values form a tree: when a <code>Context</code> is canceled, all <code>Contexts</code> derived from it are also canceled.</p>
<p><code>Background</code> is the root of any <code>Context</code> tree; it is never canceled:</p>
<p>// Background returns an empty Context. It is never canceled, has no deadline,
// and has no values. Background is typically used in main, init, and tests,
// and as the top-level Context for incoming requests.
func Background() Context</p>
<p><code>WithCancel</code> and <code>WithTimeout</code> return derived <code>Context</code> values that can be canceled sooner than the parent <code>Context</code>. The <code>Context</code> associated with an incoming request is typically canceled when the request handler returns. <code>WithCancel</code> is also useful for canceling redundant requests when using multiple replicas. <code>WithTimeout</code> is useful for setting a deadline on requests to backend servers:</p>
<p>// WithCancel returns a copy of parent whose Done channel is closed as soon as
// parent.Done is closed or cancel is called.
func WithCancel(parent Context) (ctx Context, cancel CancelFunc)</p>
<p>// A CancelFunc cancels a Context.
type CancelFunc func()</p>
<p>// WithTimeout returns a copy of parent whose Done channel is closed as soon as
// parent.Done is closed, cancel is called, or timeout elapses. The new
// Context&rsquo;s Deadline is the sooner of now+timeout and the parent&rsquo;s deadline, if
// any. If the timer is still running, the cancel function releases its
// resources.
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)</p>
<p><code>WithValue</code> provides a way to associate request-scoped values with a <code>Context</code>:</p>
<p>// WithValue returns a copy of parent whose Value method returns val for key.
func WithValue(parent Context, key interface{}, val interface{}) Context</p>
<p>The best way to see how to use the <code>context</code> package is through a worked example.</p>
<h2 id="example-google-web-search">Example: Google Web Search</h2>
<p>Our example is an HTTP server that handles URLs like <code>/search?q=golang&amp;timeout=1s</code> by forwarding the query “golang” to the <a href="https://developers.google.com/web-search/docs/" target="_blank" rel="noopener noreffer">Google Web Search API</a> and rendering the results. The <code>timeout</code> parameter tells the server to cancel the request after that duration elapses.</p>
<p>The code is split across three packages:</p>
<ul>
<li><a href="https://go.dev/blog/context/server/server.go" target="_blank" rel="noopener noreffer">server</a> provides the <code>main</code> function and the handler for <code>/search</code>.</li>
<li><a href="https://go.dev/blog/context/userip/userip.go" target="_blank" rel="noopener noreffer">userip</a> provides functions for extracting a user IP address from a request and associating it with a <code>Context</code>.</li>
<li><a href="https://go.dev/blog/context/google/google.go" target="_blank" rel="noopener noreffer">google</a> provides the <code>Search</code> function for sending a query to Google.</li>
</ul>
<h3 id="the-server-program">The server program</h3>
<p>The <a href="https://go.dev/blog/context/server/server.go" target="_blank" rel="noopener noreffer">server</a> program handles requests like <code>/search?q=golang</code> by serving the first few Google search results for <code>golang</code>. It registers <code>handleSearch</code> to handle the <code>/search</code> endpoint. The handler creates an initial <code>Context</code> called <code>ctx</code> and arranges for it to be canceled when the handler returns. If the request includes the <code>timeout</code> URL parameter, the <code>Context</code> is canceled automatically when the timeout elapses:</p>
<p>func handleSearch(w http.ResponseWriter, req *http.Request) {
// ctx is the Context for this handler. Calling cancel closes the
// ctx.Done channel, which is the cancellation signal for requests
// started by this handler.
var (
ctx    context.Context
cancel context.CancelFunc
)
timeout, err := time.ParseDuration(req.FormValue(&ldquo;timeout&rdquo;))
if err == nil {
// The request has a timeout, so create a context that is
// canceled automatically when the timeout expires.
ctx, cancel = context.WithTimeout(context.Background(), timeout)
} else {
ctx, cancel = context.WithCancel(context.Background())
}
defer cancel() // Cancel ctx as soon as handleSearch returns.</p>
<p>The handler extracts the query from the request and extracts the client’s IP address by calling on the <code>userip</code> package. The client’s IP address is needed for backend requests, so <code>handleSearch</code> attaches it to <code>ctx</code>:</p>
<pre><code>// Check the search query.
query := req.FormValue(&quot;q&quot;)
if query == &quot;&quot; {
    http.Error(w, &quot;no query&quot;, http.StatusBadRequest)
    return
}

// Store the user IP in ctx for use by code in other packages.
userIP, err := userip.FromRequest(req)
if err != nil {
    http.Error(w, err.Error(), http.StatusBadRequest)
    return
}
ctx = userip.NewContext(ctx, userIP)
</code></pre>
<p>The handler calls <code>google.Search</code> with <code>ctx</code> and the <code>query</code>:</p>
<pre><code>// Run the Google search and print the results.
start := time.Now()
results, err := google.Search(ctx, query)
elapsed := time.Since(start)
</code></pre>
<p>If the search succeeds, the handler renders the results:</p>
<pre><code>if err := resultsTemplate.Execute(w, struct {
    Results          google.Results
    Timeout, Elapsed time.Duration
}{
    Results: results,
    Timeout: timeout,
    Elapsed: elapsed,
}); err != nil {
    log.Print(err)
    return
}
</code></pre>
<h3 id="package-userip">Package userip</h3>
<p>The <a href="https://go.dev/blog/context/userip/userip.go" target="_blank" rel="noopener noreffer">userip</a> package provides functions for extracting a user IP address from a request and associating it with a <code>Context</code>. A <code>Context</code> provides a key-value mapping, where the keys and values are both of type <code>interface{}</code>. Key types must support equality, and values must be safe for simultaneous use by multiple goroutines. Packages like <code>userip</code> hide the details of this mapping and provide strongly-typed access to a specific <code>Context</code> value.</p>
<p>To avoid key collisions, <code>userip</code> defines an unexported type <code>key</code> and uses a value of this type as the context key:</p>
<p>// The key type is unexported to prevent collisions with context keys defined in
// other packages.
type key int</p>
<p>// userIPkey is the context key for the user IP address.  Its value of zero is
// arbitrary.  If this package defined other context keys, they would have
// different integer values.
const userIPKey key = 0</p>
<p><code>FromRequest</code> extracts a <code>userIP</code> value from an <code>http.Request</code>:</p>
<p>func FromRequest(req *http.Request) (net.IP, error) {
ip, _, err := net.SplitHostPort(req.RemoteAddr)
if err != nil {
return nil, fmt.Errorf(&ldquo;userip: %q is not IP:port&rdquo;, req.RemoteAddr)
}</p>
<p><code>NewContext</code> returns a new <code>Context</code> that carries a provided <code>userIP</code> value:</p>
<p>func NewContext(ctx context.Context, userIP net.IP) context.Context {
return context.WithValue(ctx, userIPKey, userIP)
}</p>
<p><code>FromContext</code> extracts a <code>userIP</code> from a <code>Context</code>:</p>
<p>func FromContext(ctx context.Context) (net.IP, bool) {
// ctx.Value returns nil if ctx has no value for the key;
// the net.IP type assertion returns ok=false for nil.
userIP, ok := ctx.Value(userIPKey).(net.IP)
return userIP, ok
}</p>
<h3 id="package-google">Package google</h3>
<p>The <a href="https://go.dev/blog/context/google/google.go" target="_blank" rel="noopener noreffer">google.Search</a> function makes an HTTP request to the <a href="https://developers.google.com/web-search/docs/" target="_blank" rel="noopener noreffer">Google Web Search API</a> and parses the JSON-encoded result. It accepts a <code>Context</code> parameter <code>ctx</code> and returns immediately if <code>ctx.Done</code> is closed while the request is in flight.</p>
<p>The Google Web Search API request includes the search query and the user IP as query parameters:</p>
<p>func Search(ctx context.Context, query string) (Results, error) {
// Prepare the Google Search API request.
req, err := http.NewRequest(&ldquo;GET&rdquo;, &ldquo;<a href="https://ajax.googleapis.com/ajax/services/search/web?v=1.0%22," target="_blank" rel="noopener noreffer">https://ajax.googleapis.com/ajax/services/search/web?v=1.0",</a> nil)
if err != nil {
return nil, err
}
q := req.URL.Query()
q.Set(&ldquo;q&rdquo;, query)</p>
<pre><code>// If ctx is carrying the user IP address, forward it to the server.
// Google APIs use the user IP to distinguish server-initiated requests
// from end-user requests.
if userIP, ok := userip.FromContext(ctx); ok {
    q.Set(&quot;userip&quot;, userIP.String())
}
req.URL.RawQuery = q.Encode()
</code></pre>
<p><code>Search</code> uses a helper function, <code>httpDo</code>, to issue the HTTP request and cancel it if <code>ctx.Done</code> is closed while the request or response is being processed. <code>Search</code> passes a closure to <code>httpDo</code> handle the HTTP response:</p>
<pre><code>var results Results
err = httpDo(ctx, req, func(resp \*http.Response, err error) error {
    if err != nil {
        return err
    }
    defer resp.Body.Close()

    // Parse the JSON search result.
    // https://developers.google.com/web-search/docs/#fonje
    var data struct {
        ResponseData struct {
            Results \[\]struct {
                TitleNoFormatting string
                URL               string
            }
        }
    }
    if err := json.NewDecoder(resp.Body).Decode(&amp;data); err != nil {
        return err
    }
    for \_, res := range data.ResponseData.Results {
        results = append(results, Result{Title: res.TitleNoFormatting, URL: res.URL})
    }
    return nil
})
// httpDo waits for the closure we provided to return, so it's safe to
// read results here.
return results, err
</code></pre>
<p>The <code>httpDo</code> function runs the HTTP request and processes its response in a new goroutine. It cancels the request if <code>ctx.Done</code> is closed before the goroutine exits:</p>
<p>func httpDo(ctx context.Context, req *http.Request, f func(*http.Response, error) error) error {
// Run the HTTP request in a goroutine and pass the response to f.
c := make(chan error, 1)
req = req.WithContext(ctx)
go func() { c &lt;- f(http.DefaultClient.Do(req)) }()
select {
case &lt;-ctx.Done():
&lt;-c // Wait for f to return.
return ctx.Err()
case err := &lt;-c:
return err
}
}</p>
<h2 id="adapting-code-for-contexts">Adapting code for Contexts</h2>
<p>Many server frameworks provide packages and types for carrying request-scoped values. We can define new implementations of the <code>Context</code> interface to bridge between code using existing frameworks and code that expects a <code>Context</code> parameter.</p>
<p>For example, Gorilla’s <a href="http://www.gorillatoolkit.org/pkg/context" target="_blank" rel="noopener noreffer">github.com/gorilla/context</a> package allows handlers to associate data with incoming requests by providing a mapping from HTTP requests to key-value pairs. In <a href="https://go.dev/blog/context/gorilla/gorilla.go" target="_blank" rel="noopener noreffer">gorilla.go</a>, we provide a <code>Context</code> implementation whose <code>Value</code> method returns the values associated with a specific HTTP request in the Gorilla package.</p>
<p>Other packages have provided cancellation support similar to <code>Context</code>. For example, <a href="https://godoc.org/gopkg.in/tomb.v2" target="_blank" rel="noopener noreffer">Tomb</a> provides a <code>Kill</code> method that signals cancellation by closing a <code>Dying</code> channel. <code>Tomb</code> also provides methods to wait for those goroutines to exit, similar to <code>sync.WaitGroup</code>. In <a href="https://go.dev/blog/context/tomb/tomb.go" target="_blank" rel="noopener noreffer">tomb.go</a>, we provide a <code>Context</code> implementation that is canceled when either its parent <code>Context</code> is canceled or a provided <code>Tomb</code> is killed.</p>
<h2 id="conclusion">Conclusion</h2>
<p>At Google, we require that Go programmers pass a <code>Context</code> parameter as the first argument to every function on the call path between incoming and outgoing requests. This allows Go code developed by many different teams to interoperate well. It provides simple control over timeouts and cancellation and ensures that critical values like security credentials transit Go programs properly.</p>
<p>Server frameworks that want to build on <code>Context</code> should provide implementations of <code>Context</code> to bridge between their packages and those that expect a <code>Context</code> parameter. Their client libraries would then accept a <code>Context</code> from the calling code. By establishing a common interface for request-scoped data and cancellation, <code>Context</code> makes it easier for package developers to share code for creating scalable services.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-10-29 00:00:00</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://jefofrank.xyz/gb_20140729/" data-title="Gb_20140729" data-hashtags="go official blogs"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://jefofrank.xyz/gb_20140729/" data-hashtag="go official blogs"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://jefofrank.xyz/gb_20140729/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://jefofrank.xyz/gb_20140729/" data-title="Gb_20140729"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://jefofrank.xyz/gb_20140729/" data-title="Gb_20140729"><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://jefofrank.xyz/gb_20140729/" data-title="Gb_20140729"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/go-official-blogs/">go official blogs</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/gb_20140715/" class="prev" rel="prev" title="Gb_20140715"><i class="fas fa-angle-left fa-fw"></i>Gb_20140715</a>
            <a href="/gb_20140820/" class="next" rel="next" title="Gb_20140820">Gb_20140820<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/jf-011101" target="_blank">Jefo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href="https://beian.miit.gov.cn/">赣ICP备2022007470号-1</a></span></br>
                <span id="busuanzi_container_site_pv">
                    访问量 <span id="busuanzi_value_site_pv"></span> 次
                </span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_uv">
                    访客数 <span id="busuanzi_value_site_uv"></span> 人次
                </span>
                </br><script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = 2021;
                        var startMonth = 3;
                        var startDate = 27;
                        var startHour = 19;
                        var startMinute = 15;
                        var startSecond = 11;
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }
                    setInterval(siteTime, 1000);
                </script>
                    <span id="sitetime">载入运行时间...</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://jefos-blog.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"data":{"id-1":"绿叶律动","id-2":"绿叶律动"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"J0OW8CCKJZ","algoliaIndex":"JF-2","algoliaSearchKey":"3b4a19e831c95174aca4c03fcdf95f5c","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
