<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title> - 绿叶律动</title><meta name="Description" content="绿叶律动"><meta property="og:title" content="" />
<meta property="og:description" content="管理 Kubernetes 对象 用声明式和命令式范型与 Kubernetes API 交互。 使用配置文件对 Kubernetes 对象进行声明式管理 你可以通过在一个目录中存储多个对象配置文件、并使用 kubectl apply 来递归地创" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" /><meta property="og:image" content="https://jefofrank.xyz/logo.png"/><meta property="article:section" content="posts" />



<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://jefofrank.xyz/logo.png"/>

<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="管理 Kubernetes 对象 用声明式和命令式范型与 Kubernetes API 交互。 使用配置文件对 Kubernetes 对象进行声明式管理 你可以通过在一个目录中存储多个对象配置文件、并使用 kubectl apply 来递归地创"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" /><link rel="prev" href="https://jefofrank.xyz/%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" /><link rel="next" href="https://jefofrank.xyz/%E7%9B%91%E6%8E%A7%E6%97%A5%E5%BF%97%E8%B0%83%E8%AF%95/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/jefofrank.xyz\/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets\/"
        },"image": ["https:\/\/jefofrank.xyz\/images\/Apple-Devices-Preview.png"],"genre": "posts","wordcount":  21974 ,
        "url": "https:\/\/jefofrank.xyz\/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets\/","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "Jefo","logo": "https:\/\/jefofrank.xyz\/images\/avatar.png"},"author": {
                "@type": "Person",
                "name": "Jefo"
            },"description": ""
    }
    </script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-193031966-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-193031966-2');
</script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> All posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="绿叶律动"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="直接搜索更方便^-^" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">All posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="https://github.com/jf-011101" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX"></h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/jf-011101" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jefo</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="0001-01-01 00:00:00">0001-01-01 00:00:00</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 21974 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 44 分钟&nbsp;<span id="busuanzi_container_page_pv">
                    <i class="far fa-eye fa-fw"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;次阅读量</span>
                </span>
            </div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#使用配置文件对-kubernetes-对象进行声明式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-config"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/">使用配置文件对 Kubernetes 对象进行声明式管理</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#权衡取舍httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configtrade-offs">权衡取舍<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#trade-offs"></a></a></li>
        <li><a href="#概览httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configoverview">概览<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#overview"></a></a></li>
        <li><a href="#如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-create-objects">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-create-objects"></a></a></li>
        <li><a href="#如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-update-objects">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-update-objects"></a></a></li>
        <li><a href="#如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-delete-objects">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-delete-objects"></a></a>
          <ul>
            <li><a href="#建议操作kubectl-delete--f-文件名httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5bbbae8aeaee6938de4bd9c-kubectl-delete-f-e69687e4bbb6e5908d">建议操作：<code>kubectl delete -f &lt;文件名&gt;</code><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%BB%BA%E8%AE%AE%E6%93%8D%E4%BD%9C-kubectl-delete-f-%E6%96%87%E4%BB%B6%E5%90%8D"></a></a></li>
            <li><a href="#替代方式kubectl-apply--f-目录名称---prune--l-yourlabelhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige69bbfe4bba3e696b9e5bc8f-kubectl-apply-f-e79baee5bd95e5908de7a7b0-prune-l-your-label">替代方式：<code>kubectl apply -f &lt;目录名称/&gt; --prune -l your=label</code><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E6%9B%BF%E4%BB%A3%E6%96%B9%E5%BC%8F-kubectl-apply-f-%E7%9B%AE%E5%BD%95%E5%90%8D%E7%A7%B0-prune-l-your-label"></a></a></li>
          </ul>
        </li>
        <li><a href="#如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-view-an-object">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-view-an-object"></a></a></li>
        <li><a href="#apply-操作是如何计算配置差异并合并变更的httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configapply-e6938de4bd9ce698afe5a682e4bd95e8aea1e7ae97e9858de7bdaee5b7aee5bc82e5b9b6e59088e5b9b6e58f98e69bb4e79a84">apply 操作是如何计算配置差异并合并变更的？<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#apply-%E6%93%8D%E4%BD%9C%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E9%85%8D%E7%BD%AE%E5%B7%AE%E5%BC%82%E5%B9%B6%E5%90%88%E5%B9%B6%E5%8F%98%E6%9B%B4%E7%9A%84"></a></a>
          <ul>
            <li><a href="#合并补丁计算httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configmerge-patch-calculation">合并补丁计算<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#merge-patch-calculation"></a></a></li>
            <li><a href="#不同类型字段的合并方式httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4b88de5908ce7b1bbe59e8be5ad97e6aeb5e79a84e59088e5b9b6e696b9e5bc8f">不同类型字段的合并方式<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%88%E5%B9%B6%E6%96%B9%E5%BC%8F"></a></a></li>
            <li><a href="#合并对基本类型字段的更新httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e5afb9e59fbae69cace7b1bbe59e8be5ad97e6aeb5e79a84e69bb4e696b0">合并对基本类型字段的更新<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%AF%B9%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E6%9B%B4%E6%96%B0"></a></a></li>
            <li><a href="#合并对-map-字段的变更httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e5afb9-map-e5ad97e6aeb5e79a84e58f98e69bb4">合并对 map 字段的变更<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%AF%B9-map-%E5%AD%97%E6%AE%B5%E7%9A%84%E5%8F%98%E6%9B%B4"></a></a></li>
            <li><a href="#合并-list-类型字段的变更httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6-list-e7b1bbe59e8be5ad97e6aeb5e79a84e58f98e69bb4">合并 list 类型字段的变更<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6-list-%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E5%8F%98%E6%9B%B4"></a></a>
              <ul>
                <li><a href="#如果-list-中元素都是基本类型则替换整个-listhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e69e9c-list-e4b8ade58583e7b4a0e983bde698afe59fbae69cace7b1bbe59e8be58899e69bbfe68da2e695b4e4b8aa-list">如果 list 中元素都是基本类型则替换整个 list<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E6%9E%9C-list-%E4%B8%AD%E5%85%83%E7%B4%A0%E9%83%BD%E6%98%AF%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%88%99%E6%9B%BF%E6%8D%A2%E6%95%B4%E4%B8%AA-list"></a></a></li>
                <li><a href="#如果-list-中元素为复合类型则逐个执行合并httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e69e9c-list-e4b8ade58583e7b4a0e4b8bae5a48de59088e7b1bbe59e8be58899e98090e4b8aae689a7e8a18ce59088e5b9b6">如果 list 中元素为复合类型则逐个执行合并<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E6%9E%9C-list-%E4%B8%AD%E5%85%83%E7%B4%A0%E4%B8%BA%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%E5%88%99%E9%80%90%E4%B8%AA%E6%89%A7%E8%A1%8C%E5%90%88%E5%B9%B6"></a></a></li>
                <li><a href="#合并基本类型元素-listhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e59fbae69cace7b1bbe59e8be58583e7b4a0-list">合并基本类型元素 list<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%85%83%E7%B4%A0-list"></a></a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#默认字段值httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configdefault-field-values">默认字段值<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#default-field-values"></a></a>
          <ul>
            <li><a href="#如何清除服务器端按默认值设置的字段或者被其他写者设置的字段httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e4bd95e6b885e999a4e69c8de58aa1e599a8e7abafe68c89e9bb98e8aea4e580bce8aebee7bdaee79a84e5ad97e6aeb5e68896e88085e8a2abe585b6e4bb96e58699e88085e8aebee7bdaee79a84e5ad97e6aeb5">如何清除服务器端按默认值设置的字段或者被其他写者设置的字段<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E4%BD%95%E6%B8%85%E9%99%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%8C%89%E9%BB%98%E8%AE%A4%E5%80%BC%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AD%97%E6%AE%B5%E6%88%96%E8%80%85%E8%A2%AB%E5%85%B6%E4%BB%96%E5%86%99%E8%80%85%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AD%97%E6%AE%B5"></a></a></li>
          </ul>
        </li>
        <li><a href="#如何将字段的属主在配置文件和直接指令式写者之间切换httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e4bd95e5b086e5ad97e6aeb5e79a84e5b19ee4b8bbe59ca8e9858de7bdaee69687e4bbb6e5928ce79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085e4b98be997b4e58887e68da2">如何将字段的属主在配置文件和直接指令式写者之间切换<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%97%E6%AE%B5%E7%9A%84%E5%B1%9E%E4%B8%BB%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85%E4%B9%8B%E9%97%B4%E5%88%87%E6%8D%A2"></a></a>
          <ul>
            <li><a href="#将属主从直接指令式写者更改为配置文件httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5b086e5b19ee4b8bbe4bb8ee79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085e69bb4e694b9e4b8bae9858de7bdaee69687e4bbb6">将属主从直接指令式写者更改为配置文件<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%B0%86%E5%B1%9E%E4%B8%BB%E4%BB%8E%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85%E6%9B%B4%E6%94%B9%E4%B8%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"></a></a></li>
            <li><a href="#将属主从配置文件改为直接指令式写者httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5b086e5b19ee4b8bbe4bb8ee9858de7bdaee69687e4bbb6e694b9e4b8bae79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085">将属主从配置文件改为直接指令式写者<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%B0%86%E5%B1%9E%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%B9%E4%B8%BA%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85"></a></a></li>
          </ul>
        </li>
        <li><a href="#更改管理方法httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configchanging-management-methods">更改管理方法<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#changing-management-methods"></a></a>
          <ul>
            <li><a href="#从指令式命令管理切换到声明式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4bb8ee68c87e4bba4e5bc8fe591bde4bba4e7aea1e79086e58887e68da2e588b0e5a3b0e6988ee5bc8fe5afb9e8b1a1e9858de7bdae">从指令式命令管理切换到声明式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%BB%8E%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%91%BD%E4%BB%A4%E7%AE%A1%E7%90%86%E5%88%87%E6%8D%A2%E5%88%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE"></a></a></li>
            <li><a href="#从指令式对象配置切换到声明式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4bb8ee68c87e4bba4e5bc8fe5afb9e8b1a1e9858de7bdaee58887e68da2e588b0e5a3b0e6988ee5bc8fe5afb9e8b1a1e9858de7bdae">从指令式对象配置切换到声明式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%BB%8E%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE%E5%88%87%E6%8D%A2%E5%88%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE"></a></a></li>
          </ul>
        </li>
        <li><a href="#定义控制器选择算符和-podtemplate-标签httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5ae9ae4b989e68ea7e588b6e599a8e98089e68ba9e7ae97e7aca6e5928c-podtemplate-e6a087e7adbe">定义控制器选择算符和 PodTemplate 标签<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E5%92%8C-podtemplate-%E6%A0%87%E7%AD%BE"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用-kustomize-对-kubernetes-对象进行声明式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomization"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/">使用 Kustomize 对 Kubernetes 对象进行声明式管理</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#kustomize-概述httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationoverview-of-kustomize">Kustomize 概述<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#overview-of-kustomize"></a></a>
          <ul>
            <li><a href="#生成资源httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationgenerating-resources">生成资源<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#generating-resources"></a></a>
              <ul>
                <li><a href="#configmapgeneratorhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationconfigmapgenerator">configMapGenerator<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#configmapgenerator"></a></a></li>
                <li><a href="#secretgeneratorhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationsecretgenerator">secretGenerator<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#secretgenerator"></a></a></li>
                <li><a href="#generatoroptionshttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationgeneratoroptions">generatorOptions<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#generatoroptions"></a></a></li>
              </ul>
            </li>
            <li><a href="#设置贯穿性字段httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationsetting-cross-cutting-fields">设置贯穿性字段<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#setting-cross-cutting-fields"></a></a></li>
            <li><a href="#组织和定制资源httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcomposing-and-customizing-resources">组织和定制资源<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#composing-and-customizing-resources"></a></a>
              <ul>
                <li><a href="#组织httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcomposing">组织<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#composing"></a></a></li>
                <li><a href="#定制httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcustomizing">定制<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#customizing"></a></a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#基准bases与覆盖overlayshttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione59fbae58786-bases-e4b88ee8a686e79b96-overlays">基准（Bases）与覆盖（Overlays）<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%9F%BA%E5%87%86-bases-%E4%B8%8E%E8%A6%86%E7%9B%96-overlays"></a></a></li>
        <li><a href="#如何使用-kustomize-来应用查看和删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione5a682e4bd95e4bdbfe794a8-kustomize-e69da5e5ba94e794a8-e69fa5e79c8be5928ce588a0e999a4e5afb9e8b1a1">如何使用 Kustomize 来应用、查看和删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-kustomize-%E6%9D%A5%E5%BA%94%E7%94%A8-%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1"></a></a></li>
        <li><a href="#kustomize-功能特性列表httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationkustomize-feature-list">Kustomize 功能特性列表<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#kustomize-feature-list"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用指令式命令管理-kubernetes-对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-command"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/">使用指令式命令管理 Kubernetes 对象</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commande58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#权衡取舍httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandtrade-offs">权衡取舍<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#trade-offs"></a></a></li>
        <li><a href="#如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-create-objects">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-create-objects"></a></a></li>
        <li><a href="#如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-update-objects">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-update-objects"></a></a></li>
        <li><a href="#如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-delete-objects">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-delete-objects"></a></a></li>
        <li><a href="#如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-view-an-object">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-view-an-object"></a></a></li>
        <li><a href="#使用-set-命令在创建对象之前修改对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandusing-set-commands-to-modify-objects-before-creation">使用 <code>set</code> 命令在创建对象之前修改对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#using-set-commands-to-modify-objects-before-creation"></a></a></li>
        <li><a href="#在创建之前使用---edit-更改对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandusing-edit-to-modify-objects-before-creation">在创建之前使用 <code>--edit</code> 更改对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#using-edit-to-modify-objects-before-creation"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commande68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用配置文件对-kubernetes-对象进行命令式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-config"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/">使用配置文件对 Kubernetes 对象进行命令式管理</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#权衡httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige69d83e8a1a1">权衡<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E6%9D%83%E8%A1%A1"></a></a></li>
        <li><a href="#如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e5889be5bbbae5afb9e8b1a1">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1"></a></a></li>
        <li><a href="#如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e69bb4e696b0e5afb9e8b1a1">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0%E5%AF%B9%E8%B1%A1"></a></a></li>
        <li><a href="#如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e588a0e999a4e5afb9e8b1a1">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1"></a></a></li>
        <li><a href="#如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e69fa5e79c8be5afb9e8b1a1">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1"></a></a></li>
        <li><a href="#局限性httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5b180e99990e680a7">局限性<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%B1%80%E9%99%90%E6%80%A7"></a></a></li>
        <li><a href="#从-url-创建和编辑对象而不保存配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige4bb8e-url-e5889be5bbbae5928ce7bc96e8be91e5afb9e8b1a1e8808ce4b88de4bf9de5ad98e9858de7bdae">从 URL 创建和编辑对象而不保存配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E4%BB%8E-url-%E5%88%9B%E5%BB%BA%E5%92%8C%E7%BC%96%E8%BE%91%E5%AF%B9%E8%B1%A1%E8%80%8C%E4%B8%8D%E4%BF%9D%E5%AD%98%E9%85%8D%E7%BD%AE"></a></a></li>
        <li><a href="#从命令式命令迁移到命令式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige4bb8ee591bde4bba4e5bc8fe591bde4bba4e8bf81e7a7bbe588b0e591bde4bba4e5bc8fe5afb9e8b1a1e9858de7bdae">从命令式命令迁移到命令式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E4%BB%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%91%BD%E4%BB%A4%E8%BF%81%E7%A7%BB%E5%88%B0%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE"></a></a></li>
        <li><a href="#定义控制器选择器和-podtemplate-标签httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5ae9ae4b989e68ea7e588b6e599a8e98089e68ba9e599a8e5928c-podtemplate-e6a087e7adbe">定义控制器选择器和 PodTemplate 标签<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8%E9%80%89%E6%8B%A9%E5%99%A8%E5%92%8C-podtemplate-%E6%A0%87%E7%AD%BE"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用-kubectl-patch-更新-api-对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patch"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/">使用 kubectl patch 更新 API 对象</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patche58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#使用策略合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-a-strategic-merge-patch-to-update-a-deployment">使用策略合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-strategic-merge-patch-to-update-a-deployment"></a></a>
          <ul>
            <li><a href="#策略性合并类的-patch-的说明httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchnotes-on-the-strategic-merge-patch">策略性合并类的 patch 的说明<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#notes-on-the-strategic-merge-patch"></a></a></li>
          </ul>
        </li>
        <li><a href="#使用-json-合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-a-json-merge-patch-to-update-a-deployment">使用 JSON 合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-json-merge-patch-to-update-a-deployment"></a></a></li>
        <li><a href="#使用带-retainkeys-策略的策略合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy">使用带 retainKeys 策略的策略合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy"></a></a>
          <ul>
            <li><a href="#关于使用-retainkeys-策略的策略合并-patch-操作的说明httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchnotes-on-the-strategic-merge-patch-using-the-retainkeys-strategy">关于使用 retainKeys 策略的策略合并 patch 操作的说明<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#notes-on-the-strategic-merge-patch-using-the-retainkeys-strategy"></a></a></li>
            <li><a href="#kubectl-patch-命令的其他形式httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchalternate-forms-of-the-kubectl-patch-command">kubectl patch 命令的其他形式<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#alternate-forms-of-the-kubectl-patch-command"></a></a></li>
            <li><a href="#使用-kubectl-patch-和---subresource-更新一个对象的副本数httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchscale-kubectl-patch">使用 <code>kubectl patch</code> 和 <code>--subresource</code> 更新一个对象的副本数<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#scale-kubectl-patch"></a></a></li>
          </ul>
        </li>
        <li><a href="#总结httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchsummary">总结<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#summary"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patche68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#使用-kubectl-管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectl"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/">使用 kubectl 管理 Secret</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlcreate-a-secret">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret"></a></a>
          <ul>
            <li><a href="#使用原始数据httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle4bdbfe794a8e58e9fe5a78be695b0e68dae">使用原始数据<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE"></a></a></li>
            <li><a href="#使用源文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle4bdbfe794a8e6ba90e69687e4bbb6">使用源文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E4%BD%BF%E7%94%A8%E6%BA%90%E6%96%87%E4%BB%B6"></a></a></li>
          </ul>
        </li>
        <li><a href="#验证-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlverify-the-secret">验证 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret"></a></a>
          <ul>
            <li><a href="#解码-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectldecoding-secret">解码 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret"></a></a></li>
          </ul>
        </li>
        <li><a href="#编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectledit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#edit-secret"></a></a></li>
        <li><a href="#清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#clean-up"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用配置文件管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-file"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/">使用配置文件管理 Secret</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filee58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filecreate-the-config-file">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#create-the-config-file"></a></a>
          <ul>
            <li><a href="#创建-secret-时提供未编码的数据httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filespecify-unencoded-data-when-creating-a-secret">创建 Secret 时提供未编码的数据<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#specify-unencoded-data-when-creating-a-secret"></a></a></li>
            <li><a href="#同时指定-data-和-stringdatahttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filespecifying-both-data-and-stringdata">同时指定 <code>data</code> 和 <code>stringData</code><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#specifying-both-data-and-stringdata"></a></a></li>
          </ul>
        </li>
        <li><a href="#编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-fileedit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#edit-secret"></a></a></li>
        <li><a href="#清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-fileclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#clean-up"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filee68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
    <li><a href="#使用-kustomize-管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomize"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/">使用 Kustomize 管理 Secret</a></a>
      <ul>
        <li><a href="#准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizee58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B"></a></a></li>
        <li><a href="#创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizecreate-a-secret">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#create-a-secret"></a></a>
          <ul>
            <li><a href="#创建-kustomization-文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizecreate-the-kustomization-file">创建 Kustomization 文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#create-the-kustomization-file"></a></a></li>
            <li><a href="#应用-kustomization-文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeapply-the-kustomization-file">应用 kustomization 文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#apply-the-kustomization-file"></a></a></li>
          </ul>
        </li>
        <li><a href="#编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeedit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#edit-secret"></a></a></li>
        <li><a href="#清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#clean-up"></a></a></li>
        <li><a href="#接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizee68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#%E6%8E%A5%E4%B8%8B%E6%9D%A5"></a></a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="管理-kubernetes-对象">管理 Kubernetes 对象</h1>
<p>用声明式和命令式范型与 Kubernetes API 交互。</p>
<hr>
<h2 id="使用配置文件对-kubernetes-对象进行声明式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-config"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行声明式管理</a></h2>
<p>你可以通过在一个目录中存储多个对象配置文件、并使用 <code>kubectl apply</code> 来递归地创建和更新对象来创建、更新和删除 Kubernetes 对象。 这种方法会保留对现有对象已作出的修改，而不会将这些更改写回到对象配置文件中。 <code>kubectl diff</code> 也会给你呈现 <code>apply</code> 将作出的变更的预览。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>安装 <a href="https://kubernetes.io/zh-cn/docs/tasks/tools/" target="_blank" rel="noopener noreffer"><code>kubectl</code></a>。</p>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<p>要获知版本信息，请输入 <code>kubectl version</code>.</p>
<h3 id="权衡取舍httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configtrade-offs">权衡取舍<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#trade-offs" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>kubectl</code> 工具能够支持三种对象管理方式：</p>
<ul>
<li>指令式命令</li>
<li>指令式对象配置</li>
<li>声明式对象配置</li>
</ul>
<p>关于每种对象管理的优缺点的讨论，可参见 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noopener noreffer">Kubernetes 对象管理</a>。</p>
<h3 id="概览httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configoverview">概览<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#overview" target="_blank" rel="noopener noreffer"></a></h3>
<p>声明式对象管理需要用户对 Kubernetes 对象定义和配置有比较深刻的理解。 如果你还没有这方面的知识储备，请先阅读下面的文档：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/" target="_blank" rel="noopener noreffer">使用指令式命令管理 Kubernetes 对象</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行指令式管理</a></li>
</ul>
<p>以下是本文档中使用的术语的定义：</p>
<ul>
<li><em>对象配置文件/配置文件</em>：一个定义 Kubernetes 对象的配置的文件。 本主题展示如何将配置文件传递给 <code>kubectl apply</code>。 配置文件通常存储于类似 Git 这种源码控制系统中。</li>
<li><em>现时对象配置/现时配置</em>：由 Kubernetes 集群所观测到的对象的现时配置值。 这些配置保存在 Kubernetes 集群存储（通常是 etcd）中。</li>
<li><em>声明式配置写者/声明式写者</em>：负责更新现时对象的人或者软件组件。 本主题中的声明式写者负责改变对象配置文件并执行 <code>kubectl apply</code> 命令 以写入变更。</li>
</ul>
<h3 id="如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-create-objects">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-create-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p>使用 <code>kubectl apply</code> 来创建指定目录中配置文件所定义的所有对象，除非对应对象已经存在：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f &lt;目录&gt;/
</code></pre></td></tr></table>
</div>
</div><p>此操作会在每个对象上设置 <code>kubectl.kubernetes.io/last-applied-configuration: '{...}'</code> 注解。注解值中包含了用来创建对象的配置文件的内容。</p>
<p><strong>说明：</strong> 添加 <code>-R</code> 标志可以递归地处理目录。</p>
<p>下面是一个对象配置文件示例：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/simple_deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/simple_deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/simple_deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/simple_deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl diff</code> 可以打印出将被创建的对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl diff -f https://k8s.io/examples/application/simple_deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong></p>
<p><code>diff</code> 使用<a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#dry-run" target="_blank" rel="noopener noreffer">服务器端试运行（Server-side Dry-run）</a> 功能特性；而该功能特性需要在 <code>kube-apiserver</code> 上启用。</p>
<p>由于 <code>diff</code> 操作会使用试运行模式执行服务器端 apply 请求，因此需要为 用户配置 <code>PATCH</code>、<code>CREATE</code> 和 <code>UPDATE</code> 操作权限。 参阅<a href="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts#dry-run-authorization" target="_blank" rel="noopener noreffer">试运行授权</a> 了解详情。</p>
<p>使用 <code>kubectl apply</code> 来创建对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl get</code> 打印其现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示注解 <code>kubectl.kubernetes.io/last-applied-configuration</code> 被写入到 现时配置中，并且其内容与配置文件相同：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># This is the json representation of simple_deployment.yaml</span><span class="w">
</span><span class="w">    </span><span class="c"># It was written by kubectl apply when the object was created</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-update-objects">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-update-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p>你也可以使用 <code>kubectl apply</code> 来更新某个目录中定义的所有对象，即使那些对象已经存在。 这一操作会隐含以下行为：</p>
<ol>
<li>在现时配置中设置配置文件中出现的字段；</li>
<li>在现时配置中清除配置文件中已删除的字段。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl diff -f &lt;目录&gt;/
kubectl apply -f &lt;目录&gt;/
</code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong> 使用 <code>-R</code> 标志递归处理目录。</p>
<p>下面是一个配置文件示例：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/simple_deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/simple_deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/simple_deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/simple_deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl apply</code> 来创建对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong> 出于演示的目的，上面的命令引用的是单个文件而不是整个目录。</p>
<p>使用 <code>kubectl get</code> 打印现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示，注解 <code>kubectl.kubernetes.io/last-applied-configuration</code> 被写入到 现时配置中，并且其取值与配置文件内容相同。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># 此为 simple_deployment.yaml 的 JSON 表示</span><span class="w">
</span><span class="w">    </span><span class="c"># 在对象创建时由 kubectl apply 命令写入</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>通过 <code>kubectl scale</code> 命令直接更新现时配置中的 <code>replicas</code> 字段。 这一命令没有使用 <code>kubectl apply</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl scale deployment/nginx-deployment --replicas<span class="o">=</span><span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl get</code> 来打印现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment nginx-deployment -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示，<code>replicas</code> 字段已经被设置为 2，而 <code>last-applied-configuration</code> 注解中 并不包含 <code>replicas</code> 字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># 注意注解中并不包含 replicas</span><span class="w">
</span><span class="w">    </span><span class="c"># 这是因为更新并不是通过 kubectl apply 来执行的</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># written by scale</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>现在更新 <code>simple_deployment.yaml</code> 配置文件，将镜像文件从 <code>nginx:1.14.2</code> 更改为 <code>nginx:1.16.1</code>，同时删除<code>minReadySeconds</code> 字段：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/update_deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/update_deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/update_deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/update_deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16.1</span><span class="w"> </span><span class="c"># 更新该镜像</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>应用对配置文件所作更改：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl diff -f https://k8s.io/examples/application/update_deployment.yaml
kubectl apply -f https://k8s.io/examples/application/update_deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl get</code> 打印现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -f https://k8s.io/examples/application/update_deployment.yaml -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示现时配置中发生了以下更改：</p>
<ul>
<li>字段 <code>replicas</code> 保留了 <code>kubectl scale</code> 命令所设置的值：2； 之所以该字段被保留是因为配置文件中并没有设置 <code>replicas</code>。</li>
<li>字段 <code>image</code> 的内容已经从 <code>nginx:1.14.2</code> 更改为 <code>nginx:1.16.1</code>。</li>
<li>注解 <code>last-applied-configuration</code> 内容被更改为新的镜像名称。</li>
<li>字段 <code>minReadySeconds</code> 被移除。</li>
<li>注解 <code>last-applied-configuration</code> 中不再包含 <code>minReadySeconds</code> 字段。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># 注解中包含更新后的镜像 nginx 1.16.1</span><span class="w">
</span><span class="w">    </span><span class="c"># 但是其中并不包含更改后的 replicas 值 2</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.16.1&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 由 `kubectl scale` 设置，被 `kubectl apply` 命令忽略</span><span class="w">
</span><span class="w">  </span><span class="c"># minReadySeconds 被 `kubectl apply` 清除</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16.1</span><span class="w"> </span><span class="c"># 由 `kubectl apply` 设置</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>警告：</strong> 将 <code>kubectl apply</code> 与指令式对象配置命令 <code>kubectl create</code> 或 <code>kubectl replace</code> 混合使用是不受支持的。这是因为 <code>create</code> 和 <code>replace</code> 命令都不会保留 <code>kubectl apply</code> 用来计算更新内容所使用的 <code>kubectl.kubernetes.io/last-applied-configuration</code> 注解值。</p>
<h3 id="如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-delete-objects">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-delete-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p>有两种方法来删除 <code>kubectl apply</code> 管理的对象。</p>
<h4 id="建议操作kubectl-delete--f-文件名httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5bbbae8aeaee6938de4bd9c-kubectl-delete-f-e69687e4bbb6e5908d">建议操作：<code>kubectl delete -f &lt;文件名&gt;</code><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%BB%BA%E8%AE%AE%E6%93%8D%E4%BD%9C-kubectl-delete-f-%E6%96%87%E4%BB%B6%E5%90%8D" target="_blank" rel="noopener noreffer"></a></h4>
<p>使用指令式命令来手动删除对象是建议的方法，因为这种方法更为明确地给出了 要删除的内容是什么，且不容易造成用户不小心删除了其他对象的情况。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete -f &lt;文件名&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="替代方式kubectl-apply--f-目录名称---prune--l-yourlabelhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige69bbfe4bba3e696b9e5bc8f-kubectl-apply-f-e79baee5bd95e5908de7a7b0-prune-l-your-label">替代方式：<code>kubectl apply -f &lt;目录名称/&gt; --prune -l your=label</code><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E6%9B%BF%E4%BB%A3%E6%96%B9%E5%BC%8F-kubectl-apply-f-%E7%9B%AE%E5%BD%95%E5%90%8D%E7%A7%B0-prune-l-your-label" target="_blank" rel="noopener noreffer"></a></h4>
<p>只有在充分理解此命令背后含义的情况下才建议这样操作。</p>
<p><strong>警告：</strong> <code>kubectl apply --prune</code> 命令本身仍处于 Alpha 状态，在后续发布版本中可能会 引入一些向后不兼容的变化。</p>
<p><strong>警告：</strong></p>
<p>在使用此命令时必须小心，这样才不会无意中删除不想删除的对象。</p>
<p>作为 <code>kubectl delete</code> 操作的替代方式，你可以在目录中对象配置文件被删除之后， 使用 <code>kubectl apply</code> 来辩识要删除的对象。 带 <code>--prune</code> 标志的 <code>apply</code> 命令会首先查询 API 服务器，获得与某组标签相匹配 的对象列表，之后将返回的现时对象配置与目录中的对象配置文件相比较。 如果某对象在查询中被匹配到，但在目录中没有文件与其相对应，并且其中还包含 <code>last-applied-configuration</code> 注解，则该对象会被删除。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f &lt;directory/&gt; --prune -l &lt;labels&gt;
</code></pre></td></tr></table>
</div>
</div><p><strong>警告：</strong> 带剪裁（prune）行为的 <code>apply</code> 操作应在包含对象配置文件的目录的根目录运行。 如果在其子目录中运行，可能导致对象被不小心删除。 因为某些对象可能与 <code>-l &lt;标签&gt;</code> 的标签选择算符匹配，但其配置文件不在当前 子目录下。</p>
<h3 id="如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confighow-to-view-an-object">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#how-to-view-an-object" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以使用 <code>kubectl get</code> 并指定 <code>-o yaml</code> 选项来查看现时对象的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -f &lt;文件名 <span class="p">|</span> URL&gt; -o yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="apply-操作是如何计算配置差异并合并变更的httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configapply-e6938de4bd9ce698afe5a682e4bd95e8aea1e7ae97e9858de7bdaee5b7aee5bc82e5b9b6e59088e5b9b6e58f98e69bb4e79a84">apply 操作是如何计算配置差异并合并变更的？<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#apply-%E6%93%8D%E4%BD%9C%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E9%85%8D%E7%BD%AE%E5%B7%AE%E5%BC%82%E5%B9%B6%E5%90%88%E5%B9%B6%E5%8F%98%E6%9B%B4%E7%9A%84" target="_blank" rel="noopener noreffer"></a></h3>
<p><strong>注意：</strong> <em>patch</em> 是一种更新操作，其作用域为对象的一些特定字段而不是整个对象。 这使得你可以更新对象的特定字段集合而不必先要读回对象。</p>
<p><code>kubectl apply</code> 更新对象的现时配置，它是通过向 API 服务器发送一个 patch 请求 来执行更新动作的。 所提交的补丁中定义了对现时对象配置中特定字段的更新。 <code>kubectl apply</code> 命令会使用当前的配置文件、现时配置以及现时配置中保存的 <code>last-applied-configuration</code> 注解内容来计算补丁更新内容。</p>
<h4 id="合并补丁计算httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configmerge-patch-calculation">合并补丁计算<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#merge-patch-calculation" target="_blank" rel="noopener noreffer"></a></h4>
<p><code>kubectl apply</code> 命令将配置文件的内容写入到 <code>kubectl.kubernetes.io/last-applied-configuration</code> 注解中。 这些内容用来识别配置文件中已经移除的、因而也需要从现时配置中删除的字段。 用来计算要删除或设置哪些字段的步骤如下：</p>
<ol>
<li>计算要删除的字段，即在 <code>last-applied-configuration</code> 中存在但在 配置文件中不再存在的字段。</li>
<li>计算要添加或设置的字段，即在配置文件中存在但其取值与现时配置不同的字段。</li>
</ol>
<p>下面是一个例子。假定此文件是某 Deployment 对象的配置文件：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/update_deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/update_deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/update_deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/update_deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16.1</span><span class="w"> </span><span class="c"># 更新该镜像</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>同时假定同一 Deployment 对象的现时配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># 注意注解中并不包含 replicas</span><span class="w">
</span><span class="w">    </span><span class="c"># 这是因为更新并不是通过 kubectl apply 来执行的</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;minReadySeconds&#34;:5,&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.14.2&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># written by scale</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>下面是 <code>kubectl apply</code> 将执行的合并计算：</p>
<ol>
<li>通过读取 <code>last-applied-configuration</code> 并将其与配置文件中的值相比较， 计算要删除的字段。 对于本地对象配置文件中显式设置为空的字段，清除其在现时配置中的设置， 无论这些字段是否出现在 <code>last-applied-configuration</code> 中。 在此例中，<code>minReadySeconds</code> 出现在 <code>last-applied-configuration</code> 注解中，但 并不存在于配置文件中。 <strong>动作：</strong> 从现时配置中删除 <code>minReadySeconds</code> 字段。</li>
<li>通过读取配置文件中的值并将其与现时配置相比较，计算要设置的字段。 在这个例子中，配置文件中的 <code>image</code> 值与现时配置中的 <code>image</code> 不匹配。 <strong>动作</strong>：设置现时配置中的 <code>image</code> 值。</li>
<li>设置 <code>last-applied-configuration</code> 注解的内容，使之与配置文件匹配。</li>
<li>将第 1、2、3 步骤得出的结果合并，构成向 API 服务器发送的补丁请求内容。</li>
</ol>
<p>下面是此合并操作之后形成的现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># 注解中包含更新后的镜像 nginx 1.16.1,</span><span class="w">
</span><span class="w">    </span><span class="c"># 但是其中并不包含更改后的 replicas 值 2</span><span class="w">
</span><span class="w">    </span><span class="nt">kubectl.kubernetes.io/last-applied-configuration</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      {&#34;apiVersion&#34;:&#34;apps/v1&#34;,&#34;kind&#34;:&#34;Deployment&#34;,
</span><span class="sd">      &#34;metadata&#34;:{&#34;annotations&#34;:{},&#34;name&#34;:&#34;nginx-deployment&#34;,&#34;namespace&#34;:&#34;default&#34;},
</span><span class="sd">      &#34;spec&#34;:{&#34;selector&#34;:{&#34;matchLabels&#34;:{&#34;app&#34;:nginx}},&#34;template&#34;:{&#34;metadata&#34;:{&#34;labels&#34;:{&#34;app&#34;:&#34;nginx&#34;}},
</span><span class="sd">      &#34;spec&#34;:{&#34;containers&#34;:[{&#34;image&#34;:&#34;nginx:1.16.1&#34;,&#34;name&#34;:&#34;nginx&#34;,
</span><span class="sd">      &#34;ports&#34;:[{&#34;containerPort&#34;:80}]}]}}}}      </span><span class="w">      
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 由 `kubectl scale` 设置，被 `kubectl apply` 命令忽略</span><span class="w">
</span><span class="w">  </span><span class="c"># minReadySeconds  此字段被`kubectl apply`清除</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16.1</span><span class="w"> </span><span class="c"># 由 `kubectl apply` 设置</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span><span class="w">      </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="不同类型字段的合并方式httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4b88de5908ce7b1bbe59e8be5ad97e6aeb5e79a84e59088e5b9b6e696b9e5bc8f">不同类型字段的合并方式<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%88%E5%B9%B6%E6%96%B9%E5%BC%8F" target="_blank" rel="noopener noreffer"></a></h4>
<p>配置文件中的特定字段与现时配置合并时，合并方式取决于字段类型。 字段类型有几种：</p>
<ul>
<li>
<p><em>基本类型</em>：字段类型为 <code>string</code>、<code>integer</code> 或 <code>boolean</code> 之一。 例如：<code>image</code> 和 <code>replicas</code> 字段都是基本类型字段。</p>
<p><strong>动作：</strong> 替换。</p>
</li>
<li>
<p><em>map</em>：也称作 <em>object</em>。类型为 <code>map</code> 或包含子域的复杂结构。例如，<code>labels</code>、 <code>annotations</code>、<code>spec</code> 和 <code>metadata</code> 都是 map。</p>
<p><strong>动作：</strong> 合并元素或子字段。</p>
</li>
<li>
<p><em>list</em>：包含元素列表的字段，其中每个元素可以是基本类型或 map。 例如，<code>containers</code>、<code>ports</code> 和 <code>args</code> 都是 list。</p>
<p><strong>动作：</strong> 不一定。</p>
</li>
</ul>
<p>当 <code>kubectl apply</code> 更新某个 map 或 list 字段时，它通常不会替换整个字段，而是会 更新其中的各个子元素。例如，当合并 Deployment 的 <code>spec</code> 时，<code>kubectl</code> 并不会 将其整个替换掉。相反，实际操作会是对 <code>replicas</code> 这类 <code>spec</code> 的子字段来执行比较和更新。</p>
<h4 id="合并对基本类型字段的更新httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e5afb9e59fbae69cace7b1bbe59e8be5ad97e6aeb5e79a84e69bb4e696b0">合并对基本类型字段的更新<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%AF%B9%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E6%9B%B4%E6%96%B0" target="_blank" rel="noopener noreffer"></a></h4>
<p>基本类型字段会被替换或清除。</p>
<p><strong>说明：</strong> <code>-</code> 表示的是“不适用”，因为指定数值未被使用。</p>
<table>
<thead>
<tr>
<th>字段在对象配置文件中</th>
<th>字段在现时对象配置中</th>
<th>字段在 <code>last-applied-configuration</code> 中</th>
<th>动作</th>
</tr>
</thead>
<tbody>
<tr>
<td>是</td>
<td>是</td>
<td>-</td>
<td>将配置文件中值设置到现时配置上。</td>
</tr>
<tr>
<td>是</td>
<td>否</td>
<td>-</td>
<td>将配置文件中值设置到现时配置上。</td>
</tr>
<tr>
<td>否</td>
<td>-</td>
<td>是</td>
<td>从现时配置中移除。</td>
</tr>
<tr>
<td>否</td>
<td>-</td>
<td>否</td>
<td>什么也不做。保持现时值。</td>
</tr>
</tbody>
</table>
<h4 id="合并对-map-字段的变更httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e5afb9-map-e5ad97e6aeb5e79a84e58f98e69bb4">合并对 map 字段的变更<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%AF%B9-map-%E5%AD%97%E6%AE%B5%E7%9A%84%E5%8F%98%E6%9B%B4" target="_blank" rel="noopener noreffer"></a></h4>
<p>用来表示映射的字段在合并时会逐个子字段或元素地比较：</p>
<p><strong>说明：</strong> <code>-</code> 表示的是“不适用”，因为指定数值未被使用。</p>
<table>
<thead>
<tr>
<th>键存在于对象配置文件中</th>
<th>键存在于现时对象配置中</th>
<th>键存在于 <code>last-applied-configuration</code> 中</th>
<th>动作</th>
</tr>
</thead>
<tbody>
<tr>
<td>是</td>
<td>是</td>
<td>-</td>
<td>比较子域取值。</td>
</tr>
<tr>
<td>是</td>
<td>否</td>
<td>-</td>
<td>将现时配置设置为本地配置值。</td>
</tr>
<tr>
<td>否</td>
<td>-</td>
<td>是</td>
<td>从现时配置中删除键。</td>
</tr>
<tr>
<td>否</td>
<td>-</td>
<td>否</td>
<td>什么也不做，保留现时值。</td>
</tr>
</tbody>
</table>
<h4 id="合并-list-类型字段的变更httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6-list-e7b1bbe59e8be5ad97e6aeb5e79a84e58f98e69bb4">合并 list 类型字段的变更<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6-list-%E7%B1%BB%E5%9E%8B%E5%AD%97%E6%AE%B5%E7%9A%84%E5%8F%98%E6%9B%B4" target="_blank" rel="noopener noreffer"></a></h4>
<p>对 list 类型字段的变更合并会使用以下三种策略之一：</p>
<ul>
<li>如果 list 所有元素都是基本类型则替换整个 list。</li>
<li>如果 list 中元素是复合结构则逐个元素执行合并操作。</li>
<li>合并基本类型元素构成的 list。</li>
</ul>
<p>策略的选择是基于各个字段做出的。</p>
<h5 id="如果-list-中元素都是基本类型则替换整个-listhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e69e9c-list-e4b8ade58583e7b4a0e983bde698afe59fbae69cace7b1bbe59e8be58899e69bbfe68da2e695b4e4b8aa-list">如果 list 中元素都是基本类型则替换整个 list<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E6%9E%9C-list-%E4%B8%AD%E5%85%83%E7%B4%A0%E9%83%BD%E6%98%AF%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%88%99%E6%9B%BF%E6%8D%A2%E6%95%B4%E4%B8%AA-list" target="_blank" rel="noopener noreffer"></a></h5>
<p>将整个 list 视为一个基本类型字段。或者整个替换或者整个删除。 此操作会保持 list 中元素顺序不变</p>
<p><strong>示例：</strong> 使用 <code>kubectl apply</code> 来更新 Pod 中 Container 的 <code>args</code> 字段。此操作会 将现时配置中的 <code>args</code> 值设为配置文件中的值。 所有之前添加到现时配置中的 <code>args</code> 元素都会丢失。 配置文件中的 <code>args</code> 元素的顺序在被添加到现时配置中时保持不变。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># last-applied-configuration 值</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;b&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 配置文件值</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;c&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 现时配置</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;b&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;d&#34;</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 合并结果</span><span class="w">
</span><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;c&#34;</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>解释：</strong> 合并操作将配置文件中的值当做新的 list 值。</p>
<h5 id="如果-list-中元素为复合类型则逐个执行合并httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e69e9c-list-e4b8ade58583e7b4a0e4b8bae5a48de59088e7b1bbe59e8be58899e98090e4b8aae689a7e8a18ce59088e5b9b6">如果 list 中元素为复合类型则逐个执行合并<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E6%9E%9C-list-%E4%B8%AD%E5%85%83%E7%B4%A0%E4%B8%BA%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B%E5%88%99%E9%80%90%E4%B8%AA%E6%89%A7%E8%A1%8C%E5%90%88%E5%B9%B6" target="_blank" rel="noopener noreffer"></a></h5>
<p>此操作将 list 视为 map，并将每个元素中的特定字段当做其主键。 逐个元素地执行添加、删除或更新操作。结果顺序无法得到保证。</p>
<p>此合并策略会使用每个字段上的一个名为 <code>patchMergeKey</code> 的特殊标签。 Kubernetes 源代码中为每个字段定义了 <code>patchMergeKey</code>： <a href="https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2747" target="_blank" rel="noopener noreffer">types.go</a> 当合并由 map 组成的 list 时，给定元素中被设置为 <code>patchMergeKey</code> 的字段会被 当做该元素的 map 键值来使用。</p>
<p><strong>例如：</strong> 使用 <code>kubectl apply</code> 来更新 Pod 规约中的 <code>containers</code> 字段。 此操作会将 <code>containers</code> 列表视作一个映射来执行合并，每个元素的主键为 <code>name</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># last-applied-configuration 值</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-a</span><span class="w"> </span><span class="c"># 键 nginx-helper-a 会被删除</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-b</span><span class="w"> </span><span class="c"># 键 nginx-helper-b 会被保留</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 配置文件值</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-b</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-c</span><span class="w"> </span><span class="c"># 键 nginx-helper-c 会被添加</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 现时配置</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-a</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-b</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;run&#34;</span><span class="p">]</span><span class="w">        </span><span class="c"># 字段会被保留</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-d</span><span class="w"> </span><span class="c"># 键 nginx-helper-d 会被保留</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 合并结果</span><span class="w">
</span><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.16</span><span class="w">
</span><span class="w">      </span><span class="c"># 元素 nginx-helper-a 被删除</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-b</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;run&#34;</span><span class="p">]</span><span class="w">        </span><span class="c"># 字段被保留</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-c</span><span class="w"> </span><span class="c"># 新增元素</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-helper-d</span><span class="w"> </span><span class="c"># 此元素被忽略（保留）</span><span class="w">
</span><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">helper:1.3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>解释：</strong></p>
<ul>
<li>名为 &ldquo;nginx-helper-a&rdquo; 的容器被删除，因为配置文件中不存在同名的容器。</li>
<li>名为 &ldquo;nginx-helper-b&rdquo; 的容器的现时配置中的 <code>args</code> 被保留。 <code>kubectl apply</code> 能够辩识出现时配置中的容器 &ldquo;nginx-helper-b&rdquo; 与配置文件 中的容器 &ldquo;nginx-helper-b&rdquo; 相同，即使它们的字段值有些不同（配置文件中未给定 <code>args</code> 值）。这是因为 <code>patchMergeKey</code> 字段（name）的值在两个版本中都一样。</li>
<li>名为 &ldquo;nginx-helper-c&rdquo; 的容器是新增的，因为在配置文件中的这个容器尚不存在 于现时配置中。</li>
<li>名为 &ldquo;nginx-helper-d&rdquo; 的容器被保留下来，因为在 last-applied-configuration 中没有与之同名的元素。</li>
</ul>
<h5 id="合并基本类型元素-listhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige59088e5b9b6e59fbae69cace7b1bbe59e8be58583e7b4a0-list">合并基本类型元素 list<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%90%88%E5%B9%B6%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E5%85%83%E7%B4%A0-list" target="_blank" rel="noopener noreffer"></a></h5>
<p>在 Kubernetes 1.5 中，尚不支持对由基本类型元素构成的 list 进行合并。</p>
<p><strong>说明：</strong> 选择上述哪种策略是由源码中给定字段的 <code>patchStrategy</code> 标记来控制的： <a href="https://github.com/kubernetes/api/blob/d04500c8c3dda9c980b668c57abc2ca61efcf5c4/core/v1/types.go#L2748" target="_blank" rel="noopener noreffer">types.go</a> 如果 list 类型字段未设置 <code>patchStrategy</code>，则整个 list 会被替换掉。</p>
<h3 id="默认字段值httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configdefault-field-values">默认字段值<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#default-field-values" target="_blank" rel="noopener noreffer"></a></h3>
<p>API 服务器会在对象创建时其中某些字段未设置的情况下在现时配置中为其设置默认值。</p>
<p>下面是一个 Deployment 的配置文件。文件未设置 <code>strategy</code>：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/simple_deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/simple_deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/simple_deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/simple_deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl apply</code> 创建对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/simple_deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>kubectl get</code> 打印现时配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -f https://k8s.io/examples/application/simple_deployment.yaml -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示 API 在现时配置中为某些字段设置了默认值。 这些字段在配置文件中并未设置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="c"># ...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">           </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">      </span><span class="c"># API 服务器基于 strategy.type 所设默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent   </span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">          </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP      </span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span>{}<span class="w">         </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">        </span><span class="nt">terminationMessagePath</span><span class="p">:</span><span class="w"> </span><span class="l">/dev/termination-log   </span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterFirst      </span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always        </span><span class="w"> </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w"> </span>{}<span class="w">           </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">        </span><span class="c"># API 服务器所设默认值</span><span class="w">
</span><span class="w"></span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在补丁请求中，已经设置了默认值的字段不会被重新设回其默认值，除非 在补丁请求中显式地要求清除。对于默认值取决于其他字段的某些字段而言， 这可能会引发一些意想不到的行为。当所依赖的其他字段后来发生改变时， 基于它们所设置的默认值只能在显式执行清除操作时才会被更新。</p>
<p>为此，建议在配置文件中为服务器设置默认值的字段显式提供定义，即使所 给的定义与服务器端默认值设定相同。这样可以使得辩识无法被服务器重新 基于默认值来设置的冲突字段变得容易。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># last-applied-configuration</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 配置文件</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate  </span><span class="w"> </span><span class="c"># 更新的值</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 现时配置</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate   </span><span class="w"> </span><span class="c"># 默认设置的值</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">         </span><span class="c"># 基于 type 设置的默认值</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge </span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 合并后的结果 - 出错！</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate    </span><span class="w"> </span><span class="c"># 更新的值：与 rollingUpdate 不兼容</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">     </span><span class="c"># 默认设置的值：与 &#34;type: Recreate&#34; 冲突</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge </span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>解释：</strong></p>
<ol>
<li>用户创建 Deployment，未设置 <code>strategy.type</code>。</li>
<li>服务器为 <code>strategy.type</code> 设置默认值 <code>RollingUpdate</code>，并为 <code>strategy.rollingUpdate</code> 设置默认值。</li>
<li>用户改变 <code>strategy.type</code> 为 <code>Recreate</code>。字段 <code>strategy.rollingUpdate</code> 仍会取其 默认设置值，尽管服务器期望该字段被清除。 如果 <code>strategy.rollingUpdate</code> 值最初于配置文件中定义，则它们需要被清除 这一点就更明确一些。</li>
<li><code>apply</code> 操作失败，因为 <code>strategy.rollingUpdate</code> 未被清除。 <code>strategy.rollingupdate</code> 在 <code>strategy.type</code> 为 <code>Recreate</code> 不可被设定。</li>
</ol>
<p>建议：以下字段应该在对象配置文件中显式定义：</p>
<ul>
<li>如 Deployment、StatefulSet、Job、DaemonSet、ReplicaSet 和 ReplicationController 这类负载的选择算符和 <code>PodTemplate</code> 标签</li>
<li>Deployment 的上线策略</li>
</ul>
<h4 id="如何清除服务器端按默认值设置的字段或者被其他写者设置的字段httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e4bd95e6b885e999a4e69c8de58aa1e599a8e7abafe68c89e9bb98e8aea4e580bce8aebee7bdaee79a84e5ad97e6aeb5e68896e88085e8a2abe585b6e4bb96e58699e88085e8aebee7bdaee79a84e5ad97e6aeb5">如何清除服务器端按默认值设置的字段或者被其他写者设置的字段<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E4%BD%95%E6%B8%85%E9%99%A4%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%8C%89%E9%BB%98%E8%AE%A4%E5%80%BC%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AD%97%E6%AE%B5%E6%88%96%E8%80%85%E8%A2%AB%E5%85%B6%E4%BB%96%E5%86%99%E8%80%85%E8%AE%BE%E7%BD%AE%E7%9A%84%E5%AD%97%E6%AE%B5" target="_blank" rel="noopener noreffer"></a></h4>
<p>没有出现在配置文件中的字段可以通过将其值设置为 <code>null</code> 并应用配置文件来清除。 对于由服务器按默认值设置的字段，清除操作会触发重新为字段设置新的默认值。</p>
<h3 id="如何将字段的属主在配置文件和直接指令式写者之间切换httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5a682e4bd95e5b086e5ad97e6aeb5e79a84e5b19ee4b8bbe59ca8e9858de7bdaee69687e4bbb6e5928ce79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085e4b98be997b4e58887e68da2">如何将字段的属主在配置文件和直接指令式写者之间切换<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%A6%82%E4%BD%95%E5%B0%86%E5%AD%97%E6%AE%B5%E7%9A%84%E5%B1%9E%E4%B8%BB%E5%9C%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85%E4%B9%8B%E9%97%B4%E5%88%87%E6%8D%A2" target="_blank" rel="noopener noreffer"></a></h3>
<p>更改某个对象字段时，应该采用下面的方法：</p>
<ul>
<li>使用 <code>kubectl apply</code>.</li>
<li>直接写入到现时配置，但不更改配置文件本身，例如使用 <code>kubectl scale</code>。</li>
</ul>
<h4 id="将属主从直接指令式写者更改为配置文件httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5b086e5b19ee4b8bbe4bb8ee79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085e69bb4e694b9e4b8bae9858de7bdaee69687e4bbb6">将属主从直接指令式写者更改为配置文件<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%B0%86%E5%B1%9E%E4%B8%BB%E4%BB%8E%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85%E6%9B%B4%E6%94%B9%E4%B8%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" target="_blank" rel="noopener noreffer"></a></h4>
<p>将字段添加到配置文件。针对该字段，不再直接执行对现时配置的修改。 修改均通过 <code>kubectl apply</code> 来执行。</p>
<h4 id="将属主从配置文件改为直接指令式写者httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5b086e5b19ee4b8bbe4bb8ee9858de7bdaee69687e4bbb6e694b9e4b8bae79bb4e68ea5e68c87e4bba4e5bc8fe58699e88085">将属主从配置文件改为直接指令式写者<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%B0%86%E5%B1%9E%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%B9%E4%B8%BA%E7%9B%B4%E6%8E%A5%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%86%99%E8%80%85" target="_blank" rel="noopener noreffer"></a></h4>
<p>在 Kubernetes 1.5 中，将字段的属主从配置文件切换到某指令式写者需要手动 执行以下步骤：</p>
<ul>
<li>从配置文件中删除该字段；</li>
<li>将字段从现时对象的 <code>kubectl.kubernetes.io/last-applied-configuration</code> 注解 中删除。</li>
</ul>
<h3 id="更改管理方法httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-configchanging-management-methods">更改管理方法<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#changing-management-methods" target="_blank" rel="noopener noreffer"></a></h3>
<p>Kubernetes 对象在同一时刻应该只用一种方法来管理。 从一种方法切换到另一种方法是可能的，但这一切换是一个手动过程。</p>
<p><strong>说明：</strong> 在声明式管理方法中使用指令式命令来删除对象是可以的。</p>
<h4 id="从指令式命令管理切换到声明式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4bb8ee68c87e4bba4e5bc8fe591bde4bba4e7aea1e79086e58887e68da2e588b0e5a3b0e6988ee5bc8fe5afb9e8b1a1e9858de7bdae">从指令式命令管理切换到声明式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%BB%8E%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%91%BD%E4%BB%A4%E7%AE%A1%E7%90%86%E5%88%87%E6%8D%A2%E5%88%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreffer"></a></h4>
<p>从指令式命令管理切换到声明式对象配置管理的切换包含以下几个手动步骤：</p>
<ol>
<li>
<p>将现时对象导出到本地配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>手动移除配置文件中的 <code>status</code> 字段。</p>
<p><strong>说明：</strong> 这一步骤是可选的，因为 <code>kubectl apply</code> 并不会更新 status 字段，即便 配置文件中包含 status 字段。</p>
</li>
<li>
<p>设置对象上的 <code>kubectl.kubernetes.io/last-applied-configuration</code> 注解：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>更改过程，使用 <code>kubectl apply</code> 专门管理对象。</p>
</li>
</ol>
<h4 id="从指令式对象配置切换到声明式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige4bb8ee68c87e4bba4e5bc8fe5afb9e8b1a1e9858de7bdaee58887e68da2e588b0e5a3b0e6988ee5bc8fe5afb9e8b1a1e9858de7bdae">从指令式对象配置切换到声明式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E4%BB%8E%E6%8C%87%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE%E5%88%87%E6%8D%A2%E5%88%B0%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreffer"></a></h4>
<ol>
<li>
<p>在对象上设置 <code>kubectl.kubernetes.io/last-applied-configuration</code> 注解：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl replace --save-config -f &lt;kind&gt;_&lt;name&gt;.yaml
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>自此排他性地使用 <code>kubectl apply</code> 来管理对象。</p>
</li>
</ol>
<h3 id="定义控制器选择算符和-podtemplate-标签httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige5ae9ae4b989e68ea7e588b6e599a8e98089e68ba9e7ae97e7aca6e5928c-podtemplate-e6a087e7adbe">定义控制器选择算符和 PodTemplate 标签<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8%E9%80%89%E6%8B%A9%E7%AE%97%E7%AC%A6%E5%92%8C-podtemplate-%E6%A0%87%E7%AD%BE" target="_blank" rel="noopener noreffer"></a></h3>
<p><strong>警告：</strong> 强烈不建议更改控制器上的选择算符。</p>
<p>建议的方法是定义一个不可变更的 PodTemplate 标签，仅用于控制器选择算符且 不包含其他语义性的含义。</p>
<p><strong>示例：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">controller-selector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps/v1/deployment/nginx&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">controller-selector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps/v1/deployment/nginx&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsdeclarative-confige68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/" target="_blank" rel="noopener noreffer">使用指令式命令管理 Kubernetes 对象</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象执行指令式管理</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/" target="_blank" rel="noopener noreffer">Kubectl 命令参考</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/" target="_blank" rel="noopener noreffer">Kubernetes API 参考</a></li>
</ul>
<h2 id="使用-kustomize-对-kubernetes-对象进行声明式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomization"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/" target="_blank" rel="noopener noreffer">使用 Kustomize 对 Kubernetes 对象进行声明式管理</a></h2>
<p><a href="https://github.com/kubernetes-sigs/kustomize" target="_blank" rel="noopener noreffer">Kustomize</a> 是一个独立的工具，用来通过 <a href="https://kubectl.docs.kubernetes.io/references/kustomize/glossary/#kustomization" target="_blank" rel="noopener noreffer">kustomization 文件</a> 定制 Kubernetes 对象。</p>
<p>从 1.14 版本开始，<code>kubectl</code> 也开始支持使用 kustomization 文件来管理 Kubernetes 对象。 要查看包含 kustomization 文件的目录中的资源，执行下面的命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl kustomize &lt;kustomization_directory&gt;
</code></pre></td></tr></table>
</div>
</div><p>要应用这些资源，使用 <code>--kustomize</code> 或 <code>-k</code> 参数来执行 <code>kubectl apply</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -k &lt;kustomization_directory&gt;
</code></pre></td></tr></table>
</div>
</div><h3 id="准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>安装 <a href="https://kubernetes.io/zh-cn/docs/tasks/tools/" target="_blank" rel="noopener noreffer"><code>kubectl</code></a>。</p>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<p>要获知版本信息，请输入 <code>kubectl version</code>.</p>
<h3 id="kustomize-概述httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationoverview-of-kustomize">Kustomize 概述<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#overview-of-kustomize" target="_blank" rel="noopener noreffer"></a></h3>
<p>Kustomize 是一个用来定制 Kubernetes 配置的工具。它提供以下功能特性来管理应用配置文件：</p>
<ul>
<li>从其他来源生成资源</li>
<li>为资源设置贯穿性（Cross-Cutting）字段</li>
<li>组织和定制资源集合</li>
</ul>
<h4 id="生成资源httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationgenerating-resources">生成资源<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#generating-resources" target="_blank" rel="noopener noreffer"></a></h4>
<p>ConfigMap 和 Secret 包含其他 Kubernetes 对象（如 Pod）所需要的配置或敏感数据。 ConfigMap 或 Secret 中数据的来源往往是集群外部，例如某个 <code>.properties</code> 文件或者 SSH 密钥文件。 Kustomize 提供 <code>secretGenerator</code> 和 <code>configMapGenerator</code>，可以基于文件或字面值来生成 Secret 和 ConfigMap。</p>
<h5 id="configmapgeneratorhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationconfigmapgenerator">configMapGenerator<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#configmapgenerator" target="_blank" rel="noopener noreffer"></a></h5>
<p>要基于文件来生成 ConfigMap，可以在 <code>configMapGenerator</code> 的 <code>files</code> 列表中添加表项。 下面是一个根据 <code>.properties</code> 文件中的数据条目来生成 ConfigMap 的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 生成一个  application.properties 文件</span>
cat <span class="s">&lt;&lt;EOF &gt;application.properties
</span><span class="s">FOO=Bar
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">configMapGenerator:
</span><span class="s">- name: example-configmap-1
</span><span class="s">  files:
</span><span class="s">  - application.properties
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>所生成的 ConfigMap 可以使用下面的命令来检查：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl kustomize ./
</code></pre></td></tr></table>
</div>
</div><p>所生成的 ConfigMap 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application.properties</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        </span><span class="w">        </span><span class="l">FOO=Bar</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1-8mbdf7882g</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>要从 env 文件生成 ConfigMap，请在 <code>configMapGenerator</code> 中的 <code>envs</code> 列表中添加一个条目。 下面是一个用来自 <code>.env</code> 文件的数据生成 ConfigMap 的例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 .env 文件</span>
cat <span class="s">&lt;&lt;EOF &gt;.env
</span><span class="s">FOO=Bar
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">configMapGenerator:
</span><span class="s">- name: example-configmap-1
</span><span class="s">  envs:
</span><span class="s">  - .env
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>可以使用以下命令检查生成的 ConfigMap：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl kustomize ./
</code></pre></td></tr></table>
</div>
</div><p>生成的 ConfigMap 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">FOO</span><span class="p">:</span><span class="w"> </span><span class="l">Bar</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1-42cfbf598f</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong></p>
<p><code>.env</code> 文件中的每个变量在生成的 ConfigMap 中成为一个单独的键。这与之前的示例不同， 前一个示例将一个名为 <code>application.properties</code> 的文件（及其所有条目）嵌入到同一个键的值中。</p>
<p>ConfigMap 也可基于字面的键值偶对来生成。要基于键值偶对来生成 ConfigMap， 在 <code>configMapGenerator</code> 的 <code>literals</code> 列表中添加表项。下面是一个例子， 展示如何使用键值偶对中的数据条目来生成 ConfigMap 对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">configMapGenerator:
</span><span class="s">- name: example-configmap-2
</span><span class="s">  literals:
</span><span class="s">  - FOO=Bar
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>可以用下面的命令检查所生成的 ConfigMap：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl kustomize ./
</code></pre></td></tr></table>
</div>
</div><p>所生成的 ConfigMap 为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">FOO</span><span class="p">:</span><span class="w"> </span><span class="l">Bar</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-2-g2hdhfc6tk</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>要在 Deployment 中使用生成的 ConfigMap，使用 configMapGenerator 的名称对其进行引用。 Kustomize 将自动使用生成的名称替换该名称。</p>
<p>这是使用生成的 ConfigMap 的 deployment 示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># 创建一个 application.properties 文件</span><span class="w">
</span><span class="w"></span><span class="l">cat &lt;&lt;EOF &gt;application.properties</span><span class="w">
</span><span class="w"></span><span class="l">FOO=Bar</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">cat &lt;&lt;EOF &gt;deployment.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/config</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="l">cat &lt;&lt;EOF &gt;./kustomization.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="l">deployment.yaml</span><span class="w">
</span><span class="w"></span><span class="nt">configMapGenerator</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1</span><span class="w">
</span><span class="w">  </span><span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">application.properties</span><span class="w">
</span><span class="w"></span><span class="l">EOF</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>生成 ConfigMap 和 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl kustomize ./
</code></pre></td></tr></table>
</div>
</div><p>生成的 Deployment 将通过名称引用生成的 ConfigMap：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application.properties</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">        </span><span class="w">        </span><span class="l">FOO=Bar</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1-g4hk9g2ff8</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/config</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-1-g4hk9g2ff8</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h5 id="secretgeneratorhttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationsecretgenerator">secretGenerator<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#secretgenerator" target="_blank" rel="noopener noreffer"></a></h5>
<p>你可以基于文件或者键值偶对来生成 Secret。要使用文件内容来生成 Secret， 在 <code>secretGenerator</code> 下面的 <code>files</code> 列表中添加表项。 下面是一个根据文件中数据来生成 Secret 对象的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 password.txt 文件</span>
cat <span class="s">&lt;&lt;EOF &gt;./password.txt
</span><span class="s">username=admin
</span><span class="s">password=secret
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">secretGenerator:
</span><span class="s">- name: example-secret-1
</span><span class="s">  files:
</span><span class="s">  - password.txt
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>所生成的 Secret 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">password.txt</span><span class="p">:</span><span class="w"> </span><span class="l">dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg==</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-secret-1-t2kt65hgtb</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>要基于键值偶对字面值生成 Secret，先要在 <code>secretGenerator</code> 的 <code>literals</code> 列表中添加表项。下面是基于键值偶对中数据条目来生成 Secret 的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">secretGenerator:
</span><span class="s">- name: example-secret-2
</span><span class="s">  literals:
</span><span class="s">  - username=admin
</span><span class="s">  - password=secret
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>所生成的 Secret 如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">c2VjcmV0</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-secret-2-t52t6g96d8</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>与 ConfigMap 一样，生成的 Secret 可以通过引用 secretGenerator 的名称在 Deployment 中使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 password.txt 文件</span>
cat <span class="s">&lt;&lt;EOF &gt;./password.txt
</span><span class="s">username=admin
</span><span class="s">password=secret
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-app
</span><span class="s">  labels:
</span><span class="s">    app: my-app
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      app: my-app
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        app: my-app
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: app
</span><span class="s">        image: my-app
</span><span class="s">        volumeMounts:
</span><span class="s">        - name: password
</span><span class="s">          mountPath: /secrets
</span><span class="s">      volumes:
</span><span class="s">      - name: password
</span><span class="s">        secret:
</span><span class="s">          secretName: example-secret-1
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">secretGenerator:
</span><span class="s">- name: example-secret-1
</span><span class="s">  files:
</span><span class="s">  - password.txt
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="generatoroptionshttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationgeneratoroptions">generatorOptions<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#generatoroptions" target="_blank" rel="noopener noreffer"></a></h5>
<p>所生成的 ConfigMap 和 Secret 都会包含内容哈希值后缀。 这是为了确保内容发生变化时，所生成的是新的 ConfigMap 或 Secret。 要禁止自动添加后缀的行为，用户可以使用 <code>generatorOptions</code>。 除此以外，为生成的 ConfigMap 和 Secret 指定贯穿性选项也是可以的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">configMapGenerator:
</span><span class="s">- name: example-configmap-3
</span><span class="s">  literals:
</span><span class="s">  - FOO=Bar
</span><span class="s">generatorOptions:
</span><span class="s">  disableNameSuffixHash: true
</span><span class="s">  labels:
</span><span class="s">    type: generated
</span><span class="s">  annotations:
</span><span class="s">    note: generated
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>运行 <code>kubectl kustomize ./</code> 来查看所生成的 ConfigMap：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">FOO</span><span class="p">:</span><span class="w"> </span><span class="l">Bar</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">note</span><span class="p">:</span><span class="w"> </span><span class="l">generated</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">generated</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-configmap-3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="设置贯穿性字段httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationsetting-cross-cutting-fields">设置贯穿性字段<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#setting-cross-cutting-fields" target="_blank" rel="noopener noreffer"></a></h4>
<p>在项目中为所有 Kubernetes 对象设置贯穿性字段是一种常见操作。 贯穿性字段的一些使用场景如下：</p>
<ul>
<li>为所有资源设置相同的名字空间</li>
<li>为所有对象添加相同的前缀或后缀</li>
<li>为对象添加相同的标签集合</li>
<li>为对象添加相同的注解集合</li>
</ul>
<p>下面是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 deployment.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt;./deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: nginx-deployment
</span><span class="s">  labels:
</span><span class="s">    app: nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      app: nginx
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        app: nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: nginx
</span><span class="s">        image: nginx
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">namespace: my-namespace
</span><span class="s">namePrefix: dev-
</span><span class="s">nameSuffix: &#34;-001&#34;
</span><span class="s">commonLabels:
</span><span class="s">  app: bingo
</span><span class="s">commonAnnotations:
</span><span class="s">  oncallPager: 800-555-1212
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl kustomize ./</code> 查看这些字段都被设置到 Deployment 资源上：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">oncallPager</span><span class="p">:</span><span class="w"> </span><span class="m">800-555-1212</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">bingo</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-nginx-deployment-001</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">my-namespace</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">bingo</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">oncallPager</span><span class="p">:</span><span class="w"> </span><span class="m">800-555-1212</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">bingo</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="组织和定制资源httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcomposing-and-customizing-resources">组织和定制资源<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#composing-and-customizing-resources" target="_blank" rel="noopener noreffer"></a></h4>
<p>一种常见的做法是在项目中构造资源集合并将其放到同一个文件或目录中管理。 Kustomize 提供基于不同文件来组织资源并向其应用补丁或者其他定制的能力。</p>
<h5 id="组织httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcomposing">组织<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#composing" target="_blank" rel="noopener noreffer"></a></h5>
<p>Kustomize 支持组合不同的资源。<code>kustomization.yaml</code> 文件的 <code>resources</code> 字段定义配置中要包含的资源列表。 你可以将 <code>resources</code> 列表中的路径设置为资源配置文件的路径。 下面是由 Deployment 和 Service 构成的 NGINX 应用的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建 deployment.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>

<span class="c1"># 创建 service.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; service.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">  labels:
</span><span class="s">    run: my-nginx
</span><span class="s">spec:
</span><span class="s">  ports:
</span><span class="s">  - port: 80
</span><span class="s">    protocol: TCP
</span><span class="s">  selector:
</span><span class="s">    run: my-nginx
</span><span class="s">EOF</span>

<span class="c1"># 创建 kustomization.yaml 来组织以上两个资源</span>
cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">- service.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p><code>kubectl kustomize ./</code> 所得到的资源中既包含 Deployment 也包含 Service 对象。</p>
<h5 id="定制httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationcustomizing">定制<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#customizing" target="_blank" rel="noopener noreffer"></a></h5>
<p>补丁文件（Patches）可以用来对资源执行不同的定制。 Kustomize 通过 <code>patchesStrategicMerge</code> 和 <code>patchesJson6902</code> 支持不同的打补丁机制。 <code>patchesStrategicMerge</code> 的内容是一个文件路径的列表，其中每个文件都应可解析为 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-api-machinery/strategic-merge-patch.md" target="_blank" rel="noopener noreffer">策略性合并补丁（Strategic Merge Patch）</a>。 补丁文件中的名称必须与已经加载的资源的名称匹配。 建议构造规模较小的、仅做一件事情的补丁。 例如，构造一个补丁来增加 Deployment 的副本个数；构造另外一个补丁来设置内存限制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建 deployment.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>

<span class="c1"># 生成一个补丁 increase_replicas.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt; increase_replicas.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  replicas: 3
</span><span class="s">EOF</span>

<span class="c1"># 生成另一个补丁 set_memory.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt; set_memory.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  template:
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        resources:
</span><span class="s">          limits:
</span><span class="s">            memory: 512Mi
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">patchesStrategicMerge:
</span><span class="s">- increase_replicas.yaml
</span><span class="s">- set_memory.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl kustomize ./</code> 来查看 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">512Mi</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>并非所有资源或者字段都支持策略性合并补丁。为了支持对任何资源的任何字段进行修改， Kustomize 提供通过 <code>patchesJson6902</code> 来应用 <a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreffer">JSON 补丁</a>的能力。 为了给 JSON 补丁找到正确的资源，需要在 <code>kustomization.yaml</code> 文件中指定资源的组（group）、 版本（version）、类别（kind）和名称（name）。 例如，为某 Deployment 对象增加副本个数的操作也可以通过 <code>patchesJson6902</code> 来完成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 deployment.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>

<span class="c1"># 创建一个 JSON 补丁文件</span>
cat <span class="s">&lt;&lt;EOF &gt; patch.yaml
</span><span class="s">- op: replace
</span><span class="s">  path: /spec/replicas
</span><span class="s">  value: 3
</span><span class="s">EOF</span>

<span class="c1"># 创建一个 kustomization.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">
</span><span class="s">patchesJson6902:
</span><span class="s">- target:
</span><span class="s">    group: apps
</span><span class="s">    version: v1
</span><span class="s">    kind: Deployment
</span><span class="s">    name: my-nginx
</span><span class="s">  path: patch.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl kustomize ./</code> 以查看 <code>replicas</code> 字段被更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>除了补丁之外，Kustomize 还提供定制容器镜像或者将其他对象的字段值注入到容器中的能力，并且不需要创建补丁。 例如，你可以通过在 <code>kustomization.yaml</code> 文件的 <code>images</code> 字段设置新的镜像来更改容器中使用的镜像。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">images:
</span><span class="s">- name: nginx
</span><span class="s">  newName: my.image.registry/nginx
</span><span class="s">  newTag: 1.4.0
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl kustomize ./</code> 以查看所使用的镜像已被更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my.image.registry/nginx:1.4.0</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>有些时候，Pod 中运行的应用可能需要使用来自其他对象的配置值。 例如，某 Deployment 对象的 Pod 需要从环境变量或命令行参数中读取读取 Service 的名称。 由于在 <code>kustomization.yaml</code> 文件中添加 <code>namePrefix</code> 或 <code>nameSuffix</code> 时 Service 名称可能发生变化，建议不要在命令参数中硬编码 Service 名称。 对于这种使用场景，Kustomize 可以通过 <code>vars</code> 将 Service 名称注入到容器中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个 deployment.yaml 文件（引用此处的文档分隔符）</span>
cat <span class="s">&lt;&lt;&#39;EOF&#39; &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        command: [&#34;start&#34;, &#34;--host&#34;, &#34;$(MY_SERVICE_NAME)&#34;]
</span><span class="s">EOF</span>

<span class="c1"># 创建一个 service.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; service.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">  labels:
</span><span class="s">    run: my-nginx
</span><span class="s">spec:
</span><span class="s">  ports:
</span><span class="s">  - port: 80
</span><span class="s">    protocol: TCP
</span><span class="s">  selector:
</span><span class="s">    run: my-nginx
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">namePrefix: dev-
</span><span class="s">nameSuffix: &#34;-001&#34;
</span><span class="s">
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">- service.yaml
</span><span class="s">
</span><span class="s">vars:
</span><span class="s">- name: MY_SERVICE_NAME
</span><span class="s">  objref:
</span><span class="s">    kind: Service
</span><span class="s">    name: my-nginx
</span><span class="s">    apiVersion: v1
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行 <code>kubectl kustomize ./</code> 以查看注入到容器中的 Service 名称是 <code>dev-my-nginx-001</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dev-my-nginx-001</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">start</span><span class="w">
</span><span class="w">        </span>- --<span class="l">host</span><span class="w">
</span><span class="w">        </span>- <span class="l">dev-my-nginx-001</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="基准bases与覆盖overlayshttpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione59fbae58786-bases-e4b88ee8a686e79b96-overlays">基准（Bases）与覆盖（Overlays）<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%9F%BA%E5%87%86-bases-%E4%B8%8E%E8%A6%86%E7%9B%96-overlays" target="_blank" rel="noopener noreffer"></a></h3>
<p>Kustomize 中有 <strong>基准（bases）</strong> 和 <strong>覆盖（overlays）</strong> 的概念区分。 <strong>基准</strong> 是包含 <code>kustomization.yaml</code> 文件的一个目录，其中包含一组资源及其相关的定制。 基准可以是本地目录或者来自远程仓库的目录，只要其中存在 <code>kustomization.yaml</code> 文件即可。 <strong>覆盖</strong> 也是一个目录，其中包含将其他 kustomization 目录当做 <code>bases</code> 来引用的 <code>kustomization.yaml</code> 文件。 <strong>基准</strong>不了解覆盖的存在，且可被多个覆盖所使用。 覆盖则可以有多个基准，且可针对所有基准中的资源执行组织操作，还可以在其上执行定制。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建一个包含基准的目录 </span>
mkdir base
<span class="c1"># 创建 base/deployment.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt; base/deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">EOF</span>

<span class="c1"># 创建 base/service.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; base/service.yaml
</span><span class="s">apiVersion: v1
</span><span class="s">kind: Service
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">  labels:
</span><span class="s">    run: my-nginx
</span><span class="s">spec:
</span><span class="s">  ports:
</span><span class="s">  - port: 80
</span><span class="s">    protocol: TCP
</span><span class="s">  selector:
</span><span class="s">    run: my-nginx
</span><span class="s">EOF</span>

<span class="c1"># 创建 base/kustomization.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt; base/kustomization.yaml
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">- service.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>此基准可在多个覆盖中使用。你可以在不同的覆盖中添加不同的 <code>namePrefix</code> 或其他贯穿性字段。 下面是两个使用同一基准的覆盖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">mkdir dev
cat <span class="s">&lt;&lt;EOF &gt; dev/kustomization.yaml
</span><span class="s">bases:
</span><span class="s">- ../base
</span><span class="s">namePrefix: dev-
</span><span class="s">EOF</span>

mkdir prod
cat <span class="s">&lt;&lt;EOF &gt; prod/kustomization.yaml
</span><span class="s">bases:
</span><span class="s">- ../base
</span><span class="s">namePrefix: prod-
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="如何使用-kustomize-来应用查看和删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione5a682e4bd95e4bdbfe794a8-kustomize-e69da5e5ba94e794a8-e69fa5e79c8be5928ce588a0e999a4e5afb9e8b1a1">如何使用 Kustomize 来应用、查看和删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-kustomize-%E6%9D%A5%E5%BA%94%E7%94%A8-%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p>在 <code>kubectl</code> 命令中使用 <code>--kustomize</code> 或 <code>-k</code> 参数来识别被 <code>kustomization.yaml</code> 所管理的资源。 注意 <code>-k</code> 要指向一个 kustomization 目录。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -k &lt;kustomization 目录&gt;/
</code></pre></td></tr></table>
</div>
</div><p>假定使用下面的 <code>kustomization.yaml</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># 创建 deployment.yaml 文件</span>
cat <span class="s">&lt;&lt;EOF &gt; deployment.yaml
</span><span class="s">apiVersion: apps/v1
</span><span class="s">kind: Deployment
</span><span class="s">metadata:
</span><span class="s">  name: my-nginx
</span><span class="s">spec:
</span><span class="s">  selector:
</span><span class="s">    matchLabels:
</span><span class="s">      run: my-nginx
</span><span class="s">  replicas: 2
</span><span class="s">  template:
</span><span class="s">    metadata:
</span><span class="s">      labels:
</span><span class="s">        run: my-nginx
</span><span class="s">    spec:
</span><span class="s">      containers:
</span><span class="s">      - name: my-nginx
</span><span class="s">        image: nginx
</span><span class="s">        ports:
</span><span class="s">        - containerPort: 80
</span><span class="s">EOF</span>

<span class="c1"># 创建 kustomization.yaml</span>
cat <span class="s">&lt;&lt;EOF &gt;./kustomization.yaml
</span><span class="s">namePrefix: dev-
</span><span class="s">commonLabels:
</span><span class="s">  app: my-nginx
</span><span class="s">resources:
</span><span class="s">- deployment.yaml
</span><span class="s">EOF</span>
</code></pre></td></tr></table>
</div>
</div><p>执行下面的命令来应用 Deployment 对象 <code>dev-my-nginx</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">&gt; kubectl apply -k ./
deployment.apps/dev-my-nginx created
</code></pre></td></tr></table>
</div>
</div><p>运行下面的命令之一来查看 Deployment 对象 <code>dev-my-nginx</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get -k ./
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl describe -k ./
</code></pre></td></tr></table>
</div>
</div><p>执行下面的命令来比较 Deployment 对象 <code>dev-my-nginx</code> 与清单被应用之后集群将处于的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl diff -k ./
</code></pre></td></tr></table>
</div>
</div><p>执行下面的命令删除 Deployment 对象 <code>dev-my-nginx</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">&gt; kubectl delete -k ./
deployment.apps <span class="s2">&#34;dev-my-nginx&#34;</span> deleted
</code></pre></td></tr></table>
</div>
</div><h3 id="kustomize-功能特性列表httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizationkustomize-feature-list">Kustomize 功能特性列表<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#kustomize-feature-list" target="_blank" rel="noopener noreffer"></a></h3>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>namespace</td>
<td>string</td>
<td>为所有资源添加名字空间</td>
</tr>
<tr>
<td>namePrefix</td>
<td>string</td>
<td>此字段的值将被添加到所有资源名称前面</td>
</tr>
<tr>
<td>nameSuffix</td>
<td>string</td>
<td>此字段的值将被添加到所有资源名称后面</td>
</tr>
<tr>
<td>commonLabels</td>
<td>map[string]string</td>
<td>要添加到所有资源和选择算符的标签</td>
</tr>
<tr>
<td>commonAnnotations</td>
<td>map[string]string</td>
<td>要添加到所有资源的注解</td>
</tr>
<tr>
<td>resources</td>
<td>[]string</td>
<td>列表中的每个条目都必须能够解析为现有的资源配置文件</td>
</tr>
<tr>
<td>configMapGenerator</td>
<td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/configmapargs.go#L7" target="_blank" rel="noopener noreffer">ConfigMapArgs</a></td>
<td>列表中的每个条目都会生成一个 ConfigMap</td>
</tr>
<tr>
<td>secretGenerator</td>
<td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/secretargs.go#L7" target="_blank" rel="noopener noreffer">SecretArgs</a></td>
<td>列表中的每个条目都会生成一个 Secret</td>
</tr>
<tr>
<td>generatorOptions</td>
<td><a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/generatoroptions.go#L7" target="_blank" rel="noopener noreffer">GeneratorOptions</a></td>
<td>更改所有 ConfigMap 和 Secret 生成器的行为</td>
</tr>
<tr>
<td>bases</td>
<td>[]string</td>
<td>列表中每个条目都应能解析为一个包含 kustomization.yaml 文件的目录</td>
</tr>
<tr>
<td>patchesStrategicMerge</td>
<td>[]string</td>
<td>列表中每个条目都能解析为某 Kubernetes 对象的策略性合并补丁</td>
</tr>
<tr>
<td>patchesJson6902</td>
<td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/patch.go#L10" target="_blank" rel="noopener noreffer">Patch</a></td>
<td>列表中每个条目都能解析为一个 Kubernetes 对象和一个 JSON 补丁</td>
</tr>
<tr>
<td>vars</td>
<td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/var.go#L19" target="_blank" rel="noopener noreffer">Var</a></td>
<td>每个条目用来从某资源的字段来析取文字</td>
</tr>
<tr>
<td>images</td>
<td>[]<a href="https://github.com/kubernetes-sigs/kustomize/blob/master/api/types/image.go#L8" target="_blank" rel="noopener noreffer">Image</a></td>
<td>每个条目都用来更改镜像的名称、标记与/或摘要，不必生成补丁</td>
</tr>
<tr>
<td>configurations</td>
<td>[]string</td>
<td>列表中每个条目都应能解析为一个包含 <a href="https://github.com/kubernetes-sigs/kustomize/tree/master/examples/transformerconfigs" target="_blank" rel="noopener noreffer">Kustomize 转换器配置</a> 的文件</td>
</tr>
<tr>
<td>crds</td>
<td>[]string</td>
<td>列表中每个条目都应能够解析为 Kubernetes 类别的 OpenAPI 定义文件</td>
</tr>
</tbody>
</table>
<h3 id="接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectskustomizatione68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kustomize" target="_blank" rel="noopener noreffer">Kustomize</a></li>
<li><a href="https://kubectl.docs.kubernetes.io/" target="_blank" rel="noopener noreffer">Kubectl Book</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/" target="_blank" rel="noopener noreffer">Kubectl 命令参考</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/" target="_blank" rel="noopener noreffer">Kubernetes API 参考</a></li>
</ul>
<h2 id="使用指令式命令管理-kubernetes-对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-command"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/" target="_blank" rel="noopener noreffer">使用指令式命令管理 Kubernetes 对象</a></h2>
<p>使用构建在 <code>kubectl</code> 命令行工具中的指令式命令可以直接快速创建、更新和删除 Kubernetes 对象。本文档解释这些命令的组织方式以及如何使用它们来管理活跃对象。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commande58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>安装<a href="https://kubernetes.io/zh-cn/docs/tasks/tools/" target="_blank" rel="noopener noreffer"><code>kubectl</code></a>。</p>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<p>要获知版本信息，请输入 <code>kubectl version</code>.</p>
<h3 id="权衡取舍httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandtrade-offs">权衡取舍<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#trade-offs" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>kubectl</code> 工具能够支持三种对象管理方式：</p>
<ul>
<li>指令式命令</li>
<li>指令式对象配置</li>
<li>声明式对象配置</li>
</ul>
<p>关于每种对象管理的优缺点的讨论，可参见 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noopener noreffer">Kubernetes 对象管理</a>。</p>
<h3 id="如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-create-objects">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-create-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>kubectl</code> 工具支持动词驱动的命令，用来创建一些最常见的对象类别。 命令的名称设计使得不熟悉 Kubernetes 对象类型的用户也能做出判断。</p>
<ul>
<li><code>run</code>：创建一个新的 Pod 来运行一个容器。</li>
<li><code>expose</code>：创建一个新的 Service 对象为若干 Pod 提供流量负载均衡。</li>
<li><code>autoscale</code>：创建一个新的 Autoscaler 对象来自动对某控制器（例如：Deployment） 执行水平扩缩。</li>
</ul>
<p><code>kubectl</code> 命令也支持一些对象类型驱动的创建命令。 这些命令可以支持更多的对象类别，并且在其动机上体现得更为明显， 不过要求用户了解它们所要创建的对象的类别。</p>
<ul>
<li><code>create &lt;对象类别&gt; [&lt;子类别&gt;] &lt;实例名称&gt;</code></li>
</ul>
<p>某些对象类别拥有自己的子类别，可以在 <code>create</code> 命令中设置。 例如，Service 对象有 ClusterIP、LoadBalancer 和 NodePort 三种子类别。 下面是一个创建 NodePort 子类别的 Service 的示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create service nodeport &lt;服务名称&gt;
</code></pre></td></tr></table>
</div>
</div><p>在前述示例中，<code>create service nodeport</code> 命令也称作 <code>create service</code> 命令的子命令。 可以使用 <code>-h</code> 标志找到一个子命令所支持的参数和标志。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create service nodeport -h
</code></pre></td></tr></table>
</div>
</div><h3 id="如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-update-objects">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-update-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>kubectl</code> 命令也支持一些动词驱动的命令，用来执行一些常见的更新操作。 这些命令的设计是为了让一些不了解 Kubernetes 对象的用户也能执行更新操作， 但不需要了解哪些字段必须设置：</p>
<ul>
<li><code>scale</code>：对某控制器进行水平扩缩以便通过更新控制器的副本个数来添加或删除 Pod。</li>
<li><code>annotate</code>：为对象添加或删除注解。</li>
<li><code>label</code>：为对象添加或删除标签。</li>
</ul>
<p><code>kubectl</code> 命令也支持由对象的某一方面来驱动的更新命令。 设置对象的这一方面可能对不同类别的对象意味着不同的字段：</p>
<ul>
<li><code>set &lt;字段&gt;</code>：设置对象的某一方面。</li>
</ul>
<p><strong>说明：</strong></p>
<p>在 Kubernetes 1.5 版本中，并非所有动词驱动的命令都有对应的方面驱动的命令。</p>
<p><code>kubectl</code> 工具支持以下额外的方式用来直接更新活跃对象，不过这些操作要求 用户对 Kubernetes 对象的模式定义有很好的了解：</p>
<ul>
<li><code>edit</code>：通过在编辑器中打开活跃对象的配置，直接编辑其原始配置。</li>
<li><code>patch</code>：通过使用补丁字符串（Patch String）直接更改某活跃对象的特定字段。 关于补丁字符串的更详细信息，参见 <a href="https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#patch-operations" target="_blank" rel="noopener noreffer">API 约定</a> 的 patch 节。</li>
</ul>
<h3 id="如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-delete-objects">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-delete-objects" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以使用 <code>delete</code> 命令从集群中删除一个对象：</p>
<ul>
<li><code>delete &lt;类别&gt;/&lt;名称&gt;</code></li>
</ul>
<p><strong>说明：</strong></p>
<p>你可以使用 <code>kubectl delete</code> 来执行指令式命令或者指令式对象配置。不同之处在于传递给命令的参数。 要将 <code>kubectl delete</code> 作为指令式命令使用，将要删除的对象作为参数传递给它。 下面是一个删除名为 <code>nginx</code> 的 Deployment 对象的命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete deployment/nginx
</code></pre></td></tr></table>
</div>
</div><h3 id="如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandhow-to-view-an-object">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#how-to-view-an-object" target="_blank" rel="noopener noreffer"></a></h3>
<p>用来打印对象信息的命令有好几个：</p>
<ul>
<li><code>get</code>：打印匹配到的对象的基本信息。使用 <code>get -h</code> 可以查看选项列表。</li>
<li><code>describe</code>：打印匹配到的对象的详细信息的汇集版本。</li>
<li><code>logs</code>：打印 Pod 中运行的容器的 stdout 和 stderr 输出。</li>
</ul>
<h3 id="使用-set-命令在创建对象之前修改对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandusing-set-commands-to-modify-objects-before-creation">使用 <code>set</code> 命令在创建对象之前修改对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#using-set-commands-to-modify-objects-before-creation" target="_blank" rel="noopener noreffer"></a></h3>
<p>有些对象字段在 <code>create</code> 命令中没有对应的标志。 在这些场景中，你可以使用 <code>set</code> 和 <code>create</code> 命令的组合来在对象创建之前设置字段值。 这是通过将 <code>create</code> 命令的输出用管道方式传递给 <code>set</code> 命令来实现的，最后执行 <code>create</code> 命令来创建对象。 下面是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl create service clusterip my-svc --clusterip<span class="o">=</span><span class="s2">&#34;None&#34;</span> -o yaml --dry-run<span class="o">=</span>client <span class="p">|</span> kubectl <span class="nb">set</span> selector --local -f - <span class="s1">&#39;environment=qa&#39;</span> -o yaml <span class="p">|</span> kubectl create -f -
</code></pre></td></tr></table>
</div>
</div><ol>
<li>命令 <code>kubectl create service -o yaml --dry-run=client</code> 创建 Service 的配置， 但将其以 YAML 格式在标准输出上打印而不是发送给 API 服务器。</li>
<li>命令 <code>kubectl set selector --local -f - -o yaml</code> 从标准输入读入配置， 并将更新后的配置以 YAML 格式输出到标准输出。</li>
<li>命令 <code>kubectl create -f -</code> 使用标准输入上获得的配置创建对象。</li>
</ol>
<h3 id="在创建之前使用---edit-更改对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commandusing-edit-to-modify-objects-before-creation">在创建之前使用 <code>--edit</code> 更改对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#using-edit-to-modify-objects-before-creation" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以用 <code>kubectl create --edit</code> 来在对象被创建之前执行任意的变更。 下面是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">kubectl create service clusterip my-svc --clusterip<span class="o">=</span><span class="s2">&#34;None&#34;</span> -o yaml --dry-run<span class="o">=</span>client &gt; /tmp/srv.yaml
kubectl create --edit -f /tmp/srv.yaml
</code></pre></td></tr></table>
</div>
</div><ol>
<li>命令 <code>kubectl create service</code> 创建 Service 的配置并将其保存到 <code>/tmp/srv.yaml</code> 文件。</li>
<li>命令 <code>kubectl create --edit</code> 在创建 Service 对象打开其配置文件进行编辑。</li>
</ol>
<h3 id="接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-commande68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行命令式管理</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行声明式管理</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/" target="_blank" rel="noopener noreffer">Kubectl 命令参考</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/" target="_blank" rel="noopener noreffer">Kubernetes API 参考</a></li>
</ul>
<h2 id="使用配置文件对-kubernetes-对象进行命令式管理httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-config"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行命令式管理</a></h2>
<p>可以使用 <code>kubectl</code> 命令行工具以及用 YAML 或 JSON 编写的对象配置文件来创建、更新和删除 Kubernetes 对象。 本文档说明了如何使用配置文件定义和管理对象。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>安装 <a href="https://kubernetes.io/zh-cn/docs/tasks/tools/" target="_blank" rel="noopener noreffer"><code>kubectl</code></a> 。</p>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<p>要获知版本信息，请输入 <code>kubectl version</code>.</p>
<h3 id="权衡httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige69d83e8a1a1">权衡<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E6%9D%83%E8%A1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>kubectl</code> 工具支持三种对象管理：</p>
<ul>
<li>命令式命令</li>
<li>命令式对象配置</li>
<li>声明式对象配置</li>
</ul>
<p>参看 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noopener noreffer">Kubernetes 对象管理</a> 中关于每种对象管理的优缺点的讨论。</p>
<h3 id="如何创建对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e5889be5bbbae5afb9e8b1a1">如何创建对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以使用 <code>kubectl create -f</code> 从配置文件创建一个对象。 请参考 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/" target="_blank" rel="noopener noreffer">kubernetes API 参考</a> 有关详细信息。</p>
<ul>
<li><code>kubectl create -f &lt;filename|url&gt;</code></li>
</ul>
<h3 id="如何更新对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e69bb4e696b0e5afb9e8b1a1">如何更新对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p><strong>警告：</strong> 使用 <code>replace</code> 命令更新对象会删除所有未在配置文件中指定的规范的某些部分。 不应将其规范由集群部分管理的对象使用，比如类型为 <code>LoadBalancer</code> 的服务， 其中 <code>externalIPs</code> 字段独立于配置文件进行管理。 必须将独立管理的字段复制到配置文件中，以防止 <code>replace</code> 删除它们。</p>
<p>你可以使用 <code>kubectl replace -f</code> 根据配置文件更新活动对象。</p>
<ul>
<li><code>kubectl replace -f &lt;filename|url&gt;</code></li>
</ul>
<h3 id="如何删除对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e588a0e999a4e5afb9e8b1a1">如何删除对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E5%88%A0%E9%99%A4%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以使用 <code>kubectl delete -f</code> 删除配置文件中描述的对象。</p>
<ul>
<li><code>kubectl delete -f &lt;filename|url&gt;</code></li>
</ul>
<p><strong>说明：</strong></p>
<p>如果配置文件在 <code>metadata</code> 节中设置了 <code>generateName</code> 字段而非 <code>name</code> 字段， 你无法使用 <code>kubectl delete -f &lt;filename|url&gt;</code> 来删除该对象。 你必须使用其他标志才能删除对象。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete &lt;type&gt; &lt;name&gt;
kubectl delete &lt;type&gt; -l &lt;label&gt;
</code></pre></td></tr></table>
</div>
</div><h3 id="如何查看对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5a682e4bd95e69fa5e79c8be5afb9e8b1a1">如何查看对象<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以使用 <code>kubectl get -f</code> 查看有关配置文件中描述的对象的信息。</p>
<ul>
<li><code>kubectl get -f &lt;filename|url&gt; -o yaml</code></li>
</ul>
<p><code>-o yaml</code> 标志指定打印完整的对象配置。 使用 <code>kubectl get -h</code> 查看选项列表。</p>
<h3 id="局限性httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5b180e99990e680a7">局限性<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%B1%80%E9%99%90%E6%80%A7" target="_blank" rel="noopener noreffer"></a></h3>
<p>当完全定义每个对象的配置并将其记录在其配置文件中时，<code>create</code>、 <code>replace</code> 和<code>delete</code> 命令会很好的工作。 但是，当更新一个活动对象，并且更新没有合并到其配置文件中时，下一次执行 <code>replace</code> 时，更新将丢失。 如果控制器,例如 HorizontalPodAutoscaler ,直接对活动对象进行更新，则会发生这种情况。 这有一个例子：</p>
<ol>
<li>从配置文件创建一个对象。</li>
<li>另一个源通过更改某些字段来更新对象。</li>
<li>从配置文件中替换对象。在步骤2中所做的其他源的更改将丢失。</li>
</ol>
<p>如果需要支持同一对象的多个编写器，则可以使用 <code>kubectl apply</code> 来管理该对象。</p>
<h3 id="从-url-创建和编辑对象而不保存配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige4bb8e-url-e5889be5bbbae5928ce7bc96e8be91e5afb9e8b1a1e8808ce4b88de4bf9de5ad98e9858de7bdae">从 URL 创建和编辑对象而不保存配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E4%BB%8E-url-%E5%88%9B%E5%BB%BA%E5%92%8C%E7%BC%96%E8%BE%91%E5%AF%B9%E8%B1%A1%E8%80%8C%E4%B8%8D%E4%BF%9D%E5%AD%98%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreffer"></a></h3>
<p>假设你具有对象配置文件的 URL。 你可以在创建对象之前使用 <code>kubectl create --edit</code> 对配置进行更改。 这对于指向可以由读者修改的配置文件的教程和任务特别有用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create -f &lt;url&gt; --edit
</code></pre></td></tr></table>
</div>
</div><h3 id="从命令式命令迁移到命令式对象配置httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige4bb8ee591bde4bba4e5bc8fe591bde4bba4e8bf81e7a7bbe588b0e591bde4bba4e5bc8fe5afb9e8b1a1e9858de7bdae">从命令式命令迁移到命令式对象配置<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E4%BB%8E%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%91%BD%E4%BB%A4%E8%BF%81%E7%A7%BB%E5%88%B0%E5%91%BD%E4%BB%A4%E5%BC%8F%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE" target="_blank" rel="noopener noreffer"></a></h3>
<p>从命令式命令迁移到命令式对象配置涉及几个手动步骤。</p>
<ol>
<li>
<p>将活动对象导出到本地对象配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get &lt;kind&gt;/&lt;name&gt; -o yaml &gt; &lt;kind&gt;_&lt;name&gt;.yaml
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>从对象配置文件中手动删除状态字段。</p>
</li>
<li>
<p>对于后续的对象管理，只能使用 <code>replace</code> 。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl replace -f &lt;kind&gt;_&lt;name&gt;.yaml
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="定义控制器选择器和-podtemplate-标签httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige5ae9ae4b989e68ea7e588b6e599a8e98089e68ba9e599a8e5928c-podtemplate-e6a087e7adbe">定义控制器选择器和 PodTemplate 标签<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8%E9%80%89%E6%8B%A9%E5%99%A8%E5%92%8C-podtemplate-%E6%A0%87%E7%AD%BE" target="_blank" rel="noopener noreffer"></a></h3>
<p><strong>警告：</strong> 不建议在控制器上更新选择器。</p>
<p>推荐的方法是定义单个不变的 PodTemplate 标签，该标签仅由控制器选择器使用，而没有其他语义。</p>
<p>标签示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">controller-selector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps/v1/deployment/nginx&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">controller-selector</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;apps/v1/deployment/nginx&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsimperative-confige68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/" target="_blank" rel="noopener noreffer">使用命令式命令管理 Kubernetes 对象</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行声明式管理</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/" target="_blank" rel="noopener noreffer">Kubectl 命令参考</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/" target="_blank" rel="noopener noreffer">Kubernetes API 参考</a></li>
</ul>
<h2 id="使用-kubectl-patch-更新-api-对象httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patch"><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/" target="_blank" rel="noopener noreffer">使用 kubectl patch 更新 API 对象</a></h2>
<p>使用 kubectl patch 更新 Kubernetes API 对象。做一个策略性的合并 patch 或 JSON 合并 patch。
这个任务展示如何使用 <code>kubectl patch</code> 就地更新 API 对象。 这个任务中的练习演示了一个策略性合并 patch 和一个 JSON 合并 patch。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patche58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<p>要获知版本信息，请输入 <code>kubectl version</code>.</p>
<h3 id="使用策略合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-a-strategic-merge-patch-to-update-a-deployment">使用策略合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-strategic-merge-patch-to-update-a-deployment" target="_blank" rel="noopener noreffer"></a></h3>
<p>下面是具有两个副本的 Deployment 的配置文件。每个副本是一个 Pod，有一个容器：</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/deployment-patch.yaml" target="_blank" rel="noopener noreffer"><code>application/deployment-patch.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/deployment-patch.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/deployment-patch.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">dedicated</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">test-team</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>创建 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/deployment-patch.yaml
</code></pre></td></tr></table>
</div>
</div><p>查看与 Deployment 相关的 Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods
</code></pre></td></tr></table>
</div>
</div><p>输出显示 Deployment 有两个 Pod。<code>1/1</code> 表示每个 Pod 有一个容器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NAME                        READY     STATUS    RESTARTS   AGE
patch-demo-28633765-670qr   1/1       Running   0          23s
patch-demo-28633765-j5qs3   1/1       Running   0          23s
</code></pre></td></tr></table>
</div>
</div><p>把运行的 Pod 的名字记下来。稍后，你将看到这些 Pod 被终止并被新的 Pod 替换。</p>
<p>此时，每个 Pod 都有一个运行 nginx 镜像的容器。现在假设你希望每个 Pod 有两个容器：一个运行 nginx，另一个运行 redis。</p>
<p>创建一个名为 <code>patch-file.yaml</code> 的文件。内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr-2</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>修补你的 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment patch-demo --patch-file patch-file.yaml
</code></pre></td></tr></table>
</div>
</div><p>查看修补后的 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment patch-demo --output yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示 Deployment 中的 PodSpec 有两个容器：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">redis</span><span class="w">
</span><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr-2</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span><span class="w"></span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>查看与 patch Deployment 相关的 Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods
</code></pre></td></tr></table>
</div>
</div><p>输出显示正在运行的 Pod 与以前运行的 Pod 有不同的名称。Deployment 终止了旧的 Pod， 并创建了两个符合更新后的 Deployment 规约的新 Pod。<code>2/2</code> 表示每个 Pod 有两个容器:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NAME                          READY     STATUS    RESTARTS   AGE
patch-demo-1081991389-2wrn5   2/2       Running   0          1m
patch-demo-1081991389-jmg7b   2/2       Running   0          1m
</code></pre></td></tr></table>
</div>
</div><p>仔细查看其中一个 patch-demo Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pod &lt;your-pod-name&gt; --output yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示 Pod 有两个容器：一个运行 nginx，一个运行 redis：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">containers:
- image: redis
  ...
- image: nginx
  ...
</code></pre></td></tr></table>
</div>
</div><h4 id="策略性合并类的-patch-的说明httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchnotes-on-the-strategic-merge-patch">策略性合并类的 patch 的说明<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#notes-on-the-strategic-merge-patch" target="_blank" rel="noopener noreffer"></a></h4>
<p>你在前面的练习中所做的 patch 称为 <code>策略性合并 patch（Strategic Merge Patch）</code>。 请注意，patch 没有替换 <code>containers</code> 列表。相反，它向列表中添加了一个新 Container。换句话说， patch 中的列表与现有列表合并。当你在列表中使用策略性合并 patch 时，并不总是这样。 在某些情况下，列表是替换的，而不是合并的。</p>
<p>对于策略性合并 patch，列表可以根据其 patch 策略进行替换或合并。 patch 策略由 Kubernetes 源代码中字段标记中的 <code>patchStrategy</code> 键的值指定。 例如，<code>PodSpec</code> 结构体的 <code>Containers</code> 字段的 <code>patchStrategy</code> 为 <code>merge</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">PodSpec</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="nx">Containers</span> <span class="p">[]</span><span class="nx">Container</span> <span class="s">`json:&#34;containers&#34; patchStrategy:&#34;merge&#34; patchMergeKey:&#34;name&#34; ...`</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>你还可以在 <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json" target="_blank" rel="noopener noreffer">OpenApi 规范</a>中看到 patch 策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">&#34;io.k8s.api.core.v1.PodSpec&#34;: </span>{<span class="w">
</span><span class="w">    </span><span class="l">...,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;containers&#34;: </span>{<span class="w">
</span><span class="w">        </span><span class="nt">&#34;description&#34;: </span><span class="s2">&#34;List of containers belonging to the pod.  ....&#34;</span><span class="w">
</span><span class="w">    </span>}<span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;x-kubernetes-patch-merge-key&#34;: </span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;x-kubernetes-patch-strategy&#34;: </span><span class="s2">&#34;merge&#34;</span><span class="w">
</span><span class="w"></span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你可以在 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#podspec-v1-core" target="_blank" rel="noopener noreffer">Kubernetes API 文档</a> 中看到 patch 策略。</p>
<p>创建一个名为 <code>patch-file-tolerations.yaml</code> 的文件。内容如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">disktype</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">ssd</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对 Deployment 执行 patch 操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment patch-demo --patch-file patch-file-tolerations.yaml
</code></pre></td></tr></table>
</div>
</div><p>查看修补后的 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment patch-demo --output yaml
</code></pre></td></tr></table>
</div>
</div><p>输出结果显示 Deployment 中的 PodSpec 只有一个容忍度设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">tolerations</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span><span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">disktype</span><span class="w">
</span><span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">ssd</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>请注意，PodSpec 中的 <code>tolerations</code> 列表被替换，而不是合并。这是因为 PodSpec 的 <code>tolerations</code> 的字段标签中没有 <code>patchStrategy</code> 键。所以策略合并 patch 操作使用默认的 patch 策略，也就是 <code>replace</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">PodSpec</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="nx">Tolerations</span> <span class="p">[]</span><span class="nx">Toleration</span> <span class="s">`json:&#34;tolerations,omitempty&#34; protobuf:&#34;bytes,22,opt,name=tolerations&#34;`</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用-json-合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-a-json-merge-patch-to-update-a-deployment">使用 JSON 合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-a-json-merge-patch-to-update-a-deployment" target="_blank" rel="noopener noreffer"></a></h3>
<p>策略性合并 patch 不同于 <a href="https://tools.ietf.org/html/rfc7386" target="_blank" rel="noopener noreffer">JSON 合并 patch</a>。 使用 JSON 合并 patch，如果你想更新列表，你必须指定整个新列表。新的列表完全取代现有的列表。</p>
<p><code>kubectl patch</code> 命令有一个 <code>type</code> 参数，你可以将其设置为以下值之一：</p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>合并类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>json</td>
<td><a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreffer">JSON Patch, RFC 6902</a></td>
</tr>
<tr>
<td>merge</td>
<td><a href="https://tools.ietf.org/html/rfc7386" target="_blank" rel="noopener noreffer">JSON Merge Patch, RFC 7386</a></td>
</tr>
<tr>
<td>strategic</td>
<td>策略合并 patch</td>
</tr>
</tbody>
</table>
<p>有关 JSON patch 和 JSON 合并 patch 的比较，查看 <a href="https://erosb.github.io/post/json-patch-vs-merge-patch/" target="_blank" rel="noopener noreffer">JSON patch 和 JSON 合并 patch</a>。</p>
<p><code>type</code> 参数的默认值是 <code>strategic</code>。在前面的练习中，我们做了一个策略性的合并 patch。</p>
<p>下一步，在相同的 Deployment 上执行 JSON 合并 patch。创建一个名为 <code>patch-file-2</code> 的文件。内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr-3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/google-samples/node-hello:1.0</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在 patch 命令中，将 <code>type</code> 设置为 <code>merge</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment patch-demo --type merge --patch-file patch-file-2.yaml
</code></pre></td></tr></table>
</div>
</div><p>查看修补后的 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment patch-demo --output yaml
</code></pre></td></tr></table>
</div>
</div><p>patch 中指定的 <code>containers</code> 列表只有一个 Container。 输出显示你所给出的 Contaier 列表替换了现有的 <code>containers</code> 列表。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/google-samples/node-hello:1.0</span><span class="w">
</span><span class="w">    </span><span class="l">...</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">patch-demo-ctr-3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>列出正运行的 Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods
</code></pre></td></tr></table>
</div>
</div><p>在输出中，你可以看到已经终止了现有的 Pod，并创建了新的 Pod。<code>1/1</code> 表示每个新 Pod 只运行一个容器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">NAME                          READY     STATUS    RESTARTS   AGE
patch-demo-1307768864-69308   1/1       Running   <span class="m">0</span>          1m
patch-demo-1307768864-c86dc   1/1       Running   <span class="m">0</span>          1m
</code></pre></td></tr></table>
</div>
</div><h3 id="使用带-retainkeys-策略的策略合并-patch-更新-deploymenthttpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchuse-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy">使用带 retainKeys 策略的策略合并 patch 更新 Deployment<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#use-strategic-merge-patch-to-update-a-deployment-using-the-retainkeys-strategy" target="_blank" rel="noopener noreffer"></a></h3>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/deployment-retainkeys.yaml" target="_blank" rel="noopener noreffer"><code>application/deployment-retainkeys.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/deployment-retainkeys.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/deployment-retainkeys.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">retainkeys-demo</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">retainkeys-demo-ctr</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>创建 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/deployment-retainkeys.yaml
</code></pre></td></tr></table>
</div>
</div><p>这时，Deployment 被创建，并使用 <code>RollingUpdate</code> 策略。</p>
<p>创建一个名为 <code>patch-file-no-retainkeys.yaml</code> 的文件，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>修补你的 Deployment:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-no-retainkeys.yaml
</code></pre></td></tr></table>
</div>
</div><p>在输出中，你可以看到，当 <code>spec.strategy.rollingUpdate</code> 已经拥有取值定义时， 将其 <code>type</code> 设置为 <code>Recreate</code> 是不可能的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="n">The</span><span class="w"> </span><span class="n">Deployment</span><span class="w"> </span><span class="s2">&#34;retainkeys-demo&#34;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">invalid</span><span class="p">:</span><span class="w"> </span><span class="n">spec</span><span class="p">.</span><span class="n">strategy</span><span class="p">.</span><span class="n">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="n">Forbidden</span><span class="p">:</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="o">`</span><span class="n">type</span><span class="o">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="s1">&#39;Recreate&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>更新 <code>type</code> 取值的同时移除 <code>spec.strategy.rollingUpdate</code> 现有值的方法是为策略性合并操作设置 <code>retainKeys</code> 策略：</p>
<p>创建另一个名为 <code>patch-file-retainkeys.yaml</code> 的文件，内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">$retainKeys</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="l">type</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>使用此 patch，我们表达了希望只保留 <code>strategy</code> 对象的 <code>type</code> 键。 这样，在 patch 操作期间 <code>rollingUpdate</code> 会被删除。</p>
<p>使用新的 patch 重新修补 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment retainkeys-demo --type strategic --patch-file patch-file-retainkeys.yaml
</code></pre></td></tr></table>
</div>
</div><p>检查 Deployment 的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment retainkeys-demo --output yaml
</code></pre></td></tr></table>
</div>
</div><p>输出显示 Deployment 中的 <code>strategy</code> 对象不再包含 <code>rollingUpdate</code> 键：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="关于使用-retainkeys-策略的策略合并-patch-操作的说明httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchnotes-on-the-strategic-merge-patch-using-the-retainkeys-strategy">关于使用 retainKeys 策略的策略合并 patch 操作的说明<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#notes-on-the-strategic-merge-patch-using-the-retainkeys-strategy" target="_blank" rel="noopener noreffer"></a></h4>
<p>在前文练习中所执行的称作 <strong>带 <code>retainKeys</code> 策略的策略合并 patch（Strategic Merge Patch with retainKeys Strategy）</strong>。 这种方法引入了一种新的 <code>$retainKey</code> 指令，具有如下策略：</p>
<ul>
<li>其中包含一个字符串列表；</li>
<li>所有需要被保留的字段必须在 <code>$retainKeys</code> 列表中给出；</li>
<li>对于已有的字段，会和对象上对应的内容合并；</li>
<li>在修补操作期间，未找到的字段都会被清除；</li>
<li>列表 <code>$retainKeys</code> 中的所有字段必须 patch 操作所给字段的超集，或者与之完全一致。</li>
</ul>
<p>策略 <code>retainKeys</code> 并不能对所有对象都起作用。它仅对那些 Kubernetes 源码中 <code>patchStrategy</code> 字段标志值包含 <code>retainKeys</code> 的字段有用。 例如 <code>DeploymentSpec</code> 结构的 <code>Strategy</code> 字段就包含了 <code>patchStrategy</code> 为 <code>retainKeys</code> 的标志。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">DeploymentSpec</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="c1">// +patchStrategy=retainKeys
</span><span class="c1"></span>  <span class="nx">Strategy</span> <span class="nx">DeploymentStrategy</span> <span class="s">`json:&#34;strategy,omitempty&#34; patchStrategy:&#34;retainKeys&#34; ...`</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>你也可以查看 <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/api/openapi-spec/swagger.json" target="_blank" rel="noopener noreffer">OpenAPI 规范</a>中的 <code>retainKeys</code> 策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">&#34;io.k8s.api.apps.v1.DeploymentSpec&#34;: </span>{<span class="w">
</span><span class="w">    </span><span class="l">...,</span><span class="w">
</span><span class="w">    </span><span class="nt">&#34;strategy&#34;: </span>{<span class="w">
</span><span class="w">        </span><span class="nt">&#34;$ref&#34;: </span><span class="s2">&#34;#/definitions/io.k8s.api.apps.v1.DeploymentStrategy&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="nt">&#34;description&#34;: </span><span class="s2">&#34;The deployment strategy to use to replace existing pods with new ones.&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="nt">&#34;x-kubernetes-patch-strategy&#34;: </span><span class="s2">&#34;retainKeys&#34;</span><span class="w">
</span><span class="w">    </span>}<span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="l">....</span><span class="w">
</span><span class="w"></span>}<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>而且你也可以在 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#deploymentspec-v1-apps" target="_blank" rel="noopener noreffer">Kubernetes API 文档</a>中看到 <code>retainKey</code> 策略。</p>
<h4 id="kubectl-patch-命令的其他形式httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchalternate-forms-of-the-kubectl-patch-command">kubectl patch 命令的其他形式<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#alternate-forms-of-the-kubectl-patch-command" target="_blank" rel="noopener noreffer"></a></h4>
<p><code>kubectl patch</code> 命令使用 YAML 或 JSON。它可以接受以文件形式提供的补丁，也可以接受直接在命令行中给出的补丁。</p>
<p>创建一个文件名称是 <code>patch-file.json</code> 内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;template&#34;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&#34;spec&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;containers&#34;</span><span class="p">:</span> <span class="p">[</span>
               <span class="p">{</span>
                  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;patch-demo-ctr-2&#34;</span><span class="p">,</span>
                  <span class="nt">&#34;image&#34;</span><span class="p">:</span> <span class="s2">&#34;redis&#34;</span>
               <span class="p">}</span>
            <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下命令是等价的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment patch-demo --patch-file patch-file.yaml
kubectl patch deployment patch-demo --patch <span class="s1">&#39;spec:\n template:\n  spec:\n   containers:\n   - name: patch-demo-ctr-2\n     image: redis&#39;</span>

kubectl patch deployment patch-demo --patch-file patch-file.json
kubectl patch deployment patch-demo --patch <span class="s1">&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;spec&#34;: {&#34;containers&#34;: [{&#34;name&#34;: &#34;patch-demo-ctr-2&#34;,&#34;image&#34;: &#34;redis&#34;}]}}}}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="使用-kubectl-patch-和---subresource-更新一个对象的副本数httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchscale-kubectl-patch">使用 <code>kubectl patch</code> 和 <code>--subresource</code> 更新一个对象的副本数<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#scale-kubectl-patch" target="_blank" rel="noopener noreffer"></a></h4>
<p><strong>特性状态：</strong> <code>Kubernetes v1.24 [alpha]</code></p>
<p>使用 kubectl 命令（如 get、patch、edit 和 replace）时带上 <code>--subresource=[subresource-name]</code> 标志， 可以获取和更新资源的 <code>status</code> 和 <code>scale</code> 子资源（适用于 kubectl v1.24 或更高版本）。 这个标志可用于带有 <code>status</code> 或 <code>scale</code> 子资源的所有 API 资源 (内置资源和 CR 资源)。 Deployment 是支持这些子资源的其中一个例子。</p>
<p>下面是有两个副本的 Deployment 的清单。</p>
<p><a href="https://raw.githubusercontent.com/kubernetes/website/main/content/zh-cn/examples/application/deployment.yaml" target="_blank" rel="noopener noreffer"><code>application/deployment.yaml</code></a> <figure><a class="lightgallery" href="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" title="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-thumbnail="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" data-sub-html="<h2>Copy application/deployment.yaml to clipboard</h2>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg"
            data-srcset="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 1.5x, https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg 2x"
            data-sizes="auto"
            alt="https://d33wubrfki0l68.cloudfront.net/0901162ab78eb4ff2e9e5dc8b17c3824befc91a6/44ccd/images/copycode.svg" />
    </a><figcaption class="image-caption">Copy application/deployment.yaml to clipboard</figcaption>
    </figure></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c"># 告知 Deployment 运行 2 个与该模板匹配的 Pod</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.14.2</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>创建 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://k8s.io/examples/application/deployment.yaml
</code></pre></td></tr></table>
</div>
</div><p>查看与 Deployment 关联的 Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
</code></pre></td></tr></table>
</div>
</div><p>在输出中，你可以看到此 Deployment 有两个 Pod。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          47s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          47s
</code></pre></td></tr></table>
</div>
</div><p>现在用 <code>--subresource=[subresource-name]</code> 标志修补此 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl patch deployment nginx-deployment --subresource<span class="o">=</span><span class="s1">&#39;scale&#39;</span> --type<span class="o">=</span><span class="s1">&#39;merge&#39;</span> -p <span class="s1">&#39;{&#34;spec&#34;:{&#34;replicas&#34;:3}}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>输出为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">scale.autoscaling/nginx-deployment patched
</code></pre></td></tr></table>
</div>
</div><p>查看与你所修补的 Deployment 关联的 Pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods -l <span class="nv">app</span><span class="o">=</span>nginx
</code></pre></td></tr></table>
</div>
</div><p>在输出中，你可以看到一个新的 Pod 被创建，因此现在你有 3 个正在运行的 Pod。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-22567   1/1     Running   0          107s
nginx-deployment-7fb96c846b-lxfr2   1/1     Running   0          14s
nginx-deployment-7fb96c846b-mlgns   1/1     Running   0          107s
</code></pre></td></tr></table>
</div>
</div><p>查看所修补的 Deployment：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get deployment nginx-deployment -o yaml
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">...</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="l">...</span><span class="w">
</span><span class="w">  </span><span class="nt">availableReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">readyReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong></p>
<p>如果你运行 <code>kubectl patch</code> 并指定 <code>--subresource</code> 标志时，所针对的是不支持特定子资源的资源， 则 API 服务器会返回一个 404 Not Found 错误。</p>
<h3 id="总结httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patchsummary">总结<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#summary" target="_blank" rel="noopener noreffer"></a></h3>
<p>在本练习中，你使用 <code>kubectl patch</code> 更改了 Deployment 对象的当前配置。 你没有更改最初用于创建 Deployment 对象的配置文件。 用于更新 API 对象的其他命令包括 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#annotate" target="_blank" rel="noopener noreffer"><code>kubectl annotate</code></a>、 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#edit" target="_blank" rel="noopener noreffer"><code>kubectl edit</code></a>、 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#replace" target="_blank" rel="noopener noreffer"><code>kubectl replace</code></a>、 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#scale" target="_blank" rel="noopener noreffer"><code>kubectl scale</code></a> 和 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands/#apply" target="_blank" rel="noopener noreffer"><code>kubectl apply</code></a>。</p>
<p><strong>说明：</strong></p>
<p>定制资源不支持策略性合并 patch。</p>
<h3 id="接下来httpskubernetesiozh-cndocstasksmanage-kubernetes-objectsupdate-api-object-kubectl-patche68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/object-management/" target="_blank" rel="noopener noreffer">Kubernetes 对象管理</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-command/" target="_blank" rel="noopener noreffer">使用指令式命令管理 Kubernetes 对象</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/imperative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行命令式管理</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/declarative-config/" target="_blank" rel="noopener noreffer">使用配置文件对 Kubernetes 对象进行声明式管理</a></li>
</ul>
<h1 id="管理-secrets">管理 Secrets</h1>
<p>使用 Secrets 管理机密配置数据。</p>
<hr>
<h2 id="使用-kubectl-管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectl"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/" target="_blank" rel="noopener noreffer">使用 kubectl 管理 Secret</a></h2>
<p>使用 kubectl 命令行创建 Secret 对象。
本页向你展示如何使用 <code>kubectl</code> 命令行工具来创建、编辑、管理和删除。 Kubernetes <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreffer">Secrets</a></p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<h3 id="创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlcreate-a-secret">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret" target="_blank" rel="noopener noreffer"></a></h3>
<p><code>Secret</code> 对象用来存储敏感数据，如 Pod 用于访问服务的凭据。例如，为访问数据库，你可能需要一个 Secret 来存储所需的用户名及密码。</p>
<p>你可以通过在命令中传递原始数据，或将凭据存储文件中，然后再在命令行中创建 Secret。以下命令 将创建一个存储用户名 <code>admin</code> 和密码 <code>S!B\*d$zDsb=</code> 的 Secret。</p>
<h4 id="使用原始数据httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle4bdbfe794a8e58e9fe5a78be695b0e68dae">使用原始数据<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E4%BD%BF%E7%94%A8%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE" target="_blank" rel="noopener noreffer"></a></h4>
<p>执行以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic db-user-pass <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">username</span><span class="o">=</span>admin <span class="se">\
</span><span class="se"></span>    --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span><span class="s1">&#39;S!B\*d$zDsb=&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>你必须使用单引号 <code>''</code> 转义字符串中的特殊字符，如 <code>$</code>、<code>\</code>、<code>*</code>、<code>=</code>和<code>!</code> 。否则，你的 shell 将会解析这些字符。</p>
<h4 id="使用源文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle4bdbfe794a8e6ba90e69687e4bbb6">使用源文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E4%BD%BF%E7%94%A8%E6%BA%90%E6%96%87%E4%BB%B6" target="_blank" rel="noopener noreffer"></a></h4>
<ol>
<li>
<p>将凭据保存到文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> -n <span class="s1">&#39;admin&#39;</span> &gt; ./username.txt
<span class="nb">echo</span> -n <span class="s1">&#39;S!B\*d$zDsb=&#39;</span> &gt; ./password.txt
</code></pre></td></tr></table>
</div>
</div><p><code>-n</code> 标志用来确保生成文件的文末没有多余的换行符。这很重要，因为当 <code>kubectl</code> 读取文件并将内容编码为 base64 字符串时，额外的换行符也会被编码。 你不需要对文件中包含的字符串中的特殊字符进行转义。</p>
</li>
<li>
<p>在 <code>kubectl</code> 命令中传递文件路径：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic db-user-pass <span class="se">\
</span><span class="se"></span>    --from-file<span class="o">=</span>./username.txt <span class="se">\
</span><span class="se"></span>    --from-file<span class="o">=</span>./password.txt
</code></pre></td></tr></table>
</div>
</div><p>默认键名为文件名。你也可以通过 <code>--from-file=[key=]source</code> 设置键名，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl create secret generic db-user-pass <span class="se">\
</span><span class="se"></span>    --from-file<span class="o">=</span><span class="nv">username</span><span class="o">=</span>./username.txt <span class="se">\
</span><span class="se"></span>    --from-file<span class="o">=</span><span class="nv">password</span><span class="o">=</span>./password.txt
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>无论使用哪种方法，输出都类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">secret/db-user-pass created
</code></pre></td></tr></table>
</div>
</div><h3 id="验证-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlverify-the-secret">验证 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret" target="_blank" rel="noopener noreffer"></a></h3>
<p>检查 Secret 是否已创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get secrets
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NAME              TYPE       DATA      AGE
db-user-pass      Opaque     2         51s
</code></pre></td></tr></table>
</div>
</div><p>查看 Secret 的细节：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl describe secret db-user-pass
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Name:            db-user-pass
Namespace:       default
Labels:          &lt;none&gt;
Annotations:     &lt;none&gt;

Type:            Opaque

Data
====
password:    12 bytes
username:    5 bytes
</code></pre></td></tr></table>
</div>
</div><p><code>kubectl get</code> 和 <code>kubectl describe</code> 命令默认不显示 <code>Secret</code> 的内容。 这是为了防止 <code>Secret</code> 被意外暴露或存储在终端日志中。</p>
<h4 id="解码-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectldecoding-secret">解码 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret" target="_blank" rel="noopener noreffer"></a></h4>
<ol>
<li>
<p>查看你所创建的 Secret 内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get secret db-user-pass -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;UyFCXCpkJHpEc2I9&#34;</span><span class="p">,</span> <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;YWRtaW4=&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>解码 <code>password</code> 数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> <span class="s1">&#39;UyFCXCpkJHpEc2I9&#39;</span> <span class="p">|</span> base64 --decode
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">S!B\*d$zDsb=
</code></pre></td></tr></table>
</div>
</div><p><strong>注意：</strong></p>
<p>这是一个出于文档编制目的的示例。实际上，该方法可能会导致包含编码数据的命令存储在 Shell 的历史记录中。任何可以访问你的计算机的人都可以找到该命令并对 Secret 进行解码。 更好的办法是将查看和解码命令一同使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get secret db-user-pass -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.password}&#39;</span> <span class="p">|</span> base64 --decode
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectledit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#edit-secret" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以编辑一个现存的 <code>Secret</code> 对象，除非它是<a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#secret-immutable" target="_blank" rel="noopener noreffer">不可改变的</a>。 要想编辑一个 Secret，请执行以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl edit secrets &lt;secret-name&gt;
</code></pre></td></tr></table>
</div>
</div><p>这将打开默认编辑器，并允许你更新 <code>data</code> 字段中的 base64 编码的 Secret 值，示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#请编辑下面的对象。以“#”开头的行将被忽略，</span><span class="w">
</span><span class="w"></span><span class="c">#空文件将中止编辑。如果在保存此文件时发生错误，</span><span class="w">
</span><span class="w"></span><span class="c">#则将重新打开该文件并显示相关的失败。</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">UyFCXCpkJHpEc2I9</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2022-06-28T17:44:13Z&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-user-pass</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;12708504&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">91becd59-78fa-4c85-823f-6d44436242ac</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectlclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#clean-up" target="_blank" rel="noopener noreffer"></a></h3>
<p>要想删除一个 Secret，请执行以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete secret db-user-pass
</code></pre></td></tr></table>
</div>
</div><h3 id="接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kubectle68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li>进一步阅读 <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreffer">Secret 概念</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/" target="_blank" rel="noopener noreffer">使用配置文件管理 Secret</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/" target="_blank" rel="noopener noreffer">使用 Kustomize 管理 Secret</a></li>
</ul>
<h2 id="使用配置文件管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-file"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/" target="_blank" rel="noopener noreffer">使用配置文件管理 Secret</a></h2>
<p>使用资源配置文件创建 Secret 对象。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filee58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<h3 id="创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filecreate-the-config-file">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#create-the-config-file" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以先用 JSON 或 YAML 格式在一个清单文件中定义 <code>Secret</code> 对象，然后创建该对象。 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.26/#secret-v1-core" target="_blank" rel="noopener noreffer">Secret</a> 资源包含 2 个键值对：<code>data</code> 和 <code>stringData</code>。 <code>data</code> 字段用来存储 base64 编码的任意数据。 提供 <code>stringData</code> 字段是为了方便，它允许 Secret 使用未编码的字符串。 <code>data</code> 和 <code>stringData</code> 的键必须由字母、数字、<code>-</code>、<code>_</code> 或 <code>.</code> 组成。</p>
<p>以下示例使用 <code>data</code> 字段在 Secret 中存储两个字符串：</p>
<ol>
<li>
<p>将这些字符串转换为 base64：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> -n <span class="s1">&#39;admin&#39;</span> <span class="p">|</span> base64
<span class="nb">echo</span> -n <span class="s1">&#39;1f2d1e2e67df&#39;</span> <span class="p">|</span> base64
</code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong></p>
<p>Secret 数据的 JSON 和 YAML 序列化结果是以 base64 编码的。 换行符在这些字符串中无效，必须省略。 在 Darwin/macOS 上使用 <code>base64</code> 工具时，用户不应该使用 <code>-b</code> 选项分割长行。 相反地，Linux 用户<strong>应该</strong>在 <code>base64</code> 地命令中添加 <code>-w 0</code> 选项， 或者在 <code>-w</code> 选项不可用的情况下，输入 <code>base64 | tr -d '\n'</code>。</p>
<p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">YWRtaW4=
MWYyZDFlMmU2N2Rm
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建清单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">MWYyZDFlMmU2N2Rm</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>注意，Secret 对象的名称必须是有效的 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/working-with-objects/names#dns-subdomain-names" target="_blank" rel="noopener noreffer">DNS 子域名</a>。</p>
</li>
<li>
<p>使用 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#apply" target="_blank" rel="noopener noreffer"><code>kubectl apply</code></a> 创建 Secret：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f ./secret.yaml
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">secret/mysecret created
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>若要验证 Secret 被创建以及想要解码 Secret 数据， 请参阅<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret" target="_blank" rel="noopener noreffer">使用 kubectl 管理 Secret</a></p>
<h4 id="创建-secret-时提供未编码的数据httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filespecify-unencoded-data-when-creating-a-secret">创建 Secret 时提供未编码的数据<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#specify-unencoded-data-when-creating-a-secret" target="_blank" rel="noopener noreffer"></a></h4>
<p>对于某些场景，你可能希望使用 <code>stringData</code> 字段。 这个字段可以将一个非 base64 编码的字符串直接放入 Secret 中， 当创建或更新该 Secret 时，此字段将被编码。</p>
<p>上述用例的实际场景可能是这样：当你部署应用时，使用 Secret 存储配置文件， 你希望在部署过程中，填入部分内容到该配置文件。</p>
<p>例如，如果你的应用程序使用以下配置文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiUrl</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://my.api.com/api/v1&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&lt;user&gt;&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&lt;password&gt;&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>你可以使用以下定义将其存储在 Secret 中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    apiUrl: &#34;https://my.api.com/api/v1&#34;
</span><span class="sd">    username: &lt;user&gt;
</span><span class="sd">    password: &lt;password&gt;    </span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>当你检索 Secret 数据时，此命令将返回编码的值，并不是你在 <code>stringData</code> 中提供的纯文本值。</p>
<p>例如，如果你运行以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl get secret mysecret -o yaml
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">config.yaml</span><span class="p">:</span><span class="w"> </span><span class="l">YXBpVXJsOiAiaHR0cHM6Ly9teS5hcGkuY29tL2FwaS92MSIKdXNlcm5hbWU6IHt7dXNlcm5hbWV9fQpwYXNzd29yZDoge3twYXNzd29yZH19</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="ld">2018-11-15T20:40:59Z</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7225&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">c280ad2e-e916-11e8-98f2-025000000001</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="同时指定-data-和-stringdatahttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filespecifying-both-data-and-stringdata">同时指定 <code>data</code> 和 <code>stringData</code><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#specifying-both-data-and-stringdata" target="_blank" rel="noopener noreffer"></a></h4>
<p>如果你在 <code>data</code> 和 <code>stringData</code> 中设置了同一个字段，则使用来自 <code>stringData</code> 中的值。</p>
<p>例如，如果你定义以下 Secret：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span><span class="w"></span><span class="nt">stringData</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">administrator</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>所创建的 <code>Secret</code> 对象如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW5pc3RyYXRvcg==</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="ld">2018-11-15T20:46:46Z</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;7579&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">uid</span><span class="p">:</span><span class="w"> </span><span class="l">91460ecb-e917-11e8-98f2-025000000001</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>YWRtaW5pc3RyYXRvcg==</code> 解码成 <code>administrator</code>。</p>
<h3 id="编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-fileedit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#edit-secret" target="_blank" rel="noopener noreffer"></a></h3>
<p>要编辑使用清单创建的 Secret 中的数据，请修改清单中的 <code>data</code> 或 <code>stringData</code> 字段并将此清单文件应用到集群。 你可以编辑现有的 <code>Secret</code> 对象，除非它是<a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#secret-immutable" target="_blank" rel="noopener noreffer">不可变的</a>。</p>
<p>例如，如果你想将上一个示例中的密码更改为 <code>birdsarentreal</code>，请执行以下操作：</p>
<ol>
<li>
<p>编码新密码字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> -n <span class="s1">&#39;birdsarentreal&#39;</span> <span class="p">|</span> base64
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">YmlyZHNhcmVudHJlYWw=
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用你的新密码字符串更新 <code>data</code> 字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">YmlyZHNhcmVudHJlYWw=</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>将清单应用到你的集群：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f ./secret.yaml
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">secret/mysecret configured
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>Kubernetes 更新现有的 <code>Secret</code> 对象。具体而言，<code>kubectl</code> 工具发现存在一个同名的现有 <code>Secret</code> 对象。 <code>kubectl</code> 获取现有对象，计划对其进行更改，并将更改后的 <code>Secret</code> 对象提交到你的集群控制平面。</p>
<p>如果你指定了 <code>kubectl apply --server-side</code>，则 <code>kubectl</code> 使用<a href="https://kubernetes.io/zh-cn/docs/reference/using-api/server-side-apply/" target="_blank" rel="noopener noreffer">服务器端应用（Server-Side Apply）</a>。</p>
<h3 id="清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-fileclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#clean-up" target="_blank" rel="noopener noreffer"></a></h3>
<p>删除你创建的 Secret：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete secret mysecret
</code></pre></td></tr></table>
</div>
</div><h3 id="接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-config-filee68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li>进一步阅读 <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreffer">Secret 概念</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/" target="_blank" rel="noopener noreffer">使用 <code>kubectl</code> 管理 Secret</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/" target="_blank" rel="noopener noreffer">使用 kustomize 管理 Secret</a></li>
</ul>
<h2 id="使用-kustomize-管理-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomize"><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/" target="_blank" rel="noopener noreffer">使用 Kustomize 管理 Secret</a></h2>
<p>使用 kustomization.yaml 文件创建 Secret 对象。
<code>kubectl</code> 支持使用 <a href="https://kubernetes.io/zh-cn/docs/tasks/manage-kubernetes-objects/kustomization/" target="_blank" rel="noopener noreffer">Kustomize 对象管理工具</a>来管理 Secret 和 ConfigMap。你可以使用 Kustomize 创建<strong>资源生成器（Resource Generator）</strong>， 该生成器会生成一个 Secret，让你能够通过 <code>kubectl</code> 应用到 API 服务器。</p>
<h3 id="准备开始httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizee58786e5a487e5bc80e5a78b">准备开始<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#%E5%87%86%E5%A4%87%E5%BC%80%E5%A7%8B" target="_blank" rel="noopener noreffer"></a></h3>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。 建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。 如果你还没有集群，你可以通过 <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/" target="_blank" rel="noopener noreffer">Minikube</a> 构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href="https://killercoda.com/playgrounds/scenario/kubernetes" target="_blank" rel="noopener noreffer">Killercoda</a></li>
<li><a href="http://labs.play-with-k8s.com/" target="_blank" rel="noopener noreffer">玩转 Kubernetes</a></li>
</ul>
<h3 id="创建-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizecreate-a-secret">创建 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#create-a-secret" target="_blank" rel="noopener noreffer"></a></h3>
<p>你可以在 <code>kustomization.yaml</code> 文件中定义 <code>secreteGenerator</code> 字段， 并在定义中引用其它本地文件、<code>.env</code> 文件或文字值生成 Secret。 例如：下面的指令为用户名 <code>admin</code> 和密码 <code>1f2d1e2e67df</code> 创建 Kustomization 文件。</p>
<h4 id="创建-kustomization-文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizecreate-the-kustomization-file">创建 Kustomization 文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#create-the-kustomization-file" target="_blank" rel="noopener noreffer"></a></h4>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#secret-data-0" target="_blank" rel="noopener noreffer">文字</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#secret-data-1" target="_blank" rel="noopener noreffer">文件</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#secret-data-2" target="_blank" rel="noopener noreffer">.env 文件</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">
</span><span class="w"></span><span class="nt">secretGenerator</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">database-creds</span><span class="w">
</span><span class="w">  </span><span class="nt">literals</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">username=admin</span><span class="w">
</span><span class="w">  </span>- <span class="l">password=1f2d1e2e67df</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol>
<li>
<p>用 base64 编码的值存储凭据到文件中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">echo</span> -n <span class="s1">&#39;admin&#39;</span> &gt; ./username.txt
<span class="nb">echo</span> -n <span class="s1">&#39;1f2d1e2e67df&#39;</span> &gt; ./password.txt
</code></pre></td></tr></table>
</div>
</div><p><code>-n</code> 标志确保文件结尾处没有换行符。</p>
</li>
<li>
<p>创建 <code>kustomization.yaml</code> 文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">secretGenerator</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">database-creds</span><span class="w">
</span><span class="w">  </span><span class="nt">files</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">username.txt</span><span class="w">
</span><span class="w">  </span>- <span class="l">password.txt</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>你也可以使用 <code>.env</code> 文件在 <code>kustomization.yaml</code> 中定义 <code>secretGenerator</code>。 例如下面的 <code>kustomization.yaml</code> 文件从 <code>.env.secret</code> 文件获取数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">secretGenerator</span><span class="p">:</span><span class="w">
</span><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db-user-pass</span><span class="w">
</span><span class="w">  </span><span class="nt">envs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">.env.secret</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>在所有情况下，你都不需要对取值作 base64 编码。 YAML 文件的名称<strong>必须</strong>是 <code>kustomization.yaml</code> 或 <code>kustomization.yml</code>。</p>
<h4 id="应用-kustomization-文件httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeapply-the-kustomization-file">应用 kustomization 文件<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#apply-the-kustomization-file" target="_blank" rel="noopener noreffer"></a></h4>
<p>若要创建 Secret，应用包含 kustomization 文件的目录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -k &lt;目录路径&gt;
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">secret/database-creds-5hdh7hhgfk created
</code></pre></td></tr></table>
</div>
</div><p>生成 Secret 时，Secret 的名称最终是由 <code>name</code> 字段和数据的哈希值拼接而成。 这将保证每次修改数据时生成一个新的 Secret。</p>
<p>要验证 Secret 是否已创建并解码 Secret 数据， 请参阅<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/#verify-the-secret" target="_blank" rel="noopener noreffer">使用 kubectl 管理 Secret</a>。</p>
<h3 id="编辑-secrethttpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeedit-secret">编辑 Secret<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#edit-secret" target="_blank" rel="noopener noreffer"></a></h3>
<ol>
<li>
<p>在 <code>kustomization.yaml</code> 文件中，修改诸如 <code>password</code> 等数据。</p>
</li>
<li>
<p>应用包含 kustomization 文件的目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -k &lt;目录路径&gt;
</code></pre></td></tr></table>
</div>
</div><p>输出类似于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">secret/db-user-pass-6f24b56cc8 created
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p>编辑过的 Secret 被创建为一个新的 <code>Secret</code> 对象，而不是更新现有的 <code>Secret</code> 对象。 你可能需要在 Pod 中更新对该 Secret 的引用。</p>
<h3 id="清理httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizeclean-up">清理<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#clean-up" target="_blank" rel="noopener noreffer"></a></h3>
<p>要删除 Secret，请使用 <code>kubectl</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">kubectl delete secret db-user-pass
</code></pre></td></tr></table>
</div>
</div><h3 id="接下来httpskubernetesiozh-cndocstasksconfigmap-secretmanaging-secret-using-kustomizee68ea5e4b88be69da5">接下来<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kustomize/#%E6%8E%A5%E4%B8%8B%E6%9D%A5" target="_blank" rel="noopener noreffer"></a></h3>
<ul>
<li>进一步阅读 <a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/" target="_blank" rel="noopener noreffer">Secret 概念</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-kubectl/" target="_blank" rel="noopener noreffer">使用 kubectl 管理 Secret</a></li>
<li>了解如何<a href="https://kubernetes.io/zh-cn/docs/tasks/configmap-secret/managing-secret-using-config-file/" target="_blank" rel="noopener noreffer">使用配置文件管理 Secret</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 0001-01-01 00:00:00</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" data-title=""><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Reddit" data-sharer="reddit" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/"><i class="fab fa-reddit fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" data-title=""><i class="fab fa-weibo fa-fw"></i></a><a href="javascript:void(0);" title="分享到 百度" data-sharer="baidu" data-url="https://jefofrank.xyz/%E7%AE%A1%E7%90%86kubernetes%E5%AF%B9%E8%B1%A1%E4%B8%8Esecrets/" data-title=""><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/" class="prev" rel="prev" title=""><i class="fas fa-angle-left fa-fw"></i></a>
            <a href="/%E7%9B%91%E6%8E%A7%E6%97%A5%E5%BF%97%E8%B0%83%E8%AF%95/" class="next" rel="next" title=""><i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.89.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/jf-011101" target="_blank">Jefo</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp"><a href="https://beian.miit.gov.cn/">赣ICP备2022007470号-1</a></span></br>
                <span id="busuanzi_container_site_pv">
                    访问量 <span id="busuanzi_value_site_pv"></span> 次
                </span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_uv">
                    访客数 <span id="busuanzi_value_site_uv"></span> 人次
                </span>
                </br><script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = 2021;
                        var startMonth = 3;
                        var startDate = 27;
                        var startHour = 19;
                        var startMinute = 15;
                        var startSecond = 11;
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                            minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                            diffMinutes * minutes) / seconds);
                        if (startYear == todayYear) {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffDays + " 天 " + diffHours +
                                " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        } else {
                            
                            document.getElementById("sitetime").innerHTML = "已安全运行 " + diffYears + " 年 " + diffDays +
                                " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                        }
                    }
                    setInterval(siteTime, 1000);
                </script>
                    <span id="sitetime">载入运行时间...</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.css"><script type="text/javascript" src="https://jefos-blog.disqus.com/embed.js" defer></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/copy-tex.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"data":{"id-1":"绿叶律动","id-2":"绿叶律动"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"algoliaAppID":"J0OW8CCKJZ","algoliaIndex":"JF-2","algoliaSearchKey":"3b4a19e831c95174aca4c03fcdf95f5c","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
